"use strict";(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require == "function" && require;if(!u && a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '" + o + "'");throw (f.code = "MODULE_NOT_FOUND",f);}var l=n[o] = {exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e);},l,l.exports,e,t,n,r);}return n[o].exports;}var i=typeof require == "function" && require;for(var o=0;o < r.length;o++) s(r[o]);return s;})({1:[function(require,module,exports){"use strict";var vjsOrbitControl2D=require("../../src/controls/OrbitControls2D");var vjsProbePixelWidget=require("../../src/widgets/widgets.pixelProbe");var vjsOrientationWidget=require("../../src/widgets/widgets.orientation");var vjsLoaderDicom=require("../../src/loaders/loaders.dicom");var VJS=VJS || {};var controls,renderer,stats,scene,camera,dat,probe,raycaster,mouse,orientation;function onProgressCallback(evt,filename){var percentComplete=Math.round(evt.loaded / evt.total * 100);window.console.log(filename);var fileContainer=document.getElementById(filename);if(!fileContainer){var progressContainer=document.getElementById("my-progress-container");var div=document.createElement("div");div.setAttribute("id",filename);div.innerHTML = "Downloading " + filename + ": " + percentComplete + "%";progressContainer.appendChild(div);}else {fileContainer.innerHTML = "Downloading " + filename + ": " + percentComplete + "%";}}function init(){function onDocumentMouseMove(event){mouse.x = event.clientX / threeD.offsetWidth * 2 - 1;mouse.y = -(event.clientY / threeD.offsetHeight) * 2 + 1;mouse.clientX = event.clientX;mouse.clientY = event.clientY;}function onDocumentMouseDown(event){event.preventDefault();raycaster.setFromCamera(mouse,camera);var domElement=probe.mark(raycaster,mouse);if(domElement){var threeD=document.getElementById("r3d");threeD.appendChild(domElement);}}function animate(){if(mouse && raycaster && probe){raycaster.setFromCamera(mouse,camera);probe.update(raycaster,mouse,camera,threeD);}orientation.update();controls.update();renderer.render(scene,camera);stats.update();requestAnimationFrame(function(){animate();});}var threeD=document.getElementById("r3d");renderer = new THREE.WebGLRenderer({antialias:true});renderer.setSize(threeD.offsetWidth,threeD.offsetHeight);renderer.setClearColor(0xFFFFFF,1);threeD.appendChild(renderer.domElement);stats = new Stats();threeD.appendChild(stats.domElement);scene = new THREE.Scene();camera = new THREE.PerspectiveCamera(45,threeD.offsetWidth / threeD.offsetHeight,1,10000000);camera.position.x = 150;camera.position.y = 150;camera.position.z = 100;camera.lookAt(scene.position);controls = new vjsOrbitControl2D(camera,renderer.domElement);orientation = new vjsOrientationWidget("r3d",camera,controls);raycaster = new THREE.Raycaster();mouse = new THREE.Vector2();renderer.domElement.addEventListener("mousemove",onDocumentMouseMove,false);renderer.domElement.addEventListener("mousedown",onDocumentMouseDown,false);animate();}window.onload = function(){init();window.console.log(dat);var geometry=new THREE.BoxGeometry(500,500,500);var material=new THREE.MeshBasicMaterial({wireframe:true,color:0x607D8B});var cube=new THREE.Mesh(geometry,material);scene.add(cube);var seriesHelper=[];var manager=new THREE.LoadingManager();manager.onProgress = function(item,loaded,total){window.console.log("manager progress ----");window.console.log(item);var fileContainer=document.getElementById(item);if(fileContainer){fileContainer.innerHTML = " " + item + " is ready! " + "(" + loaded + "/" + total + ")";}if(loaded === total){window.console.log(seriesHelper);var mergedHelpers=[seriesHelper[0]];for(var i=0;i < seriesHelper.length;i++) {for(var j=0;j < mergedHelpers.length;j++) {if(mergedHelpers[j].merge(seriesHelper[i])){break;}else if(j === mergedHelpers.length - 1){mergedHelpers.push(seriesHelper[i]);}}}mergedHelpers[0].prepare();scene.add(mergedHelpers[0]);probe = new vjsProbePixelWidget(mergedHelpers[0]._series,mergedHelpers[0].children);scene.add(probe);var threeD=document.getElementById("r3d");threeD.appendChild(probe.domElement);}};var filenames=["36749810","36749824","36749838","36749852","36749866","36749880","36749894","36749908","36749922","36749936","36749950","36749964"];var files=filenames.map(function(v){return "../../data/dcm/adi/" + v;});window.console.log(files);function loadClosure(filename){var loader=new vjsLoaderDicom(manager);loader.load(filename,function(imageHelper){seriesHelper.push(imageHelper);},function(){window.console.log(filename);onProgressCallback(event,filename);},function(message){window.console.log("error: ",message);});}for(var k=0;k < files.length;k++) {loadClosure(files[k]);}};},{"../../src/controls/OrbitControls2D":3,"../../src/loaders/loaders.dicom":7,"../../src/widgets/widgets.orientation":14,"../../src/widgets/widgets.pixelProbe":15}],2:[function(require,module,exports){(function(root,factory){if(typeof module !== "undefined" && module.exports){module.exports = factory();}else if(typeof define === "function" && define.amd){define([],factory);}else {if(typeof cornerstone === "undefined"){dicomParser = {};if(typeof Package !== "undefined"){root.dicomParser = dicomParser;}}dicomParser = factory();}})(this,function(){var dicomParser=(function(dicomParser){if(dicomParser === undefined){dicomParser = {};}dicomParser.parseDicom = function(byteArray,options){if(byteArray === undefined){throw "dicomParser.parseDicom: missing required parameter 'byteArray'";}var littleEndianByteStream=new dicomParser.ByteStream(dicomParser.littleEndianByteArrayParser,byteArray);function readPrefix(){littleEndianByteStream.seek(128);var prefix=littleEndianByteStream.readFixedString(4);if(prefix !== "DICM"){throw "dicomParser.parseDicom: DICM prefix not found at location 132";}}function readPart10Header(){readPrefix();var warnings=[];var elements={};while(littleEndianByteStream.position < littleEndianByteStream.byteArray.length) {var position=littleEndianByteStream.position;var element=dicomParser.readDicomElementExplicit(littleEndianByteStream,warnings);if(element.tag > "x0002ffff"){littleEndianByteStream.position = position;break;}element.parser = dicomParser.littleEndianByteArrayParser;elements[element.tag] = element;}var metaHeaderDataSet=new dicomParser.DataSet(littleEndianByteStream.byteArrayParser,littleEndianByteStream.byteArray,elements);metaHeaderDataSet.warnings = littleEndianByteStream.warnings;return metaHeaderDataSet;}function readTransferSyntax(metaHeaderDataSet){if(metaHeaderDataSet.elements.x00020010 === undefined){throw "dicomParser.parseDicom: missing required meta header attribute 0002,0010";}var transferSyntaxElement=metaHeaderDataSet.elements.x00020010;return dicomParser.readFixedString(littleEndianByteStream.byteArray,transferSyntaxElement.dataOffset,transferSyntaxElement.length);}function isExplicit(transferSyntax){if(transferSyntax === "1.2.840.10008.1.2"){return false;}return true;}function getDataSetByteStream(transferSyntax){if(transferSyntax === "1.2.840.10008.1.2.2"){return new dicomParser.ByteStream(dicomParser.bigEndianByteArrayParser,byteArray,littleEndianByteStream.position);}else {return new dicomParser.ByteStream(dicomParser.littleEndianByteArrayParser,byteArray,littleEndianByteStream.position);}}function mergeDataSets(metaHeaderDataSet,instanceDataSet){for(var propertyName in metaHeaderDataSet.elements) {if(metaHeaderDataSet.elements.hasOwnProperty(propertyName)){instanceDataSet.elements[propertyName] = metaHeaderDataSet.elements[propertyName];}}if(metaHeaderDataSet.warnings !== undefined){instanceDataSet.warnings = metaHeaderDataSet.warnings.concat(instanceDataSet.warnings);}return instanceDataSet;}function readDataSet(metaHeaderDataSet){var transferSyntax=readTransferSyntax(metaHeaderDataSet);var explicit=isExplicit(transferSyntax);var dataSetByteStream=getDataSetByteStream(transferSyntax);var elements={};var dataSet=new dicomParser.DataSet(dataSetByteStream.byteArrayParser,dataSetByteStream.byteArray,elements);dataSet.warnings = dataSetByteStream.warnings;try{if(explicit){dicomParser.parseDicomDataSetExplicit(dataSet,dataSetByteStream,dataSetByteStream.byteArray.length,options);}else {dicomParser.parseDicomDataSetImplicit(dataSet,dataSetByteStream,dataSetByteStream.byteArray.length,options);}}catch(e) {var ex={exception:e,dataSet:dataSet};throw ex;}return dataSet;}function parseTheByteStream(){var metaHeaderDataSet=readPart10Header();var dataSet=readDataSet(metaHeaderDataSet);return mergeDataSets(metaHeaderDataSet,dataSet);}return parseTheByteStream();};return dicomParser;})(dicomParser);var dicomParser=(function(dicomParser){"use strict";if(dicomParser === undefined){dicomParser = {};}dicomParser.explicitDataSetToJS = function(dataSet,options){if(dataSet === undefined){throw "dicomParser.explicitDataSetToJS: missing required parameter dataSet";}options = options || {omitPrivateAttibutes:true,maxElementLength:128};var result={};for(var tag in dataSet.elements) {var element=dataSet.elements[tag];if(options.omitPrivateAttibutes === true && dicomParser.isPrivateTag(tag)){continue;}if(element.items){var sequenceItems=[];for(var i=0;i < element.items.length;i++) {sequenceItems.push(dicomParser.explicitDataSetToJS(element.items[i].dataSet,options));}result[tag] = sequenceItems;}else {var asString;asString = undefined;if(element.length < options.maxElementLength){asString = dicomParser.explicitElementToString(dataSet,element);}if(asString !== undefined){result[tag] = asString;}else {result[tag] = {dataOffset:element.dataOffset,length:element.length};}}}return result;};return dicomParser;})(dicomParser);var dicomParser=(function(dicomParser){"use strict";if(dicomParser === undefined){dicomParser = {};}dicomParser.explicitElementToString = function(dataSet,element){if(dataSet === undefined || element === undefined){throw "dicomParser.explicitElementToString: missing required parameters";}if(element.vr === undefined){throw "dicomParser.explicitElementToString: cannot convert implicit element to string";}var vr=element.vr;var tag=element.tag;var textResult;function multiElementToString(numItems,func){var result="";for(var i=0;i < numItems;i++) {if(i !== 0){result += "/";}result += func.call(dataSet,tag).toString();}return result;}if(dicomParser.isStringVr(vr) === true){textResult = dataSet.string(tag);}else if(vr == "AT"){var num=dataSet.uint32(tag);if(num === undefined){return undefined;}if(num < 0){num = 0xFFFFFFFF + num + 1;}return "x" + num.toString(16).toUpperCase();}else if(vr == "US"){textResult = multiElementToString(element.length / 2,dataSet.uint16);}else if(vr === "SS"){textResult = multiElementToString(element.length / 2,dataSet.int16);}else if(vr == "UL"){textResult = multiElementToString(element.length / 4,dataSet.uint32);}else if(vr === "SL"){textResult = multiElementToString(element.length / 4,dataSet.int32);}else if(vr == "FD"){textResult = multiElementToString(element.length / 8,dataSet.int32);}else if(vr == "FL"){textResult = multiElementToString(element.length / 4,dataSet.float);}return textResult;};return dicomParser;})(dicomParser);var dicomParser=(function(dicomParser){"use strict";if(dicomParser === undefined){dicomParser = {};}var stringVrs={AE:true,AS:true,AT:false,CS:true,DA:true,DS:true,DT:true,FL:false,FD:false,IS:true,LO:true,LT:true,OB:false,OD:false,OF:false,OW:false,PN:true,SH:true,SL:false,SQ:false,SS:false,ST:true,TM:true,UI:true,UL:false,UN:undefined,UR:true,US:false,UT:true};dicomParser.isStringVr = function(vr){return stringVrs[vr];};dicomParser.isPrivateTag = function(tag){var lastGroupDigit=parseInt(tag[4]);var groupIsOdd=lastGroupDigit % 2 === 1;return groupIsOdd;};dicomParser.parsePN = function(personName){if(personName === undefined){return undefined;}var stringValues=personName.split("^");return {familyName:stringValues[0],givenName:stringValues[1],middleName:stringValues[2],prefix:stringValues[3],suffix:stringValues[4]};};dicomParser.parseDA = function(date){if(date && date.length === 8){var yyyy=parseInt(date.substring(0,4),10);var mm=parseInt(date.substring(4,6),10);var dd=parseInt(date.substring(6,8),10);return {year:yyyy,month:mm,day:dd};}return undefined;};dicomParser.parseTM = function(time){if(time.length >= 2){var hh=parseInt(time.substring(0,2),10);var mm=time.length >= 4?parseInt(time.substring(2,4),10):undefined;var ss=time.length >= 6?parseInt(time.substring(4,6),10):undefined;var ffffff=time.length >= 8?parseInt(time.substring(7,13),10):undefined;return {hours:hh,minutes:mm,seconds:ss,fractionalSeconds:ffffff};}return undefined;};return dicomParser;})(dicomParser);var dicomParser=(function(dicomParser){"use strict";if(dicomParser === undefined){dicomParser = {};}function getPixelDataFromFragments(byteStream,fragments,bufferSize){if(fragments.length === 1){return new Uint8Array(byteStream.byteArray.buffer,fragments[0].dataOffset,fragments[0].length);}var pixelData=new Uint8Array(bufferSize);var pixelDataIndex=0;for(var i=0;i < fragments.length;i++) {var fragmentOffset=fragments[i].dataOffset;for(var j=0;j < fragments[i].length;j++) {pixelData[pixelDataIndex++] = byteStream.byteArray[fragmentOffset++];}}return pixelData;}function readFragmentsUntil(byteStream,endOfFrame){var fragments=[];var bufferSize=0;while(byteStream.position < endOfFrame && byteStream.position < byteStream.byteArray.length) {var fragment=dicomParser.readSequenceItem(byteStream);if(fragment.tag === "xfffee0dd"){break;}fragments.push(fragment);byteStream.seek(fragment.length);bufferSize += fragment.length;}var pixelData=getPixelDataFromFragments(byteStream,fragments,bufferSize);return pixelData;}function readEncapsulatedPixelDataWithBasicOffsetTable(pixelDataElement,byteStream,frame){var numFrames=pixelDataElement.basicOffsetTable.length;if(frame > numFrames){throw "dicomParser.readEncapsulatedPixelData: parameter frame exceeds number of frames in basic offset table";}var frameOffset=pixelDataElement.basicOffsetTable[frame];byteStream.seek(frameOffset);var endOfFrameOffset=pixelDataElement.basicOffsetTable[frame + 1];if(endOfFrameOffset === undefined){endOfFrameOffset = byteStream.position + pixelDataElement.length;}var pixelData=readFragmentsUntil(byteStream,endOfFrameOffset);return pixelData;}function readEncapsulatedDataNoBasicOffsetTable(pixelDataElement,byteStream,frame){if(frame !== 0){throw "dicomParser.readEncapsulatedPixelData: non zero frame specified for single frame encapsulated pixel data";}var endOfFrame=byteStream.position + pixelDataElement.length;var pixelData=readFragmentsUntil(byteStream,endOfFrame);return pixelData;}dicomParser.readEncapsulatedPixelData = function(dataSet,pixelDataElement,frame){if(dataSet === undefined){throw "dicomParser.readEncapsulatedPixelData: missing required parameter 'dataSet'";}if(pixelDataElement === undefined){throw "dicomParser.readEncapsulatedPixelData: missing required parameter 'element'";}if(frame === undefined){throw "dicomParser.readEncapsulatedPixelData: missing required parameter 'frame'";}if(pixelDataElement.tag !== "x7fe00010"){throw "dicomParser.readEncapsulatedPixelData: parameter 'element' refers to non pixel data tag (expected tag = x7fe00010'";}if(pixelDataElement.encapsulatedPixelData !== true){throw "dicomParser.readEncapsulatedPixelData: parameter 'element' refers to pixel data element that does not have encapsulated pixel data";}if(pixelDataElement.hadUndefinedLength !== true){throw "dicomParser.readEncapsulatedPixelData: parameter 'element' refers to pixel data element that does not have encapsulated pixel data";}if(pixelDataElement.basicOffsetTable === undefined){throw "dicomParser.readEncapsulatedPixelData: parameter 'element' refers to pixel data element that does not have encapsulated pixel data";}if(pixelDataElement.fragments === undefined){throw "dicomParser.readEncapsulatedPixelData: parameter 'element' refers to pixel data element that does not have encapsulated pixel data";}if(frame < 0){throw "dicomParser.readEncapsulatedPixelData: parameter 'frame' must be >= 0";}var byteStream=new dicomParser.ByteStream(dataSet.byteArrayParser,dataSet.byteArray,pixelDataElement.dataOffset);var basicOffsetTable=dicomParser.readSequenceItem(byteStream);if(basicOffsetTable.tag !== "xfffee000"){throw "dicomParser.readEncapsulatedPixelData: missing basic offset table xfffee000";}byteStream.seek(basicOffsetTable.length);if(pixelDataElement.basicOffsetTable.length !== 0){return readEncapsulatedPixelDataWithBasicOffsetTable(pixelDataElement,byteStream,frame);}else {return readEncapsulatedDataNoBasicOffsetTable(pixelDataElement,byteStream,frame);}};return dicomParser;})(dicomParser);var dicomParser=(function(dicomParser){"use strict";if(dicomParser === undefined){dicomParser = {};}dicomParser.bigEndianByteArrayParser = {readUint16:function readUint16(byteArray,position){if(position < 0){throw "bigEndianByteArrayParser.readUint16: position cannot be less than 0";}if(position + 2 > byteArray.length){throw "bigEndianByteArrayParser.readUint16: attempt to read past end of buffer";}return (byteArray[position] << 8) + byteArray[position + 1];},readInt16:function readInt16(byteArray,position){if(position < 0){throw "bigEndianByteArrayParser.readInt16: position cannot be less than 0";}if(position + 2 > byteArray.length){throw "bigEndianByteArrayParser.readInt16: attempt to read past end of buffer";}var int16=(byteArray[position] << 8) + byteArray[position + 1];if(int16 & 0x8000){int16 = int16 - 0xFFFF - 1;}return int16;},readUint32:function readUint32(byteArray,position){if(position < 0){throw "bigEndianByteArrayParser.readUint32: position cannot be less than 0";}if(position + 4 > byteArray.length){throw "bigEndianByteArrayParser.readUint32: attempt to read past end of buffer";}var uint32=256 * (256 * (256 * byteArray[position] + byteArray[position + 1]) + byteArray[position + 2]) + byteArray[position + 3];return uint32;},readInt32:function readInt32(byteArray,position){if(position < 0){throw "bigEndianByteArrayParser.readInt32: position cannot be less than 0";}if(position + 4 > byteArray.length){throw "bigEndianByteArrayParser.readInt32: attempt to read past end of buffer";}var int32=(byteArray[position] << 24) + (byteArray[position + 1] << 16) + (byteArray[position + 2] << 8) + byteArray[position + 3];return int32;},readFloat:function readFloat(byteArray,position){if(position < 0){throw "bigEndianByteArrayParser.readFloat: position cannot be less than 0";}if(position + 4 > byteArray.length){throw "bigEndianByteArrayParser.readFloat: attempt to read past end of buffer";}var byteArrayForParsingFloat=new Uint8Array(4);byteArrayForParsingFloat[3] = byteArray[position];byteArrayForParsingFloat[2] = byteArray[position + 1];byteArrayForParsingFloat[1] = byteArray[position + 2];byteArrayForParsingFloat[0] = byteArray[position + 3];var floatArray=new Float32Array(byteArrayForParsingFloat.buffer);return floatArray[0];},readDouble:function readDouble(byteArray,position){if(position < 0){throw "bigEndianByteArrayParser.readDouble: position cannot be less than 0";}if(position + 8 > byteArray.length){throw "bigEndianByteArrayParser.readDouble: attempt to read past end of buffer";}var byteArrayForParsingFloat=new Uint8Array(8);byteArrayForParsingFloat[7] = byteArray[position];byteArrayForParsingFloat[6] = byteArray[position + 1];byteArrayForParsingFloat[5] = byteArray[position + 2];byteArrayForParsingFloat[4] = byteArray[position + 3];byteArrayForParsingFloat[3] = byteArray[position + 4];byteArrayForParsingFloat[2] = byteArray[position + 5];byteArrayForParsingFloat[1] = byteArray[position + 6];byteArrayForParsingFloat[0] = byteArray[position + 7];var floatArray=new Float64Array(byteArrayForParsingFloat.buffer);return floatArray[0];}};return dicomParser;})(dicomParser);var dicomParser=(function(dicomParser){"use strict";if(dicomParser === undefined){dicomParser = {};}dicomParser.readFixedString = function(byteArray,position,length){if(length < 0){throw "readFixedString - length cannot be less than 0";}if(position + length > byteArray.length){throw "dicomParser.readFixedString: attempt to read past end of buffer";}var result="";for(var i=0;i < length;i++) {var byte=byteArray[position + i];if(byte === 0){position += length;return result;}result += String.fromCharCode(byte);}return result;};return dicomParser;})(dicomParser);var dicomParser=(function(dicomParser){"use strict";if(dicomParser === undefined){dicomParser = {};}dicomParser.ByteStream = function(byteArrayParser,byteArray,position){if(byteArrayParser === undefined){throw "dicomParser.ByteStream: missing required parameter 'byteArrayParser'";}if(byteArray === undefined){throw "dicomParser.ByteStream: missing required parameter 'byteArray'";}if(byteArray instanceof Uint8Array === false){throw "dicomParser.ByteStream: parameter byteArray is not of type Uint8Array";}if(position < 0){throw "dicomParser.ByteStream: parameter 'position' cannot be less than 0";}if(position >= byteArray.length){throw "dicomParser.ByteStream: parameter 'position' cannot be greater than or equal to 'byteArray' length";}this.byteArrayParser = byteArrayParser;this.byteArray = byteArray;this.position = position?position:0;this.warnings = [];};dicomParser.ByteStream.prototype.seek = function(offset){if(this.position + offset < 0){throw "cannot seek to position < 0";}this.position += offset;};dicomParser.ByteStream.prototype.readByteStream = function(numBytes){if(this.position + numBytes > this.byteArray.length){throw "readByteStream - buffer overread";}var byteArrayView=new Uint8Array(this.byteArray.buffer,this.position,numBytes);this.position += numBytes;return new dicomParser.ByteStream(this.byteArrayParser,byteArrayView);};dicomParser.ByteStream.prototype.readUint16 = function(){var result=this.byteArrayParser.readUint16(this.byteArray,this.position);this.position += 2;return result;};dicomParser.ByteStream.prototype.readUint32 = function(){var result=this.byteArrayParser.readUint32(this.byteArray,this.position);this.position += 4;return result;};dicomParser.ByteStream.prototype.readFixedString = function(length){var result=dicomParser.readFixedString(this.byteArray,this.position,length);this.position += length;return result;};return dicomParser;})(dicomParser);var dicomParser=(function(dicomParser){"use strict";if(dicomParser === undefined){dicomParser = {};}function getByteArrayParser(element,defaultParser){return element.parser !== undefined?element.parser:defaultParser;}dicomParser.DataSet = function(byteArrayParser,byteArray,elements){this.byteArrayParser = byteArrayParser;this.byteArray = byteArray;this.elements = elements;};dicomParser.DataSet.prototype.uint16 = function(tag,index){var element=this.elements[tag];index = index !== undefined?index:0;if(element && element.length !== 0){return getByteArrayParser(element,this.byteArrayParser).readUint16(this.byteArray,element.dataOffset + index * 2);}return undefined;};dicomParser.DataSet.prototype.int16 = function(tag,index){var element=this.elements[tag];index = index !== undefined?index:0;if(element && element.length !== 0){return getByteArrayParser(element,this.byteArrayParser).readInt16(this.byteArray,element.dataOffset + index * 2);}return undefined;};dicomParser.DataSet.prototype.uint32 = function(tag,index){var element=this.elements[tag];index = index !== undefined?index:0;if(element && element.length !== 0){return getByteArrayParser(element,this.byteArrayParser).readUint32(this.byteArray,element.dataOffset + index * 4);}return undefined;};dicomParser.DataSet.prototype.int32 = function(tag,index){var element=this.elements[tag];index = index !== undefined?index:0;if(element && element.length !== 0){return getByteArrayParser(element,this.byteArrayParser).readInt32(this.byteArray,element.dataOffset + index * 4);}return undefined;};dicomParser.DataSet.prototype.float = function(tag,index){var element=this.elements[tag];index = index !== undefined?index:0;if(element && element.length !== 0){return getByteArrayParser(element,this.byteArrayParser).readFloat(this.byteArray,element.dataOffset + index * 4);}return undefined;};dicomParser.DataSet.prototype.double = function(tag,index){var element=this.elements[tag];index = index !== undefined?index:0;if(element && element.length !== 0){return getByteArrayParser(element,this.byteArrayParser).readDouble(this.byteArray,element.dataOffset + index * 8);}return undefined;};dicomParser.DataSet.prototype.numStringValues = function(tag){var element=this.elements[tag];if(element && element.length > 0){var fixedString=dicomParser.readFixedString(this.byteArray,element.dataOffset,element.length);var numMatching=fixedString.match(/\\/g);if(numMatching === null){return 1;}return numMatching.length + 1;}return undefined;};dicomParser.DataSet.prototype.string = function(tag,index){var element=this.elements[tag];if(element && element.length > 0){var fixedString=dicomParser.readFixedString(this.byteArray,element.dataOffset,element.length);if(index >= 0){var values=fixedString.split("\\");return values[index].trim();}else {return fixedString.trim();}}return undefined;};dicomParser.DataSet.prototype.text = function(tag,index){var element=this.elements[tag];if(element && element.length > 0){var fixedString=dicomParser.readFixedString(this.byteArray,element.dataOffset,element.length);if(index >= 0){var values=fixedString.split("\\");return values[index].replace(/ +$/,"");}else {return fixedString.replace(/ +$/,"");}}return undefined;};dicomParser.DataSet.prototype.floatString = function(tag,index){var element=this.elements[tag];if(element && element.length > 0){index = index !== undefined?index:0;var value=this.string(tag,index);if(value !== undefined){return parseFloat(value);}}return undefined;};dicomParser.DataSet.prototype.intString = function(tag,index){var element=this.elements[tag];if(element && element.length > 0){index = index !== undefined?index:0;var value=this.string(tag,index);if(value !== undefined){return parseInt(value);}}return undefined;};return dicomParser;})(dicomParser);var dicomParser=(function(dicomParser){"use strict";if(dicomParser === undefined){dicomParser = {};}dicomParser.findEndOfEncapsulatedElement = function(byteStream,element,warnings){if(byteStream === undefined){throw "dicomParser.findEndOfEncapsulatedElement: missing required parameter 'byteStream'";}if(element === undefined){throw "dicomParser.findEndOfEncapsulatedElement: missing required parameter 'element'";}element.encapsulatedPixelData = true;element.basicOffsetTable = [];element.fragments = [];var basicOffsetTableItemTag=dicomParser.readTag(byteStream);if(basicOffsetTableItemTag !== "xfffee000"){throw "dicomParser.findEndOfEncapsulatedElement: basic offset table not found";}var basicOffsetTableItemlength=byteStream.readUint32();var numFragments=basicOffsetTableItemlength / 4;for(var i=0;i < numFragments;i++) {var offset=byteStream.readUint32();element.basicOffsetTable.push(offset);}var baseOffset=byteStream.position;while(byteStream.position < byteStream.byteArray.length) {var tag=dicomParser.readTag(byteStream);var length=byteStream.readUint32();if(tag === "xfffee0dd"){byteStream.seek(length);element.length = byteStream.position - element.dataOffset;return;}else if(tag === "xfffee000"){element.fragments.push({offset:byteStream.position - baseOffset - 8,position:byteStream.position,length:length});}else {if(warnings){warnings.push("unexpected tag " + tag + " while searching for end of pixel data element with undefined length");}if(length > byteStream.byteArray.length - byteStream.position){length = byteStream.byteArray.length - byteStream.position;}element.fragments.push({offset:byteStream.position - baseOffset - 8,position:byteStream.position,length:length});byteStream.seek(length);element.length = byteStream.position - element.dataOffset;return;}byteStream.seek(length);}if(warnings){warnings.push("pixel data element " + element.tag + " missing sequence delimiter tag xfffee0dd");}};return dicomParser;})(dicomParser);var dicomParser=(function(dicomParser){"use strict";if(dicomParser === undefined){dicomParser = {};}dicomParser.findItemDelimitationItemAndSetElementLength = function(byteStream,element){if(byteStream === undefined){throw "dicomParser.readDicomElementImplicit: missing required parameter 'byteStream'";}var itemDelimitationItemLength=8;var maxPosition=byteStream.byteArray.length - itemDelimitationItemLength;while(byteStream.position <= maxPosition) {var groupNumber=byteStream.readUint16();if(groupNumber === 0xfffe){var elementNumber=byteStream.readUint16();if(elementNumber === 0xe00d){var itemDelimiterLength=byteStream.readUint32();if(itemDelimiterLength !== 0){byteStream.warnings("encountered non zero length following item delimiter at position" + byteStream.position - 4 + " while reading element of undefined length with tag ' + element.tag");}element.length = byteStream.position - element.dataOffset;return;}}}element.length = byteStream.byteArray.length - element.dataOffset;byteStream.seek(byteStream.byteArray.length - byteStream.position);};return dicomParser;})(dicomParser);var dicomParser=(function(dicomParser){"use strict";if(dicomParser === undefined){dicomParser = {};}dicomParser.littleEndianByteArrayParser = {readUint16:function readUint16(byteArray,position){if(position < 0){throw "littleEndianByteArrayParser.readUint16: position cannot be less than 0";}if(position + 2 > byteArray.length){throw "littleEndianByteArrayParser.readUint16: attempt to read past end of buffer";}return byteArray[position] + byteArray[position + 1] * 256;},readInt16:function readInt16(byteArray,position){if(position < 0){throw "littleEndianByteArrayParser.readInt16: position cannot be less than 0";}if(position + 2 > byteArray.length){throw "littleEndianByteArrayParser.readInt16: attempt to read past end of buffer";}var int16=byteArray[position] + (byteArray[position + 1] << 8);if(int16 & 0x8000){int16 = int16 - 0xFFFF - 1;}return int16;},readUint32:function readUint32(byteArray,position){if(position < 0){throw "littleEndianByteArrayParser.readUint32: position cannot be less than 0";}if(position + 4 > byteArray.length){throw "littleEndianByteArrayParser.readUint32: attempt to read past end of buffer";}var uint32=byteArray[position] + byteArray[position + 1] * 256 + byteArray[position + 2] * 256 * 256 + byteArray[position + 3] * 256 * 256 * 256;return uint32;},readInt32:function readInt32(byteArray,position){if(position < 0){throw "littleEndianByteArrayParser.readInt32: position cannot be less than 0";}if(position + 4 > byteArray.length){throw "littleEndianByteArrayParser.readInt32: attempt to read past end of buffer";}var int32=byteArray[position] + (byteArray[position + 1] << 8) + (byteArray[position + 2] << 16) + (byteArray[position + 3] << 24);return int32;},readFloat:function readFloat(byteArray,position){if(position < 0){throw "littleEndianByteArrayParser.readFloat: position cannot be less than 0";}if(position + 4 > byteArray.length){throw "littleEndianByteArrayParser.readFloat: attempt to read past end of buffer";}var byteArrayForParsingFloat=new Uint8Array(4);byteArrayForParsingFloat[0] = byteArray[position];byteArrayForParsingFloat[1] = byteArray[position + 1];byteArrayForParsingFloat[2] = byteArray[position + 2];byteArrayForParsingFloat[3] = byteArray[position + 3];var floatArray=new Float32Array(byteArrayForParsingFloat.buffer);return floatArray[0];},readDouble:function readDouble(byteArray,position){if(position < 0){throw "littleEndianByteArrayParser.readDouble: position cannot be less than 0";}if(position + 8 > byteArray.length){throw "littleEndianByteArrayParser.readDouble: attempt to read past end of buffer";}var byteArrayForParsingFloat=new Uint8Array(8);byteArrayForParsingFloat[0] = byteArray[position];byteArrayForParsingFloat[1] = byteArray[position + 1];byteArrayForParsingFloat[2] = byteArray[position + 2];byteArrayForParsingFloat[3] = byteArray[position + 3];byteArrayForParsingFloat[4] = byteArray[position + 4];byteArrayForParsingFloat[5] = byteArray[position + 5];byteArrayForParsingFloat[6] = byteArray[position + 6];byteArrayForParsingFloat[7] = byteArray[position + 7];var floatArray=new Float64Array(byteArrayForParsingFloat.buffer);return floatArray[0];}};return dicomParser;})(dicomParser);var dicomParser=(function(dicomParser){"use strict";if(dicomParser === undefined){dicomParser = {};}dicomParser.parseDicomDataSetExplicit = function(dataSet,byteStream,maxPosition,options){maxPosition = maxPosition === undefined?byteStream.byteArray.length:maxPosition;options = options || {};if(byteStream === undefined){throw "dicomParser.parseDicomDataSetExplicit: missing required parameter 'byteStream'";}if(maxPosition < byteStream.position || maxPosition > byteStream.byteArray.length){throw "dicomParser.parseDicomDataSetExplicit: invalid value for parameter 'maxPosition'";}var elements=dataSet.elements;while(byteStream.position < maxPosition) {var element=dicomParser.readDicomElementExplicit(byteStream,dataSet.warnings,options.untilTag);elements[element.tag] = element;if(element.tag === options.untilTag){return;}}if(byteStream.position > maxPosition){throw "dicomParser:parseDicomDataSetExplicit: buffer overrun";}};dicomParser.parseDicomDataSetImplicit = function(dataSet,byteStream,maxPosition,options){maxPosition = maxPosition === undefined?dataSet.byteArray.length:maxPosition;options = options || {};if(byteStream === undefined){throw "dicomParser.parseDicomDataSetImplicit: missing required parameter 'byteStream'";}if(maxPosition < byteStream.position || maxPosition > byteStream.byteArray.length){throw "dicomParser.parseDicomDataSetImplicit: invalid value for parameter 'maxPosition'";}var elements=dataSet.elements;while(byteStream.position < maxPosition) {var element=dicomParser.readDicomElementImplicit(byteStream,options.untilTag);elements[element.tag] = element;if(element.tag === options.untilTag){return;}}};return dicomParser;})(dicomParser);var dicomParser=(function(dicomParser){"use strict";if(dicomParser === undefined){dicomParser = {};}function getDataLengthSizeInBytesForVR(vr){if(vr === "OB" || vr === "OW" || vr === "SQ" || vr === "OF" || vr === "UT" || vr === "UN"){return 4;}else {return 2;}}dicomParser.readDicomElementExplicit = function(byteStream,warnings,untilTag){if(byteStream === undefined){throw "dicomParser.readDicomElementExplicit: missing required parameter 'byteStream'";}var element={tag:dicomParser.readTag(byteStream),vr:byteStream.readFixedString(2)};var dataLengthSizeBytes=getDataLengthSizeInBytesForVR(element.vr);if(dataLengthSizeBytes === 2){element.length = byteStream.readUint16();element.dataOffset = byteStream.position;}else {byteStream.seek(2);element.length = byteStream.readUint32();element.dataOffset = byteStream.position;}if(element.length === 4294967295){element.hadUndefinedLength = true;}if(element.tag === untilTag){return element;}if(element.vr === "SQ"){dicomParser.readSequenceItemsExplicit(byteStream,element,warnings);return element;}if(element.length === 4294967295){if(element.tag === "x7fe00010"){dicomParser.findEndOfEncapsulatedElement(byteStream,element,warnings);return element;}else {dicomParser.findItemDelimitationItemAndSetElementLength(byteStream,element);return element;}}byteStream.seek(element.length);return element;};return dicomParser;})(dicomParser);var dicomParser=(function(dicomParser){"use strict";if(dicomParser === undefined){dicomParser = {};}dicomParser.readDicomElementImplicit = function(byteStream,untilTag){if(byteStream === undefined){throw "dicomParser.readDicomElementImplicit: missing required parameter 'byteStream'";}var element={tag:dicomParser.readTag(byteStream),length:byteStream.readUint32(),dataOffset:byteStream.position};if(element.length === 4294967295){element.hadUndefinedLength = true;}if(element.tag === untilTag){return element;}if(byteStream.position + 4 <= byteStream.byteArray.length){var nextTag=dicomParser.readTag(byteStream);byteStream.seek(-4);if(nextTag === "xfffee000"){dicomParser.readSequenceItemsImplicit(byteStream,element);return element;}}if(element.length === 4294967295){dicomParser.findItemDelimitationItemAndSetElementLength(byteStream,element);return element;}byteStream.seek(element.length);return element;};return dicomParser;})(dicomParser);var dicomParser=(function(dicomParser){"use strict";if(dicomParser === undefined){dicomParser = {};}function readDicomDataSetExplicitUndefinedLength(byteStream,warnings){var elements={};while(byteStream.position < byteStream.byteArray.length) {var element=dicomParser.readDicomElementExplicit(byteStream,warnings);elements[element.tag] = element;if(element.tag === "xfffee00d"){return new dicomParser.DataSet(byteStream.byteArrayParser,byteStream.byteArray,elements);}}byteStream.warnings.push("eof encountered before finding sequence delimitation item while reading sequence item of undefined length");return new dicomParser.DataSet(byteStream.byteArrayParser,byteStream.byteArray,elements);}function readSequenceItemExplicit(byteStream,warnings){var item=dicomParser.readSequenceItem(byteStream);if(item.length === 4294967295){item.hadUndefinedLength = true;item.dataSet = readDicomDataSetExplicitUndefinedLength(byteStream,warnings);item.length = byteStream.position - item.dataOffset;}else {item.dataSet = new dicomParser.DataSet(byteStream.byteArrayParser,byteStream.byteArray,{});dicomParser.parseDicomDataSetExplicit(item.dataSet,byteStream,byteStream.position + item.length);}return item;}function readSQElementUndefinedLengthExplicit(byteStream,element,warnings){while(byteStream.position < byteStream.byteArray.length) {var item=readSequenceItemExplicit(byteStream,warnings);element.items.push(item);if(item.tag === "xfffee0dd"){element.length = byteStream.position - element.dataOffset;return;}}byteStream.warnings.push("eof encountered before finding sequence delimitation item in sequence element of undefined length with tag " + element.tag);element.length = byteStream.byteArray.length - element.dataOffset;}function readSQElementKnownLengthExplicit(byteStream,element,warnings){var maxPosition=element.dataOffset + element.length;while(byteStream.position < maxPosition) {var item=readSequenceItemExplicit(byteStream,warnings);element.items.push(item);}}dicomParser.readSequenceItemsExplicit = function(byteStream,element,warnings){if(byteStream === undefined){throw "dicomParser.readSequenceItemsExplicit: missing required parameter 'byteStream'";}if(element === undefined){throw "dicomParser.readSequenceItemsExplicit: missing required parameter 'element'";}element.items = [];if(element.length === 4294967295){readSQElementUndefinedLengthExplicit(byteStream,element);}else {readSQElementKnownLengthExplicit(byteStream,element,warnings);}};return dicomParser;})(dicomParser);var dicomParser=(function(dicomParser){"use strict";if(dicomParser === undefined){dicomParser = {};}function readDicomDataSetImplicitUndefinedLength(byteStream){var elements={};while(byteStream.position < byteStream.byteArray.length) {var element=dicomParser.readDicomElementImplicit(byteStream);elements[element.tag] = element;if(element.tag === "xfffee00d"){return new dicomParser.DataSet(byteStream.byteArrayParser,byteStream.byteArray,elements);}}byteStream.warnings.push("eof encountered before finding sequence item delimiter in sequence item of undefined length");return new dicomParser.DataSet(byteStream.byteArrayParser,byteStream.byteArray,elements);}function readSequenceItemImplicit(byteStream){var item=dicomParser.readSequenceItem(byteStream);if(item.length === 4294967295){item.hadUndefinedLength = true;item.dataSet = readDicomDataSetImplicitUndefinedLength(byteStream);item.length = byteStream.position - item.dataOffset;}else {item.dataSet = new dicomParser.DataSet(byteStream.byteArrayParser,byteStream.byteArray,{});dicomParser.parseDicomDataSetImplicit(item.dataSet,byteStream,byteStream.position + item.length);}return item;}function readSQElementUndefinedLengthImplicit(byteStream,element){while(byteStream.position < byteStream.byteArray.length) {var item=readSequenceItemImplicit(byteStream);element.items.push(item);if(item.tag === "xfffee0dd"){element.length = byteStream.position - element.dataOffset;return;}}byteStream.warnings.push("eof encountered before finding sequence delimitation item in sequence of undefined length");element.length = byteStream.byteArray.length - element.dataOffset;}function readSQElementKnownLengthImplicit(byteStream,element){var maxPosition=element.dataOffset + element.length;while(byteStream.position < maxPosition) {var item=readSequenceItemImplicit(byteStream);element.items.push(item);}}dicomParser.readSequenceItemsImplicit = function(byteStream,element){if(byteStream === undefined){throw "dicomParser.readSequenceItemsImplicit: missing required parameter 'byteStream'";}if(element === undefined){throw "dicomParser.readSequenceItemsImplicit: missing required parameter 'element'";}element.items = [];if(element.length === 4294967295){readSQElementUndefinedLengthImplicit(byteStream,element);}else {readSQElementKnownLengthImplicit(byteStream,element);}};return dicomParser;})(dicomParser);var dicomParser=(function(dicomParser){"use strict";if(dicomParser === undefined){dicomParser = {};}dicomParser.readSequenceItem = function(byteStream){if(byteStream === undefined){throw "dicomParser.readSequenceItem: missing required parameter 'byteStream'";}var element={tag:dicomParser.readTag(byteStream),length:byteStream.readUint32(),dataOffset:byteStream.position};return element;};return dicomParser;})(dicomParser);var dicomParser=(function(dicomParser){"use strict";if(dicomParser === undefined){dicomParser = {};}dicomParser.readTag = function(byteStream){if(byteStream === undefined){throw "dicomParser.readTag: missing required parameter 'byteStream'";}var groupNumber=byteStream.readUint16() * 256 * 256;var elementNumber=byteStream.readUint16();var tag="x" + ("00000000" + (groupNumber + elementNumber).toString(16)).substr(-8);return tag;};return dicomParser;})(dicomParser);return dicomParser;});},{}],3:[function(require,module,exports){"use strict";THREE.OrbitControls2D = function(object,domElement){this.object = object;this.domElement = domElement !== undefined?domElement:document;this.enabled = true;this.target = new THREE.Vector3();this.center = this.target;this.noZoom = false;this.zoomSpeed = 1.0;this.minDistance = 0;this.maxDistance = Infinity;this.noRotate = false;this.rotateSpeed = 1.0;this.noPan = false;this.keyPanSpeed = 7.0;this.autoRotate = false;this.autoRotateSpeed = 2.0;this.minPolarAngle = 0;this.maxPolarAngle = Math.PI;this.minAzimuthAngle = -Infinity;this.maxAzimuthAngle = Infinity;this.noKeys = false;this.keys = {LEFT:37,UP:38,RIGHT:39,BOTTOM:40};this.mouseButtons = {ORBIT:THREE.MOUSE.LEFT,ZOOM:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT};var scope=this;var EPS=0.000001;var rotateStart=new THREE.Vector2();var rotateEnd=new THREE.Vector2();var rotateDelta=new THREE.Vector2();var panStart=new THREE.Vector2();var panEnd=new THREE.Vector2();var panDelta=new THREE.Vector2();var panOffset=new THREE.Vector3();var offset=new THREE.Vector3();var dollyStart=new THREE.Vector2();var dollyEnd=new THREE.Vector2();var dollyDelta=new THREE.Vector2();var theta;var phi;var phiDelta=0;var thetaDelta=0;var scale=1;var pan=new THREE.Vector3();var lastPosition=new THREE.Vector3();var lastQuaternion=new THREE.Quaternion();var STATE={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5};var state=STATE.NONE;this.target0 = this.target.clone();this.position0 = this.object.position.clone();var quat=new THREE.Quaternion().setFromUnitVectors(object.up,new THREE.Vector3(0,1,0));var quatInverse=quat.clone().inverse();var changeEvent={type:"change"};var startEvent={type:"start"};var endEvent={type:"end"};this.rotateLeft = function(angle){if(angle === undefined){angle = getAutoRotationAngle();}thetaDelta -= angle;};this.rotateUp = function(angle){if(angle === undefined){angle = getAutoRotationAngle();}phiDelta -= angle;};this.panLeft = function(distance){var te=this.object.matrix.elements;panOffset.set(te[0],te[1],te[2]);panOffset.multiplyScalar(-distance);pan.add(panOffset);};this.panUp = function(distance){var te=this.object.matrix.elements;panOffset.set(te[4],te[5],te[6]);panOffset.multiplyScalar(distance);pan.add(panOffset);};this.pan = function(deltaX,deltaY){var element=scope.domElement === document?scope.domElement.body:scope.domElement;if(scope.object.fov !== undefined){var position=scope.object.position;var offset=position.clone().sub(scope.target);var targetDistance=offset.length();targetDistance *= Math.tan(scope.object.fov / 2 * Math.PI / 180.0);scope.panLeft(2 * deltaX * targetDistance / element.clientHeight);scope.panUp(2 * deltaY * targetDistance / element.clientHeight);}else if(scope.object.top !== undefined){scope.panLeft(deltaX * (scope.object.right - scope.object.left) / (element.clientWidth * this.object.zoom));scope.panUp(deltaY * (scope.object.top - scope.object.bottom) / (element.clientHeight * this.object.zoom));}else {console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled.");}};this.dollyIn = function(dollyScale){if(dollyScale === undefined){dollyScale = getZoomScale();}if(scope.object.top !== undefined){this.object.zoom *= dollyScale;this.object.updateProjectionMatrix();}else {scale /= dollyScale;}};this.dollyOut = function(dollyScale){if(dollyScale === undefined){dollyScale = getZoomScale();}if(scope.object.top !== undefined){this.object.zoom /= dollyScale;this.object.updateProjectionMatrix();}else {scale *= dollyScale;}};this.update = function(){var position=this.object.position;offset.copy(position).sub(this.target);offset.applyQuaternion(quat);theta = Math.atan2(offset.x,offset.z);phi = Math.atan2(Math.sqrt(offset.x * offset.x + offset.z * offset.z),offset.y);if(this.autoRotate && state === STATE.NONE){this.rotateLeft(getAutoRotationAngle());}theta += thetaDelta;phi += phiDelta;theta = Math.max(this.minAzimuthAngle,Math.min(this.maxAzimuthAngle,theta));phi = Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,phi));phi = Math.max(EPS,Math.min(Math.PI - EPS,phi));var radius=offset.length() * scale;radius = Math.max(this.minDistance,Math.min(this.maxDistance,radius));this.target.add(pan);offset.x = radius * Math.sin(phi) * Math.sin(theta);offset.y = radius * Math.cos(phi);offset.z = radius * Math.sin(phi) * Math.cos(theta);offset.applyQuaternion(quatInverse);position.copy(this.target).add(offset);this.object.lookAt(this.target);thetaDelta = 0;phiDelta = 0;scale = 1;pan.set(0,0,0);if(lastPosition.distanceToSquared(this.object.position) > EPS || 8 * (1 - lastQuaternion.dot(this.object.quaternion)) > EPS){this.dispatchEvent(changeEvent);lastPosition.copy(this.object.position);lastQuaternion.copy(this.object.quaternion);}};this.reset = function(){state = STATE.NONE;this.target.copy(this.target0);this.object.position.copy(this.position0);this.update();};this.getPolarAngle = function(){return phi;};this.getAzimuthalAngle = function(){return theta;};function getAutoRotationAngle(){return 2 * Math.PI / 60 / 60 * scope.autoRotateSpeed;}function getZoomScale(){return Math.pow(0.95,scope.zoomSpeed);}function onMouseDown(event){if(scope.enabled === false){return;}event.preventDefault();if(event.button === scope.mouseButtons.ORBIT){if(scope.noRotate === true){return;}state = STATE.ROTATE;rotateStart.set(event.clientX,event.clientY);}else if(event.button === scope.mouseButtons.ZOOM){if(scope.noZoom === true){return;}state = STATE.DOLLY;dollyStart.set(event.clientX,event.clientY);}else if(event.button === scope.mouseButtons.PAN){if(scope.noPan === true){return;}state = STATE.PAN;panStart.set(event.clientX,event.clientY);}if(state !== STATE.NONE){document.addEventListener("mousemove",onMouseMove,false);document.addEventListener("mouseup",onMouseUp,false);scope.dispatchEvent(startEvent);}}function onMouseMove(event){if(scope.enabled === false){return;}event.preventDefault();var element=scope.domElement === document?scope.domElement.body:scope.domElement;if(state === STATE.ROTATE){if(scope.noRotate === true){return;}rotateEnd.set(event.clientX,event.clientY);rotateDelta.subVectors(rotateEnd,rotateStart);scope.rotateLeft(2 * Math.PI * rotateDelta.x / element.clientWidth * scope.rotateSpeed);scope.rotateUp(2 * Math.PI * rotateDelta.y / element.clientHeight * scope.rotateSpeed);rotateStart.copy(rotateEnd);}else if(state === STATE.DOLLY){if(scope.noZoom === true){return;}dollyEnd.set(event.clientX,event.clientY);dollyDelta.subVectors(dollyEnd,dollyStart);if(dollyDelta.y > 0){scope.dollyIn();}else {scope.dollyOut();}dollyStart.copy(dollyEnd);}else if(state === STATE.PAN){if(scope.noPan === true){return;}panEnd.set(event.clientX,event.clientY);panDelta.subVectors(panEnd,panStart);scope.pan(panDelta.x,panDelta.y);panStart.copy(panEnd);}if(state !== STATE.NONE){scope.update();}}function onMouseUp(){if(scope.enabled === false){return;}document.removeEventListener("mousemove",onMouseMove,false);document.removeEventListener("mouseup",onMouseUp,false);scope.dispatchEvent(endEvent);state = STATE.NONE;}function onMouseWheel(event){if(scope.enabled === false || scope.noZoom === true || state !== STATE.NONE){return;}event.preventDefault();event.stopPropagation();var delta=0;if(event.wheelDelta !== undefined){delta = event.wheelDelta;}else if(event.detail !== undefined){delta = -event.detail;}if(delta > 0){scope.dollyOut();}else {scope.dollyIn();}scope.update();scope.dispatchEvent(startEvent);scope.dispatchEvent(endEvent);}function onKeyDown(event){if(scope.enabled === false || scope.noKeys === true || scope.noPan === true){return;}switch(event.keyCode){case scope.keys.UP:scope.pan(0,scope.keyPanSpeed);scope.update();break;case scope.keys.BOTTOM:scope.pan(0,-scope.keyPanSpeed);scope.update();break;case scope.keys.LEFT:scope.pan(scope.keyPanSpeed,0);scope.update();break;case scope.keys.RIGHT:scope.pan(-scope.keyPanSpeed,0);scope.update();break;}}function touchstart(event){if(scope.enabled === false){return;}switch(event.touches.length){case 1:if(scope.noRotate === true){return;}state = STATE.TOUCH_ROTATE;rotateStart.set(event.touches[0].pageX,event.touches[0].pageY);break;case 2:if(scope.noZoom === true){return;}state = STATE.TOUCH_DOLLY;var dx=event.touches[0].pageX - event.touches[1].pageX;var dy=event.touches[0].pageY - event.touches[1].pageY;var distance=Math.sqrt(dx * dx + dy * dy);dollyStart.set(0,distance);break;case 3:if(scope.noPan === true){return;}state = STATE.TOUCH_PAN;panStart.set(event.touches[0].pageX,event.touches[0].pageY);break;default:state = STATE.NONE;}if(state !== STATE.NONE){scope.dispatchEvent(startEvent);}}function touchmove(event){if(scope.enabled === false){return;}event.preventDefault();event.stopPropagation();var element=scope.domElement === document?scope.domElement.body:scope.domElement;switch(event.touches.length){case 1:if(scope.noRotate === true){return;}if(state !== STATE.TOUCH_ROTATE){return;}rotateEnd.set(event.touches[0].pageX,event.touches[0].pageY);rotateDelta.subVectors(rotateEnd,rotateStart);scope.rotateLeft(2 * Math.PI * rotateDelta.x / element.clientWidth * scope.rotateSpeed);scope.rotateUp(2 * Math.PI * rotateDelta.y / element.clientHeight * scope.rotateSpeed);rotateStart.copy(rotateEnd);scope.update();break;case 2:if(scope.noZoom === true){return;}if(state !== STATE.TOUCH_DOLLY){return;}var dx=event.touches[0].pageX - event.touches[1].pageX;var dy=event.touches[0].pageY - event.touches[1].pageY;var distance=Math.sqrt(dx * dx + dy * dy);dollyEnd.set(0,distance);dollyDelta.subVectors(dollyEnd,dollyStart);if(dollyDelta.y > 0){scope.dollyOut();}else {scope.dollyIn();}dollyStart.copy(dollyEnd);scope.update();break;case 3:if(scope.noPan === true){return;}if(state !== STATE.TOUCH_PAN){return;}panEnd.set(event.touches[0].pageX,event.touches[0].pageY);panDelta.subVectors(panEnd,panStart);scope.pan(panDelta.x,panDelta.y);panStart.copy(panEnd);scope.update();break;default:state = STATE.NONE;}}function touchend(){if(scope.enabled === false){return;}scope.dispatchEvent(endEvent);state = STATE.NONE;}this.domElement.addEventListener("contextmenu",function(event){event.preventDefault();},false);this.domElement.addEventListener("mousedown",onMouseDown,false);this.domElement.addEventListener("mousewheel",onMouseWheel,false);this.domElement.addEventListener("DOMMouseScroll",onMouseWheel,false);this.domElement.addEventListener("touchstart",touchstart,false);this.domElement.addEventListener("touchend",touchend,false);this.domElement.addEventListener("touchmove",touchmove,false);window.addEventListener("keydown",onKeyDown,false);this.update();};THREE.OrbitControls2D.prototype = Object.create(THREE.EventDispatcher.prototype);THREE.OrbitControls2D.prototype.constructor = THREE.OrbitControls2D;module.exports = THREE.OrbitControls2D;},{}],4:[function(require,module,exports){"use strict";var VJS=VJS || {};VJS.core = VJS.core || {};VJS.core.intersections = VJS.core.intersections || {};VJS.core.intersections.obbPlane = function(obb,plane){var intersections=[];var t1=plane.direction.clone().applyMatrix4(obb.toOBBSpace);var t0=new THREE.Vector3(0,0,0).applyMatrix4(obb.toOBBSpace);var planeOBB={position:plane.position.clone().applyMatrix4(obb.toOBBSpace),direction:new THREE.Vector3(t1.x - t0.x,t1.y - t0.y,t1.z - t0.z).normalize()};var bboxMin=new THREE.Vector3(obb.center.x - obb.halfDimensions.x,obb.center.y - obb.halfDimensions.y,obb.center.z - obb.halfDimensions.z);var bboxMax=new THREE.Vector3(obb.center.x + obb.halfDimensions.x,obb.center.y + obb.halfDimensions.y,obb.center.z + obb.halfDimensions.z);var ray={"position":new THREE.Vector3(obb.center.x - obb.halfDimensions.x,obb.center.y - obb.halfDimensions.y,obb.center.z - obb.halfDimensions.z),"direction":obb.orientation.x};var intersection=this.rayPlane(ray,planeOBB);if(this.inBBox(intersection,bboxMin,bboxMax)){intersections.push(intersection.applyMatrix4(obb.toOBBSpaceInvert));}ray.direction = obb.orientation.y;intersection = this.rayPlane(ray,planeOBB);if(this.inBBox(intersection,bboxMin,bboxMax)){intersections.push(intersection.applyMatrix4(obb.toOBBSpaceInvert));}ray.direction = obb.orientation.z;intersection = this.rayPlane(ray,planeOBB);if(this.inBBox(intersection,bboxMin,bboxMax)){intersections.push(intersection.applyMatrix4(obb.toOBBSpaceInvert));}ray = {"position":new THREE.Vector3(obb.center.x + obb.halfDimensions.x,obb.center.y + obb.halfDimensions.y,obb.center.z + obb.halfDimensions.z),"direction":obb.orientation.x};intersection = this.rayPlane(ray,planeOBB);if(this.inBBox(intersection,bboxMin,bboxMax)){intersections.push(intersection.applyMatrix4(obb.toOBBSpaceInvert));}ray.direction = obb.orientation.y;intersection = this.rayPlane(ray,planeOBB);if(this.inBBox(intersection,bboxMin,bboxMax)){intersections.push(intersection.applyMatrix4(obb.toOBBSpaceInvert));}ray.direction = obb.orientation.z;intersection = this.rayPlane(ray,planeOBB);if(this.inBBox(intersection,bboxMin,bboxMax)){intersections.push(intersection.applyMatrix4(obb.toOBBSpaceInvert));}ray = {"position":new THREE.Vector3(obb.center.x + obb.halfDimensions.x,obb.center.y - obb.halfDimensions.y,obb.center.z - obb.halfDimensions.z),"direction":obb.orientation.y};intersection = this.rayPlane(ray,planeOBB);if(this.inBBox(intersection,bboxMin,bboxMax)){intersections.push(intersection.applyMatrix4(obb.toOBBSpaceInvert));}ray.direction = obb.orientation.z;intersection = this.rayPlane(ray,planeOBB);if(this.inBBox(intersection,bboxMin,bboxMax)){intersections.push(intersection.applyMatrix4(obb.toOBBSpaceInvert));}ray = {"position":new THREE.Vector3(obb.center.x - obb.halfDimensions.x,obb.center.y + obb.halfDimensions.y,obb.center.z - obb.halfDimensions.z),"direction":obb.orientation.x};intersection = this.rayPlane(ray,planeOBB);if(this.inBBox(intersection,bboxMin,bboxMax)){intersections.push(intersection.applyMatrix4(obb.toOBBSpaceInvert));}ray.direction = obb.orientation.z;intersection = this.rayPlane(ray,planeOBB);if(this.inBBox(intersection,bboxMin,bboxMax)){intersections.push(intersection.applyMatrix4(obb.toOBBSpaceInvert));}ray = {"position":new THREE.Vector3(obb.center.x - obb.halfDimensions.x,obb.center.y - obb.halfDimensions.y,obb.center.z + obb.halfDimensions.z),"direction":obb.orientation.x};intersection = this.rayPlane(ray,planeOBB);if(this.inBBox(intersection,bboxMin,bboxMax)){intersections.push(intersection.applyMatrix4(obb.toOBBSpaceInvert));}ray.direction = obb.orientation.y;intersection = this.rayPlane(ray,planeOBB);if(this.inBBox(intersection,bboxMin,bboxMax)){intersections.push(intersection.applyMatrix4(obb.toOBBSpaceInvert));}return intersections;};VJS.core.intersections.rayPlane = function(ray,plane){if(ray.direction.dot(plane.direction) !== 0){var t=(plane.direction.x * (plane.position.x - ray.position.x) + plane.direction.y * (plane.position.y - ray.position.y) + plane.direction.z * (plane.position.z - ray.position.z)) / (plane.direction.x * ray.direction.x + plane.direction.y * ray.direction.y + plane.direction.z * ray.direction.z);var intersection=new THREE.Vector3(ray.position.x + t * ray.direction.x,ray.position.y + t * ray.direction.y,ray.position.z + t * ray.direction.z);return intersection;}return null;};VJS.core.intersections.rayBox = function(ray,box){var intersections=[];var plane={position:null,direction:null};var bboxMin=new THREE.Vector3(box.center.x - box.halfDimensions.x,box.center.y - box.halfDimensions.y,box.center.z - box.halfDimensions.z);var bboxMax=new THREE.Vector3(box.center.x + box.halfDimensions.x,box.center.y + box.halfDimensions.y,box.center.z + box.halfDimensions.z);plane.direction = new THREE.Vector3(-1,0,0);plane.position = new THREE.Vector3(bboxMin.x,box.center.y,box.center.z);var intersection=this.rayPlane(ray,plane);if(this.inBBox(intersection,bboxMin,bboxMax)){intersections.push(intersection);}plane.direction = new THREE.Vector3(1,0,0);plane.position = new THREE.Vector3(bboxMax.x,box.center.y,box.center.z);intersection = this.rayPlane(ray,plane);if(this.inBBox(intersection,bboxMin,bboxMax)){intersections.push(intersection);}plane.direction = new THREE.Vector3(0,-1,0);plane.position = new THREE.Vector3(box.center.x,bboxMin.y,box.center.z);intersection = this.rayPlane(ray,plane);if(this.inBBox(intersection,bboxMin,bboxMax)){intersections.push(intersection);}plane.direction = new THREE.Vector3(0,1,0);plane.position = new THREE.Vector3(box.center.x,bboxMax.y,box.center.z);intersection = this.rayPlane(ray,plane);if(this.inBBox(intersection,bboxMin,bboxMax)){intersections.push(intersection);}plane.direction = new THREE.Vector3(0,0,-1);plane.position = new THREE.Vector3(box.center.x,box.center.y,bboxMin.z);intersection = this.rayPlane(ray,plane);if(this.inBBox(intersection,bboxMin,bboxMax)){intersections.push(intersection);}plane.direction = new THREE.Vector3(0,0,1);plane.position = new THREE.Vector3(box.center.x,box.center.y,bboxMax.z);intersection = this.rayPlane(ray,plane);if(this.inBBox(intersection,bboxMin,bboxMax)){intersections.push(intersection);}return intersections;};VJS.core.intersections.inBBox = function(point,bboxMin,bboxMax){if(point && point.x >= bboxMin.x && point.y >= bboxMin.y && point.z >= bboxMin.z && point.x <= bboxMax.x && point.y <= bboxMax.y && point.z <= bboxMax.z){return true;}return false;};var moduleType=typeof module;if(moduleType !== "undefined" && module.exports){module.exports = VJS.core.intersections;}},{}],5:[function(require,module,exports){"use strict";var VJS=VJS || {};VJS.geometries = VJS.geometries || {};VJS.core = VJS.core || {};VJS.core.intersections = VJS.core.intersections || require("../core/core.intersections");VJS.geometries.slice = function(halfDimensions,center,orientation,position,direction){var obb={"halfDimensions":halfDimensions,"center":center,"orientation":orientation,"toOBBSpace":new THREE.Matrix4(),"toOBBSpaceInvert":new THREE.Matrix4()};var plane={"position":position,"direction":direction};var intersections=VJS.core.intersections.obbPlane(obb,plane);if(intersections.length < 3){window.console.log("WARNING: Less than 3 intersections between OBB and Plane.");window.console.log("OBB");window.console.log(obb);window.console.log("Plane");window.console.log(plane);window.console.log("exiting...");}var centerOfMass=this.centerOfMass(intersections);var orderedIntersections=this.orderIntersections(intersections,centerOfMass,direction);var formatIntersections=[];var formatIntersectionsXY=[];for(var k=0;k < orderedIntersections.length;k++) {formatIntersections.push(orderedIntersections[k].point);formatIntersectionsXY.push(orderedIntersections[k].xy);}var sliceShape=new THREE.Shape();sliceShape.moveTo(formatIntersectionsXY[0].x,formatIntersectionsXY[0].y);for(var l=1;l < formatIntersectionsXY.length;l++) {sliceShape.lineTo(formatIntersectionsXY[l].x,formatIntersectionsXY[l].y);}sliceShape.lineTo(formatIntersectionsXY[0].x,formatIntersectionsXY[0].y);THREE.ShapeGeometry.call(this,sliceShape);this.type = "SliceGeometry";this.vertices = formatIntersections;this.verticesNeedUpdate = true;};VJS.geometries.slice.prototype = Object.create(THREE.ShapeGeometry.prototype);VJS.geometries.slice.prototype.constructor = VJS.geometries.slice;VJS.geometries.slice.prototype.centerOfMass = function(points){var centerOfMass=new THREE.Vector3(0,0,0);for(var i=0;i < points.length;i++) {centerOfMass.x += points[i].x;centerOfMass.y += points[i].y;centerOfMass.z += points[i].z;}centerOfMass.divideScalar(points.length);return centerOfMass;};VJS.geometries.slice.prototype.orderIntersections = function(points,reference,direction){var a0=points[0].x;var b0=points[0].y;var c0=points[0].z;var x0=points[0].x - reference.x;var y0=points[0].y - reference.y;var z0=points[0].z - reference.z;var l0={origin:new THREE.Vector3(a0,b0,c0),direction:new THREE.Vector3(x0,y0,z0).normalize()};var base=new THREE.Vector3(0,0,0).crossVectors(l0.direction,direction).normalize();var orderedpoints=[];for(var j=0;j < points.length;j++) {var a1=points[j].x;var b1=points[j].y;var c1=points[j].z;var x1=points[j].x - reference.x;var y1=points[j].y - reference.y;var z1=points[j].z - reference.z;var l1={origin:new THREE.Vector3(a1,b1,c1),direction:new THREE.Vector3(x1,y1,z1).normalize()};var x=l0.direction.dot(l1.direction);var y=base.dot(l1.direction);var thetaAngle=Math.atan2(y,x);var theta=thetaAngle * (180 / Math.PI);orderedpoints.push({"angle":theta,"point":l1.origin,"xy":{"x":x,"y":y}});}orderedpoints.sort(function(a,b){return a.angle - b.angle;});return orderedpoints;};var moduleType=typeof module;if(moduleType !== "undefined" && module.exports){module.exports = VJS.geometries.slice;}},{"../core/core.intersections":4}],6:[function(require,module,exports){"use strict";var VJS=VJS || {};VJS.helpers = VJS.helpers || {};VJS.geometries = VJS.geometries || {};VJS.geometries.slice = VJS.geometries.slice || require("../geometries/geometries.slice");VJS.shaders = VJS.shaders || {};VJS.shaders.data = VJS.shaders.data || require("../shaders/shaders.data");VJS.helpers.slice = function(){THREE.Object3D.call(this);this._series = null;this._uniforms = null;this._frameIndex = null;this._slice = null;this._border = null;this._autoWindowLevel = false;};VJS.helpers.slice.prototype = Object.create(THREE.Object3D.prototype);VJS.helpers.slice.prototype.constructor = VJS.helpers.slice;VJS.helpers.slice.prototype.merge = function(seriesHelper){return this._series.merge(seriesHelper._series);};VJS.helpers.slice.prototype.addSeries = function(series){this._series = series;};VJS.helpers.slice.prototype.getStack = function(stackIndex){return stackIndex;};VJS.helpers.slice.prototype.prepare = function(){window.console.log("helpers Series Prepare!!!");if(this._series){var stack=this._series._stack[0];stack.prepare();window.console.log(stack);var dimensions=stack._dimensions;var halfDimensions=stack._halfDimensions;var offset=new THREE.Vector3(-0.5,-0.5,-0.5);var geometry=new THREE.BoxGeometry(dimensions.x,dimensions.y,dimensions.z);geometry.applyMatrix(new THREE.Matrix4().makeTranslation(halfDimensions.x + offset.x,halfDimensions.y + offset.y,halfDimensions.z + offset.z));geometry.applyMatrix(stack._ijk2LPS);var material=new THREE.MeshBasicMaterial({wireframe:true,color:0x61F2F3});var cube=new THREE.Mesh(geometry,material);this.add(cube);var center=new THREE.Vector3(0,0,0);var orientation=new THREE.Vector3(new THREE.Vector3(1,0,0),new THREE.Vector3(0,1,0),new THREE.Vector3(0,0,1));var position=new THREE.Vector3(Math.floor(stack._halfDimensions.x),Math.floor(stack._halfDimensions.y),Math.floor(stack._halfDimensions.z) + 0.5 - stack._halfDimensions.z);var direction=new THREE.Vector3(0,0,1);var sliceGeometry=new VJS.geometries.slice(halfDimensions,center,orientation,position,direction);sliceGeometry.applyMatrix(new THREE.Matrix4().makeTranslation(halfDimensions.x + offset.x,halfDimensions.y + offset.y,halfDimensions.z + offset.z));sliceGeometry.applyMatrix(stack._ijk2LPS);this._frameIndex = Math.floor(halfDimensions.z);var textures=[];for(var m=0;m < stack._nbTextures;m++) {var tex=new THREE.DataTexture(stack._rawData[m],stack._textureSize,stack._textureSize,THREE.RGBAFormat,THREE.UnsignedByteType,THREE.UVMapping,THREE.ClampToEdgeWrapping,THREE.ClampToEdgeWrapping,THREE.NearestFilter,THREE.NearestFilter);tex.needsUpdate = true;textures.push(tex);}var sliceMaterial=new THREE.ShaderMaterial({"side":THREE.DoubleSide,"transparency":true,"uniforms":VJS.shaders.data.parameters.uniforms,"vertexShader":"#define GLSLIFY 1\nvarying vec4 vPos;\n\n//\n// main\n//\nvoid main() {\n\n  vPos = modelMatrix * vec4(position, 1.0 );\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0 );\n\n}","fragmentShader":"#define GLSLIFY 1\nuniform float uTextureSize;\nuniform float uWindowLevel[2];\nuniform sampler2D uTextureContainer[7];\nuniform vec3 uDataDimensions;\nuniform mat4 uWorldToData;\nuniform int uNumberOfChannels;\nuniform int uBitsAllocated;\nuniform int uInvert;\n\n// hack because can not pass arrays if too big\n// best would be to pass texture but have to deal with 16bits\nuniform int uLut;\nuniform float uLutI[16]; // 16 * 4 (intesity - r- g - b)\nuniform float uLutR[16];\nuniform float uLutG[16];\nuniform float uLutB[16];\n\nvarying vec4 vPos;\n\nvec4 sampleAs3DTexture(in vec3 textureCoordinate) {\n\n  float slicePixelSize = 1.0 / uTextureSize;\n  // Model coordinate (IJK) to data index\n  float index = textureCoordinate.x * uDataDimensions.x + textureCoordinate.y * uDataDimensions.y * uDataDimensions.x + textureCoordinate.z * uDataDimensions.z * uDataDimensions.y * uDataDimensions.x;\n\n  // Map data index to right sampler2D texture\n  float textureIndex = floor(index / (uTextureSize*uTextureSize));\n  float inTextureIndex = mod(index, uTextureSize*uTextureSize);\n\n  // Get row and column in the texture\n  float rowIndex = floor(inTextureIndex/uTextureSize);\n  float colIndex = mod(inTextureIndex, uTextureSize);\n\n  // Map row and column to uv\n  vec2 uv = vec2(0,0);\n  uv.x = slicePixelSize * 0.5 + colIndex * slicePixelSize;\n  uv.y = 1.0 - (slicePixelSize * 0.5 + rowIndex * slicePixelSize);\n\n  vec4 dataValue = vec4(0, 0, 0, 1);\n  if(textureIndex == 0.0){\n    dataValue = texture2D(uTextureContainer[0], uv);\n  }\n  else if(textureIndex == 1.0){\n    dataValue = texture2D(uTextureContainer[1], uv);\n  }\n  else if(textureIndex == 2.0){\n    dataValue = texture2D(uTextureContainer[2], uv);\n  }\n  else if(textureIndex == 3.0){\n    dataValue = texture2D(uTextureContainer[3], uv);\n  }\n  else if(textureIndex == 4.0){\n    dataValue = texture2D(uTextureContainer[4], uv);\n  }\n  else if(textureIndex == 5.0){\n    dataValue = texture2D(uTextureContainer[5], uv);\n  }\n  else if(textureIndex == 6.0){\n    dataValue = texture2D(uTextureContainer[6], uv);\n  }\n  // else if(textureIndex == 7.0){\n  //   dataValue = texture2D(uTextureContainer[7], uv);\n  // }\n  // else if(textureIndex == 8.0){\n  //   dataValue = texture2D(uTextureContainer[8], uv);\n  // }\n  // else if(textureIndex == 9.0){\n  //   dataValue = texture2D(uTextureContainer[9], uv);\n  // }\n  // else if(textureIndex == 10.0){\n  //   dataValue = texture2D(uTextureContainer[10], uv);\n  // }\n  // else if(textureIndex == 11.0){\n  //   dataValue = texture2D(uTextureContainer[11], uv);\n  // }\n  // else if(textureIndex == 12.0){\n  //   dataValue = texture2D(uTextureContainer[12], uv);\n  // }\n  // else if(textureIndex == 13.0){\n  //   dataValue = texture2D(uTextureContainer[13], uv);\n  // }\n  // else if(textureIndex == 14.0){\n  //   dataValue = texture2D(uTextureContainer[14], uv);\n  // }\n  // else if(textureIndex == 15.0){\n  //   dataValue = texture2D(uTextureContainer[15], uv);\n  // }\n  // else {\n  //   discard;\n  // }\n\n  return dataValue;\n}\n\nvoid main(void) {\n\n  // get texture coordinates of current pixel\n  // might not be the right way to do it:\n  // precision issues ar voxels limits\n  // need to add machine epsilon?\n  vec4 dataCoordinateRaw = uWorldToData * vPos;\n  dataCoordinateRaw += 0.5;\n  vec3 dataCoordinate = vec3(floor(dataCoordinateRaw.x), floor(dataCoordinateRaw.y), floor(dataCoordinateRaw.z));\n\n\n  // if data in range, look it up in the texture!\n  if(dataCoordinate.x >= 0.0\n  && dataCoordinate.y >= 0.0\n  && dataCoordinate.z >= 0.0\n  && dataCoordinate.x < uDataDimensions.x\n  && dataCoordinate.y < uDataDimensions.y\n  && dataCoordinate.z < uDataDimensions.z\n  ){\n    vec3 textureCoordinate = dataCoordinate/uDataDimensions;\n    vec4 dataValue = sampleAs3DTexture(textureCoordinate);\n    //vec4(1.0, 0.5, 0.5, 1.0);//\n    \n\n    // Threshold? to copr intensities out?\n\n    if(uNumberOfChannels == 1){\n      // reconstruct 16bits data if any\n      float rawValue = dataValue.r * 255.0 * 256.0 + dataValue.g * 255.0;\n      float windowMin = uWindowLevel[0] - uWindowLevel[1]/2.0;\n      float windowMax = uWindowLevel[0] + uWindowLevel[1]/2.0;\n      float combined = ( rawValue - windowMin ) / uWindowLevel[1];\n\n      dataValue.r = dataValue.g = dataValue.b = combined;\n    }\n\n    // Apply LUT table...\n    // will pass it through a texture...\n\n    if(uLut == 1){\n    // if uApplyLUT\n    // if LUT Gradation? Interpolation\n    // get LUT from texture\n    for(int i=0; i<16; i++){\n      if(dataValue.r < uLutI[i]){\n        // i and i-1\n        float dataValuePosition = dataValue.r - uLutI[i-1];\n        float lutRange = uLutI[i] - uLutI[i-1];\n        float lutWeight = dataValuePosition/lutRange;\n        // use gradation or not??\n        // color distance\n        float colorDistanceR = uLutR[i] - uLutR[i-1];\n        float colorDistanceG = uLutG[i] - uLutG[i-1];\n        float colorDistanceB = uLutB[i] - uLutB[i-1];\n\n        // by weight\n        float colorIncrementR = lutWeight * colorDistanceR;\n        float colorIncrementG = lutWeight * colorDistanceG;\n        float colorIncrementB = lutWeight * colorDistanceB;\n\n        // add it\n        dataValue.r = uLutR[i-1] + colorIncrementR;\n        dataValue.g = uLutG[i-1] + colorIncrementG;\n        dataValue.b = uLutB[i-1] + colorIncrementB;\n        // dataValue.r += colorIncrementR;\n        // dataValue.g += colorIncrementG;\n        // dataValue.b += colorIncrementB;\n       break;\n     }\n    }\n    }\n\n    // Apply label map...?\n    // target specific intensity\n\n    if(uInvert == 1){\n      dataValue = vec4(1, 1, 1, 1) - dataValue;\n      dataValue.a = 1.0;\n    }\n\n    gl_FragColor = dataValue;\n  }\n  else{\n    // should be able to choose what we want to do if not in range:\n    // discard or specific color\n    //discard;\n    gl_FragColor = vec4(0.011, 0.662, 0.956, 1.0);\n  }\n}"});var mySliceMaterial=sliceMaterial.clone();this._uniforms = mySliceMaterial.uniforms;this._uniforms.uTextureSize.value = stack._textureSize;this._uniforms.uTextureContainer.value = textures;this._uniforms.uDataDimensions.value = stack._dimensions;this._uniforms.uWorldToData.value = stack._lps2IJK;this._uniforms.uWindowLevel.value = stack._windowLevel;this._uniforms.uNumberOfChannels.value = stack._numberOfChannels;this._uniforms.uBitsAllocated.value = stack._bitsAllocated;this._uniforms.uInvert.value = stack._invert;this._slice = new THREE.Mesh(sliceGeometry,mySliceMaterial);this.add(this._slice);var borderMaterial=new THREE.LineBasicMaterial({color:0xff0000,polygonOffset:true,polygonOffsetFactor:-0.1});var borderGeometry=new THREE.Geometry();for(var i=0;i < sliceGeometry.vertices.length;i++) {borderGeometry.vertices.push(sliceGeometry.vertices[i]);}borderGeometry.vertices.push(sliceGeometry.vertices[0]);this._border = new THREE.Line(borderGeometry,borderMaterial);this.add(this._border);}else {window.console.log("no series to be prepared...");}};VJS.helpers.slice.prototype.updateSliceGeometry = function(){var stack=this._series._stack[0];var halfDimensions=stack._halfDimensions;var offset=new THREE.Vector3(-0.5,-0.5,-0.5);var center=new THREE.Vector3(0,0,0);var orientation=new THREE.Vector3(new THREE.Vector3(1,0,0),new THREE.Vector3(0,1,0),new THREE.Vector3(0,0,1));var position=new THREE.Vector3(0,0,this._frameIndex + 0.5 - stack._halfDimensions.z);var direction=new THREE.Vector3(0,0,1);var sliceGeometry=new VJS.geometries.slice(halfDimensions,center,orientation,position,direction);sliceGeometry.applyMatrix(new THREE.Matrix4().makeTranslation(halfDimensions.x + offset.x,halfDimensions.y + offset.y,halfDimensions.z + offset.z));sliceGeometry.applyMatrix(stack._ijk2LPS);this._slice.geometry = sliceGeometry;this._slice.geometry.verticesNeedUpdate = true;};VJS.helpers.slice.prototype.updateBorderGeometry = function(){var borderGeometry=new THREE.Geometry();for(var i=0;i < this._slice.geometry.vertices.length;i++) {borderGeometry.vertices.push(this._slice.geometry.vertices[i]);}borderGeometry.vertices.push(this._slice.geometry.vertices[0]);this._border.geometry.vertices = borderGeometry.vertices;this._border.geometry.verticesNeedUpdate = true;};var moduleType=typeof module;if(moduleType !== "undefined" && module.exports){module.exports = VJS.helpers.slice;}},{"../geometries/geometries.slice":5,"../shaders/shaders.data":13}],7:[function(require,module,exports){"use strict";var VJS=VJS || {};VJS.loaders = VJS.loaders || {};VJS.parsers = VJS.parsers || {};VJS.parsers.dicom = VJS.parsers.dicom || require("../parsers/parsers.dicom");VJS.models = VJS.models || {};VJS.models.series = VJS.models.series || require("../models/models.series");VJS.models.stack = VJS.models.stack || require("../models/models.stack");VJS.models.frame = VJS.models.frame || require("../models/models.frame");VJS.helpers = VJS.helpers || {};VJS.helpers.slice = VJS.helpers.slice || require("../helpers/helpers.slice");VJS.loaders.dicom = function(manager){this.manager = manager !== undefined?manager:THREE.DefaultLoadingManager;this.crossOrigin = true;this.responseType = "arraybuffer";this._imageHelper = null;this._image = null;};VJS.loaders.dicom.prototype.constructor = VJS.loaders.dicom;VJS.loaders.dicom.prototype.load = function(file,onLoad,onProgress,onError){var scope=this;var loader=new THREE.XHRLoader(scope.manager);loader.setCrossOrigin(this.crossOrigin);loader.setResponseType(this.responseType);loader.load(file,function(response){onLoad(scope.parse(response));},onProgress,onError);};VJS.loaders.dicom.prototype.parse = function(response){window.console.log(response);window.console.log("file downloaded yay!");var seriesHelper=new VJS.helpers.slice();var dicomParser=null;try{dicomParser = new VJS.parsers.dicom(response,seriesHelper.id);}catch(e) {window.console.log("error cought in dicom loader");window.console.log(e);return null;}var series=new VJS.models.series();series._seriesInstanceUID = dicomParser.seriesInstanceUID();series._numberOfFrames = dicomParser.numberOfFrames();if(!series._numberOfFrames){series._numberOfFrames = 1;}series._numberOfChannels = dicomParser.numberOfChannels();var stack=new VJS.models.stack();stack._numberOfChannels = dicomParser.numberOfChannels();series._stack.push(stack);for(var i=0;i < series._numberOfFrames;i++) {var frame=new VJS.models.frame();frame._rows = dicomParser.rows(i);frame._columns = dicomParser.columns(i);frame._pixelData = dicomParser.extractPixelData(i);frame._pixelSpacing = dicomParser.pixelSpacing(i);frame._sliceThickness = dicomParser.sliceThickness(i);frame._imageOrientation = dicomParser.imageOrientation(i);frame._imagePosition = dicomParser.imagePosition(i);frame._dimensionIndexValues = dicomParser.dimensionIndexValues(i);frame._bitsAllocated = dicomParser.bitsAllocated(i);frame._instanceNumber = dicomParser.instanceNumber(i);frame._windowCenter = dicomParser.windowCenter(i);frame._windowWidth = dicomParser.windowWidth(i);frame._minMax = dicomParser.minMaxPixelData(frame._pixelData);stack._frame.push(frame);}seriesHelper.addSeries(series);return seriesHelper;};var moduleType=typeof module;if(moduleType !== "undefined" && module.exports){module.exports = VJS.loaders.dicom;}},{"../helpers/helpers.slice":6,"../models/models.frame":8,"../models/models.series":9,"../models/models.stack":10,"../parsers/parsers.dicom":12}],8:[function(require,module,exports){"use strict";var VJS=VJS || {};VJS.models = VJS.models || {};VJS.models.frame = function(){this._id = "-1";this._stackID = -1;this._rows = 0;this._columns = 0;this._dimensionIndexValues = [];this._imagePositionPatient = {"x":0,"y":0,"z":0};this._imageOrientationPatient = {"row":{"x":0,"y":0,"z":0},"column":{"x":0,"y":0,"z":0}};this._sliceThickness = 1;this._pixelSpacing = {"row":1,"column":1};this._spacingBetweenSlices = null;this._pixelData = null;this._instanceNumber = null;this._windowCenter = null;this._windowWidth = null;this._minMax = null;};VJS.models.frame.prototype.constructor = VJS.models.frame;var moduleType=typeof module;if(moduleType !== "undefined" && module.exports){module.exports = VJS.models.frame;}},{}],9:[function(require,module,exports){"use strict";var VJS=VJS || {};VJS.models = VJS.models || {};VJS.models.series = function(){this._id = -1;this._concatenationUID = -1;this._seriesInstanceUID = -1;this._seriesNumber = -1;this._dimensionIndexSequence = [];this._rows = 0;this._columns = 0;this._photometricInterpretation = "";this._numberOfFrames = 0;this._numberOfChannels = 1;this._instanceNumber = 0;this._stack = [];};VJS.models.series.prototype.merge = function(series){var sameSeriesUID=false;if(this._seriesInstanceUID === series._seriesInstanceUID){window.console.log("stacks belong to same series!");sameSeriesUID = true;var stack=series._stack;for(var i=0;i < stack.length;i++) {for(var j=0;j < this._stack.length;j++) {window.console.log(this._stack[j],stack[i]);if(this._stack[j].merge(stack[i])){window.console.log("stacks merged successfully!");break;}else if(j === this._stack.length - 1){window.console.log("stacks added to the list!");this._stack.push(stack[i]);}}}}return sameSeriesUID;};var moduleType=typeof module;if(moduleType !== "undefined" && module.exports){module.exports = VJS.models.series;}},{}],10:[function(require,module,exports){"use strict";var VJS=VJS || {};VJS.models = VJS.models || {};VJS.models.stack = function(){this._id = "-1";this._uid = null;this._stackID = -1;this._frame = [];this._rows = 0;this._columns = 0;this._numberOfFrames = 0;this._pixelSpacing = {"row":0,"column":0};this._spacingBetweenSlices = 0;this._sliceThickness = 0;this._origin = null;this._halfDimensions = null;this._orientation = null;this._textureSize = 4096;this._nbTextures = 7;this._rawData = [];this._windowLevel = [0,0];this._windowCenter = 0;this._windowWidth = 0;this._minMax = [65535,-32768];this._invert = false;this._ijk2LPS = null;this._lps2IJK = null;this._dimensions = null;this._spacing = null;this._origin = null;this._direction = null;};VJS.models.stack.prototype.prepare = function(){this._numberOfFrames = this._frame.length;window.console.log(this);this.orderFrames();var zSpacing=this.zSpacing();if(this._frame[0]._pixelSpacing){this._pixelSpacing.row = this._frame[0]._pixelSpacing[0];this._pixelSpacing.column = this._frame[0]._pixelSpacing[1];}else if(this._frame[0]._pixelAspectRatio){this._pixelSpacing.row = 1.0;this._pixelSpacing.column = 1.0 * this._frame[0]._pixelAspectRatio[1] / this._frame[0]._pixelAspectRatio[0];}else {this._pixelSpacing.row = 1.0;this._pixelSpacing.column = 1.0;}if(!this._frame[0]._imagePosition){this._frame[0]._imagePosition = [0,0,0];}if(!this._frame[0]._imageOrientation){this._frame[0]._imageOrientation = [1,0,0,0,1,0];}this._rows = this._frame[0]._rows;this._columns = this._frame[0]._columns;this._dimensions = new THREE.Vector3(this._columns,this._rows,this._numberOfFrames);this._spacingBetweenSlices = this._frame[0]._spacingBetweenSlices;this._sliceThickness = this._frame[0]._sliceThickness;for(var i=0;i < this._frame.length;i++) {if(this._rows !== this._frame[i]._rows){window.console.log("Numbers of rows in stack's frames is not consistent.");window.console.log(this);window.console.log("First frame had: ",this._rows," rows");window.console.log("Frame index: ",i," has: ",this._frame[i]._rows," rows.");}if(this._columns !== this._frame[i]._columns){window.console.log("Numbers of columns in stack's frames is not consistent.");window.console.log(this);window.console.log("First frame had: ",this._columns," columns.");window.console.log("Frame index: ",i," has: ",this.frame[i]._columns," columns.");}this._minMax[0] = Math.min(this._minMax[0],this._frame[i]._minMax[0]);this._minMax[1] = Math.max(this._minMax[1],this._frame[i]._minMax[1]);}this._origin = new THREE.Vector3(this._frame[0]._imagePosition[0],this._frame[0]._imagePosition[1],this._frame[0]._imagePosition[2]);window.console.log("first frame value!");window.console.log(this._frame[0]._imageOrientation[0]);var xCosine=new THREE.Vector3(this._frame[0]._imageOrientation[0],this._frame[0]._imageOrientation[1],this._frame[0]._imageOrientation[2]);window.console.log(xCosine);var yCosine=new THREE.Vector3(this._frame[0]._imageOrientation[3],this._frame[0]._imageOrientation[4],this._frame[0]._imageOrientation[5]);var zCosine=new THREE.Vector3(0,0,0).crossVectors(xCosine,yCosine).normalize();this._direction = new THREE.Matrix4();this._direction.set(xCosine.x,yCosine.x,zCosine.x,0,xCosine.y,yCosine.y,zCosine.y,0,xCosine.z,yCosine.z,zCosine.z,0,0,0,0,1);window.console.log(this._direction);this._spacing = new THREE.Vector3(this._pixelSpacing.row,this._pixelSpacing.column,zSpacing);window.console.log(this._spacing);this._halfDimensions = new THREE.Vector3(this._dimensions.x / 2,this._dimensions.y / 2,this._dimensions.z / 2);var baseX=new THREE.Vector3(1,0,0);var baseY=new THREE.Vector3(0,1,0);var baseZ=new THREE.Vector3(0,0,1);this._orientation = new THREE.Vector3(baseX,baseY,baseZ);this._ijk2LPS = new THREE.Matrix4();this._ijk2LPS.set(xCosine.x * this._spacing.x,yCosine.x * this._spacing.y,zCosine.x * this._spacing.z,this._origin.x,xCosine.y * this._spacing.x,yCosine.y * this._spacing.y,zCosine.y * this._spacing.z,this._origin.y,xCosine.z * this._spacing.x,yCosine.z * this._spacing.y,zCosine.z * this._spacing.z,this._origin.z,0,0,0,1);this._lps2IJK = new THREE.Matrix4();this._lps2IJK.getInverse(this._ijk2LPS);window.console.log(this._lps2IJK,this._ijk2LPS,this._direction);var nbVoxels=this._dimensions.x * this._dimensions.y * this._dimensions.z;window.console.log(this._dimensions);for(var ii=0;ii < this._nbTextures;ii++) {this._rawData.push(new Uint8Array(this._textureSize * this._textureSize * 4));}var frameDimension=this._dimensions.x * this._dimensions.y;var textureDimension=this._textureSize * this._textureSize;console.time("arrangeDataForWebgl");for(var jj=0;jj < nbVoxels;jj++) {var frameIndex=Math.floor(jj / frameDimension);var inFrameIndex=jj % frameDimension;var textureIndex=Math.floor(jj / textureDimension);var inTextureIndex=jj % textureDimension;if(this._numberOfChannels === 3){this._rawData[textureIndex][4 * inTextureIndex] = this._frame[frameIndex]._pixelData[4 * inFrameIndex];this._rawData[textureIndex][4 * inTextureIndex + 1] = this._frame[frameIndex]._pixelData[4 * inFrameIndex + 1];this._rawData[textureIndex][4 * inTextureIndex + 2] = this._frame[frameIndex]._pixelData[4 * inFrameIndex + 2];this._rawData[textureIndex][4 * inTextureIndex + 3] = this._frame[frameIndex]._pixelData[4 * inFrameIndex + 3];}else {var rawValue=this._frame[frameIndex]._pixelData[inFrameIndex];var lsb=rawValue & 0xFF;var msb=rawValue >> 8 & 0xFF;this._rawData[textureIndex][4 * inTextureIndex] = msb;this._rawData[textureIndex][4 * inTextureIndex + 1] = lsb;this._rawData[textureIndex][4 * inTextureIndex + 2] = frameIndex;this._rawData[textureIndex][4 * inTextureIndex + 3] = frameIndex;}}var width=this._minMax[1] - this._minMax[0];var center=this._minMax[0] + width / 2;this._windowWidth = width;this._windowCenter = center;this._windowLevel = [center,width];this._bitsAllocated = this._frame[0]._bitsAllocated;window.console.log("window level: ",this._windowLevel);};VJS.models.stack.prototype.orderFrameOnDimensionIndices = function(a,b){if("_dimensionIndexValues" in a && Object.prototype.toString.call(a._dimensionIndexValues) === "[object Array]" && "_dimensionIndexValues" in b && Object.prototype.toString.call(b._dimensionIndexValues) === "[object Array]"){for(var i=0;i < a._dimensionIndexValues.length;i++) {if(parseInt(a._dimensionIndexValues[i]) > parseInt(b._dimensionIndexValues[i])){return 1;}if(parseInt(a._dimensionIndexValues[i]) < parseInt(b._dimensionIndexValues[i])){return -1;}}}else {window.console.log("One of the frames doesn't have a _dimensionIndexValues array.");window.console.log(a);window.console.log(b);}return 0;};VJS.models.stack.prototype.orderFrames = function(){window.console.log(this);if(this._frame[0]._dimensionIndexValues){this._frame.sort(VJS.models.stack.prototype.orderFrameOnDimensionIndices);}else if(this._frame[0]._imagePosition && this._frame[0]._imageOrientation){var xCosine=new THREE.Vector3(this._frame[0]._imageOrientation[0],this._frame[0]._imageOrientation[1],this._frame[0]._imageOrientation[2]);var yCosine=new THREE.Vector3(this._frame[0]._imageOrientation[3],this._frame[0]._imageOrientation[4],this._frame[0]._imageOrientation[5]);var zCosine=new THREE.Vector3(0,0,0).crossVectors(xCosine,yCosine).normalize();this._frame.map(this._computeDistance.bind(null,zCosine));this._frame.sort(this._sortDistance);}else {}};VJS.models.stack.prototype._computeDistance = function(normal,frame){frame._dist = frame._imagePosition[0] * normal.x + frame._imagePosition[1] * normal.y + frame._imagePosition[2] * normal.z;return frame;};VJS.models.stack.prototype._sortDistance = function(a,b){return a._dist - b._dist;};VJS.models.stack.prototype.zSpacing = function(){var zSpacing=1;window.console.log(this._frame[0]);if(this._numberOfFrames > 1){if(this._spacingBetweenSlices){zSpacing = this._spacingBetweenSlices;}else if(this._frame[0]._sliceThickness){zSpacing = this._frame[0]._sliceThickness;}else {var xCosine=new THREE.Vector3(this._frame[0]._imageOrientation[0],this._frame[0]._imageOrientation[1],this._frame[0]._imageOrientation[2]);var yCosine=new THREE.Vector3(this._frame[0]._imageOrientation[3],this._frame[0]._imageOrientation[4],this._frame[0]._imageOrientation[5]);var zCosine=new THREE.Vector3(0,0,0).crossVectors(xCosine,yCosine).normalize();this._frame.map(this._computeDistance.bind(null,zCosine));this._frame.sort(this._sortDistance);zSpacing = this._frame[1]._dist - this._frame[0]._dist;}}if(zSpacing === 0){zSpacing = 1;}return zSpacing;};VJS.models.stack.prototype.merge = function(stack){var sameStackID=false;if(this._stackID === stack._stackID){sameStackID = true;var frame=stack._frame;for(var i=0;i < frame.length;i++) {for(var j=0;j < this._frame.length;j++) {if(this._frame[j]._dimensionIndexValues && frame[i]._dimensionIndexValues && this._frame[j]._dimensionIndexValues.join() === frame[i]._dimensionIndexValues.join() || this._frame[j]._instanceNumber && frame[i]._instanceNumber && this._frame[j]._instanceNumber === frame[i]._instanceNumber || this._frame[j]._imagePosition && frame[i]._imagePosition && this._frame[j]._imagePosition.join() === frame[i]._imagePosition.join() && this._frame[j]._imageOrientation && frame[i]._imageOrientation && this._frame[j]._imageOrientation.join() === frame[i]._imageOrientation.join() && this._frame[j]._instanceNumber && frame[i]._instanceNumber && this._frame[j]._instanceNumber === frame[i]._instanceNumber){window.console.log("BREAKING!");window.console.log(frame[i],this._frame[j]);break;}else if(j === this._frame.length - 1){window.console.log("PUSHING FRAME TO STACK!");this._frame.push(frame[i]);break;}}}}window.console.log(this);return sameStackID;};var moduleType=typeof module;if(moduleType !== "undefined" && module.exports){module.exports = VJS.models.stack;}},{}],11:[function(require,module,exports){"use strict";var JpxImage=(function JpxImageClosure(){var SubbandsGainLog2={"LL":0,"LH":1,"HL":1,"HH":2};function JpxImage(){this.failOnCorruptedImage = false;}JpxImage.prototype = {parse:function JpxImage_parse(data){var head=readUint16(data,0);if(head === 0xFF4F){this.parseCodestream(data,0,data.length);return;}var position=0,length=data.length;while(position < length) {var headerSize=8;var lbox=readUint32(data,position);var tbox=readUint32(data,position + 4);position += headerSize;if(lbox === 1){lbox = readUint32(data,position) * 4294967296 + readUint32(data,position + 4);position += 8;headerSize += 8;}if(lbox === 0){lbox = length - position + headerSize;}if(lbox < headerSize){throw new Error("JPX Error: Invalid box field size");}var dataLength=lbox - headerSize;var jumpDataLength=true;switch(tbox){case 0x6A703268:jumpDataLength = false;break;case 0x636F6C72:var method=data[position];var precedence=data[position + 1];var approximation=data[position + 2];if(method === 1){var colorspace=readUint32(data,position + 3);switch(colorspace){case 16:case 17:case 18:break;default:warn("Unknown colorspace " + colorspace);break;}}else if(method === 2){info("ICC profile not supported");}break;case 0x6A703263:this.parseCodestream(data,position,position + dataLength);break;case 0x6A502020:if(0x0d0a870a !== readUint32(data,position)){warn("Invalid JP2 signature");}break;case 0x6A501A1A:case 0x66747970:case 0x72726571:case 0x72657320:case 0x69686472:break;default:var headerType=String.fromCharCode(tbox >> 24 & 0xFF,tbox >> 16 & 0xFF,tbox >> 8 & 0xFF,tbox & 0xFF);warn("Unsupported header type " + tbox + " (" + headerType + ")");break;}if(jumpDataLength){position += dataLength;}}},parseImageProperties:function JpxImage_parseImageProperties(stream){var newByte=stream.getByte();while(newByte >= 0) {var oldByte=newByte;newByte = stream.getByte();var code=oldByte << 8 | newByte;if(code === 0xFF51){stream.skip(4);var Xsiz=stream.getInt32() >>> 0;var Ysiz=stream.getInt32() >>> 0;var XOsiz=stream.getInt32() >>> 0;var YOsiz=stream.getInt32() >>> 0;stream.skip(16);var Csiz=stream.getUint16();this.width = Xsiz - XOsiz;this.height = Ysiz - YOsiz;this.componentsCount = Csiz;this.bitsPerComponent = 8;return;}}throw new Error("JPX Error: No size marker found in JPX stream");},parseCodestream:function JpxImage_parseCodestream(data,start,end){var context={};try{var doNotRecover=false;var position=start;while(position + 1 < end) {var code=readUint16(data,position);position += 2;var length=0,j,sqcd,spqcds,spqcdSize,scalarExpounded,tile;switch(code){case 0xFF4F:context.mainHeader = true;break;case 0xFFD9:break;case 0xFF51:length = readUint16(data,position);var siz={};siz.Xsiz = readUint32(data,position + 4);siz.Ysiz = readUint32(data,position + 8);siz.XOsiz = readUint32(data,position + 12);siz.YOsiz = readUint32(data,position + 16);siz.XTsiz = readUint32(data,position + 20);siz.YTsiz = readUint32(data,position + 24);siz.XTOsiz = readUint32(data,position + 28);siz.YTOsiz = readUint32(data,position + 32);var componentsCount=readUint16(data,position + 36);siz.Csiz = componentsCount;var components=[];j = position + 38;for(var i=0;i < componentsCount;i++) {var component={precision:(data[j] & 0x7F) + 1,isSigned:!!(data[j] & 0x80),XRsiz:data[j + 1],YRsiz:data[j + 1]};calculateComponentDimensions(component,siz);components.push(component);}context.SIZ = siz;context.components = components;calculateTileGrids(context,components);context.QCC = [];context.COC = [];break;case 0xFF5C:length = readUint16(data,position);var qcd={};j = position + 2;sqcd = data[j++];switch(sqcd & 0x1F){case 0:spqcdSize = 8;scalarExpounded = true;break;case 1:spqcdSize = 16;scalarExpounded = false;break;case 2:spqcdSize = 16;scalarExpounded = true;break;default:throw new Error("JPX Error: Invalid SQcd value " + sqcd);}qcd.noQuantization = spqcdSize === 8;qcd.scalarExpounded = scalarExpounded;qcd.guardBits = sqcd >> 5;spqcds = [];while(j < length + position) {var spqcd={};if(spqcdSize === 8){spqcd.epsilon = data[j++] >> 3;spqcd.mu = 0;}else {spqcd.epsilon = data[j] >> 3;spqcd.mu = (data[j] & 0x7) << 8 | data[j + 1];j += 2;}spqcds.push(spqcd);}qcd.SPqcds = spqcds;if(context.mainHeader){context.QCD = qcd;}else {context.currentTile.QCD = qcd;context.currentTile.QCC = [];}break;case 0xFF5D:length = readUint16(data,position);var qcc={};j = position + 2;var cqcc;if(context.SIZ.Csiz < 257){cqcc = data[j++];}else {cqcc = readUint16(data,j);j += 2;}sqcd = data[j++];switch(sqcd & 0x1F){case 0:spqcdSize = 8;scalarExpounded = true;break;case 1:spqcdSize = 16;scalarExpounded = false;break;case 2:spqcdSize = 16;scalarExpounded = true;break;default:throw new Error("JPX Error: Invalid SQcd value " + sqcd);}qcc.noQuantization = spqcdSize === 8;qcc.scalarExpounded = scalarExpounded;qcc.guardBits = sqcd >> 5;spqcds = [];while(j < length + position) {spqcd = {};if(spqcdSize === 8){spqcd.epsilon = data[j++] >> 3;spqcd.mu = 0;}else {spqcd.epsilon = data[j] >> 3;spqcd.mu = (data[j] & 0x7) << 8 | data[j + 1];j += 2;}spqcds.push(spqcd);}qcc.SPqcds = spqcds;if(context.mainHeader){context.QCC[cqcc] = qcc;}else {context.currentTile.QCC[cqcc] = qcc;}break;case 0xFF52:length = readUint16(data,position);var cod={};j = position + 2;var scod=data[j++];cod.entropyCoderWithCustomPrecincts = !!(scod & 1);cod.sopMarkerUsed = !!(scod & 2);cod.ephMarkerUsed = !!(scod & 4);cod.progressionOrder = data[j++];cod.layersCount = readUint16(data,j);j += 2;cod.multipleComponentTransform = data[j++];cod.decompositionLevelsCount = data[j++];cod.xcb = (data[j++] & 0xF) + 2;cod.ycb = (data[j++] & 0xF) + 2;var blockStyle=data[j++];cod.selectiveArithmeticCodingBypass = !!(blockStyle & 1);cod.resetContextProbabilities = !!(blockStyle & 2);cod.terminationOnEachCodingPass = !!(blockStyle & 4);cod.verticalyStripe = !!(blockStyle & 8);cod.predictableTermination = !!(blockStyle & 16);cod.segmentationSymbolUsed = !!(blockStyle & 32);cod.reversibleTransformation = data[j++];if(cod.entropyCoderWithCustomPrecincts){var precinctsSizes=[];while(j < length + position) {var precinctsSize=data[j++];precinctsSizes.push({PPx:precinctsSize & 0xF,PPy:precinctsSize >> 4});}cod.precinctsSizes = precinctsSizes;}var unsupported=[];if(cod.selectiveArithmeticCodingBypass){unsupported.push("selectiveArithmeticCodingBypass");}if(cod.resetContextProbabilities){unsupported.push("resetContextProbabilities");}if(cod.terminationOnEachCodingPass){unsupported.push("terminationOnEachCodingPass");}if(cod.verticalyStripe){unsupported.push("verticalyStripe");}if(cod.predictableTermination){unsupported.push("predictableTermination");}if(unsupported.length > 0){doNotRecover = true;throw new Error("JPX Error: Unsupported COD options (" + unsupported.join(", ") + ")");}if(context.mainHeader){context.COD = cod;}else {context.currentTile.COD = cod;context.currentTile.COC = [];}break;case 0xFF90:length = readUint16(data,position);tile = {};tile.index = readUint16(data,position + 2);tile.length = readUint32(data,position + 4);tile.dataEnd = tile.length + position - 2;tile.partIndex = data[position + 8];tile.partsCount = data[position + 9];context.mainHeader = false;if(tile.partIndex === 0){tile.COD = context.COD;tile.COC = context.COC.slice(0);tile.QCD = context.QCD;tile.QCC = context.QCC.slice(0);}context.currentTile = tile;break;case 0xFF93:tile = context.currentTile;if(tile.partIndex === 0){initializeTile(context,tile.index);buildPackets(context);}length = tile.dataEnd - position;parseTilePackets(context,data,position,length);break;case 0xFF55:case 0xFF57:case 0xFF58:case 0xFF64:length = readUint16(data,position);break;case 0xFF53:throw new Error("JPX Error: Codestream code 0xFF53 (COC) is " + "not implemented");default:throw new Error("JPX Error: Unknown codestream code: " + code.toString(16));}position += length;}}catch(e) {if(doNotRecover || this.failOnCorruptedImage){throw e;}else {warn("Trying to recover from " + e.message);}}this.tiles = transformComponents(context);this.width = context.SIZ.Xsiz - context.SIZ.XOsiz;this.height = context.SIZ.Ysiz - context.SIZ.YOsiz;this.componentsCount = context.SIZ.Csiz;}};function calculateComponentDimensions(component,siz){component.x0 = Math.ceil(siz.XOsiz / component.XRsiz);component.x1 = Math.ceil(siz.Xsiz / component.XRsiz);component.y0 = Math.ceil(siz.YOsiz / component.YRsiz);component.y1 = Math.ceil(siz.Ysiz / component.YRsiz);component.width = component.x1 - component.x0;component.height = component.y1 - component.y0;}function calculateTileGrids(context,components){var siz=context.SIZ;var tile,tiles=[];var numXtiles=Math.ceil((siz.Xsiz - siz.XTOsiz) / siz.XTsiz);var numYtiles=Math.ceil((siz.Ysiz - siz.YTOsiz) / siz.YTsiz);for(var q=0;q < numYtiles;q++) {for(var p=0;p < numXtiles;p++) {tile = {};tile.tx0 = Math.max(siz.XTOsiz + p * siz.XTsiz,siz.XOsiz);tile.ty0 = Math.max(siz.YTOsiz + q * siz.YTsiz,siz.YOsiz);tile.tx1 = Math.min(siz.XTOsiz + (p + 1) * siz.XTsiz,siz.Xsiz);tile.ty1 = Math.min(siz.YTOsiz + (q + 1) * siz.YTsiz,siz.Ysiz);tile.width = tile.tx1 - tile.tx0;tile.height = tile.ty1 - tile.ty0;tile.components = [];tiles.push(tile);}}context.tiles = tiles;var componentsCount=siz.Csiz;for(var i=0,ii=componentsCount;i < ii;i++) {var component=components[i];for(var j=0,jj=tiles.length;j < jj;j++) {var tileComponent={};tile = tiles[j];tileComponent.tcx0 = Math.ceil(tile.tx0 / component.XRsiz);tileComponent.tcy0 = Math.ceil(tile.ty0 / component.YRsiz);tileComponent.tcx1 = Math.ceil(tile.tx1 / component.XRsiz);tileComponent.tcy1 = Math.ceil(tile.ty1 / component.YRsiz);tileComponent.width = tileComponent.tcx1 - tileComponent.tcx0;tileComponent.height = tileComponent.tcy1 - tileComponent.tcy0;tile.components[i] = tileComponent;}}}function getBlocksDimensions(context,component,r){var codOrCoc=component.codingStyleParameters;var result={};if(!codOrCoc.entropyCoderWithCustomPrecincts){result.PPx = 15;result.PPy = 15;}else {result.PPx = codOrCoc.precinctsSizes[r].PPx;result.PPy = codOrCoc.precinctsSizes[r].PPy;}result.xcb_ = r > 0?Math.min(codOrCoc.xcb,result.PPx - 1):Math.min(codOrCoc.xcb,result.PPx);result.ycb_ = r > 0?Math.min(codOrCoc.ycb,result.PPy - 1):Math.min(codOrCoc.ycb,result.PPy);return result;}function buildPrecincts(context,resolution,dimensions){var precinctWidth=1 << dimensions.PPx;var precinctHeight=1 << dimensions.PPy;var isZeroRes=resolution.resLevel === 0;var precinctWidthInSubband=1 << dimensions.PPx + (isZeroRes?0:-1);var precinctHeightInSubband=1 << dimensions.PPy + (isZeroRes?0:-1);var numprecinctswide=resolution.trx1 > resolution.trx0?Math.ceil(resolution.trx1 / precinctWidth) - Math.floor(resolution.trx0 / precinctWidth):0;var numprecinctshigh=resolution.try1 > resolution.try0?Math.ceil(resolution.try1 / precinctHeight) - Math.floor(resolution.try0 / precinctHeight):0;var numprecincts=numprecinctswide * numprecinctshigh;resolution.precinctParameters = {precinctWidth:precinctWidth,precinctHeight:precinctHeight,numprecinctswide:numprecinctswide,numprecinctshigh:numprecinctshigh,numprecincts:numprecincts,precinctWidthInSubband:precinctWidthInSubband,precinctHeightInSubband:precinctHeightInSubband};}function buildCodeblocks(context,subband,dimensions){var xcb_=dimensions.xcb_;var ycb_=dimensions.ycb_;var codeblockWidth=1 << xcb_;var codeblockHeight=1 << ycb_;var cbx0=subband.tbx0 >> xcb_;var cby0=subband.tby0 >> ycb_;var cbx1=subband.tbx1 + codeblockWidth - 1 >> xcb_;var cby1=subband.tby1 + codeblockHeight - 1 >> ycb_;var precinctParameters=subband.resolution.precinctParameters;var codeblocks=[];var precincts=[];var i,j,codeblock,precinctNumber;for(j = cby0;j < cby1;j++) {for(i = cbx0;i < cbx1;i++) {codeblock = {cbx:i,cby:j,tbx0:codeblockWidth * i,tby0:codeblockHeight * j,tbx1:codeblockWidth * (i + 1),tby1:codeblockHeight * (j + 1)};codeblock.tbx0_ = Math.max(subband.tbx0,codeblock.tbx0);codeblock.tby0_ = Math.max(subband.tby0,codeblock.tby0);codeblock.tbx1_ = Math.min(subband.tbx1,codeblock.tbx1);codeblock.tby1_ = Math.min(subband.tby1,codeblock.tby1);var pi=Math.floor((codeblock.tbx0_ - subband.tbx0) / precinctParameters.precinctWidthInSubband);var pj=Math.floor((codeblock.tby0_ - subband.tby0) / precinctParameters.precinctHeightInSubband);precinctNumber = pi + pj * precinctParameters.numprecinctswide;codeblock.precinctNumber = precinctNumber;codeblock.subbandType = subband.type;codeblock.Lblock = 3;if(codeblock.tbx1_ <= codeblock.tbx0_ || codeblock.tby1_ <= codeblock.tby0_){continue;}codeblocks.push(codeblock);var precinct=precincts[precinctNumber];if(precinct !== undefined){if(i < precinct.cbxMin){precinct.cbxMin = i;}else if(i > precinct.cbxMax){precinct.cbxMax = i;}if(j < precinct.cbyMin){precinct.cbxMin = j;}else if(j > precinct.cbyMax){precinct.cbyMax = j;}}else {precincts[precinctNumber] = precinct = {cbxMin:i,cbyMin:j,cbxMax:i,cbyMax:j};}codeblock.precinct = precinct;}}subband.codeblockParameters = {codeblockWidth:xcb_,codeblockHeight:ycb_,numcodeblockwide:cbx1 - cbx0 + 1,numcodeblockhigh:cby1 - cby0 + 1};subband.codeblocks = codeblocks;subband.precincts = precincts;}function createPacket(resolution,precinctNumber,layerNumber){var precinctCodeblocks=[];var subbands=resolution.subbands;for(var i=0,ii=subbands.length;i < ii;i++) {var subband=subbands[i];var codeblocks=subband.codeblocks;for(var j=0,jj=codeblocks.length;j < jj;j++) {var codeblock=codeblocks[j];if(codeblock.precinctNumber !== precinctNumber){continue;}precinctCodeblocks.push(codeblock);}}return {layerNumber:layerNumber,codeblocks:precinctCodeblocks};}function LayerResolutionComponentPositionIterator(context){var siz=context.SIZ;var tileIndex=context.currentTile.index;var tile=context.tiles[tileIndex];var layersCount=tile.codingStyleDefaultParameters.layersCount;var componentsCount=siz.Csiz;var maxDecompositionLevelsCount=0;for(var q=0;q < componentsCount;q++) {maxDecompositionLevelsCount = Math.max(maxDecompositionLevelsCount,tile.components[q].codingStyleParameters.decompositionLevelsCount);}var l=0,r=0,i=0,k=0;this.nextPacket = function JpxImage_nextPacket(){for(;l < layersCount;l++) {for(;r <= maxDecompositionLevelsCount;r++) {for(;i < componentsCount;i++) {var component=tile.components[i];if(r > component.codingStyleParameters.decompositionLevelsCount){continue;}var resolution=component.resolutions[r];var numprecincts=resolution.precinctParameters.numprecincts;for(;k < numprecincts;) {var packet=createPacket(resolution,k,l);k++;return packet;}k = 0;}i = 0;}r = 0;}};}function ResolutionLayerComponentPositionIterator(context){var siz=context.SIZ;var tileIndex=context.currentTile.index;var tile=context.tiles[tileIndex];var layersCount=tile.codingStyleDefaultParameters.layersCount;var componentsCount=siz.Csiz;var maxDecompositionLevelsCount=0;for(var q=0;q < componentsCount;q++) {maxDecompositionLevelsCount = Math.max(maxDecompositionLevelsCount,tile.components[q].codingStyleParameters.decompositionLevelsCount);}var r=0,l=0,i=0,k=0;this.nextPacket = function JpxImage_nextPacket(){for(;r <= maxDecompositionLevelsCount;r++) {for(;l < layersCount;l++) {for(;i < componentsCount;i++) {var component=tile.components[i];if(r > component.codingStyleParameters.decompositionLevelsCount){continue;}var resolution=component.resolutions[r];var numprecincts=resolution.precinctParameters.numprecincts;for(;k < numprecincts;) {var packet=createPacket(resolution,k,l);k++;return packet;}k = 0;}i = 0;}l = 0;}};}function ResolutionPositionComponentLayerIterator(context){var siz=context.SIZ;var tileIndex=context.currentTile.index;var tile=context.tiles[tileIndex];var layersCount=tile.codingStyleDefaultParameters.layersCount;var componentsCount=siz.Csiz;var l,r,c,p;var maxDecompositionLevelsCount=0;for(c = 0;c < componentsCount;c++) {var component=tile.components[c];maxDecompositionLevelsCount = Math.max(maxDecompositionLevelsCount,component.codingStyleParameters.decompositionLevelsCount);}var maxNumPrecinctsInLevel=new Int32Array(maxDecompositionLevelsCount + 1);for(r = 0;r <= maxDecompositionLevelsCount;++r) {var maxNumPrecincts=0;for(c = 0;c < componentsCount;++c) {var resolutions=tile.components[c].resolutions;if(r < resolutions.length){maxNumPrecincts = Math.max(maxNumPrecincts,resolutions[r].precinctParameters.numprecincts);}}maxNumPrecinctsInLevel[r] = maxNumPrecincts;}l = 0;r = 0;c = 0;p = 0;this.nextPacket = function JpxImage_nextPacket(){for(;r <= maxDecompositionLevelsCount;r++) {for(;p < maxNumPrecinctsInLevel[r];p++) {for(;c < componentsCount;c++) {var component=tile.components[c];if(r > component.codingStyleParameters.decompositionLevelsCount){continue;}var resolution=component.resolutions[r];var numprecincts=resolution.precinctParameters.numprecincts;if(p >= numprecincts){continue;}for(;l < layersCount;) {var packet=createPacket(resolution,p,l);l++;return packet;}l = 0;}c = 0;}p = 0;}};}function PositionComponentResolutionLayerIterator(context){var siz=context.SIZ;var tileIndex=context.currentTile.index;var tile=context.tiles[tileIndex];var layersCount=tile.codingStyleDefaultParameters.layersCount;var componentsCount=siz.Csiz;var precinctsSizes=getPrecinctSizesInImageScale(tile);var precinctsIterationSizes=precinctsSizes;var l=0,r=0,c=0,px=0,py=0;this.nextPacket = function JpxImage_nextPacket(){for(;py < precinctsIterationSizes.maxNumHigh;py++) {for(;px < precinctsIterationSizes.maxNumWide;px++) {for(;c < componentsCount;c++) {var component=tile.components[c];var decompositionLevelsCount=component.codingStyleParameters.decompositionLevelsCount;for(;r <= decompositionLevelsCount;r++) {var resolution=component.resolutions[r];var sizeInImageScale=precinctsSizes.components[c].resolutions[r];var k=getPrecinctIndexIfExist(px,py,sizeInImageScale,precinctsIterationSizes,resolution);if(k === null){continue;}for(;l < layersCount;) {var packet=createPacket(resolution,k,l);l++;return packet;}l = 0;}r = 0;}c = 0;}px = 0;}};}function ComponentPositionResolutionLayerIterator(context){var siz=context.SIZ;var tileIndex=context.currentTile.index;var tile=context.tiles[tileIndex];var layersCount=tile.codingStyleDefaultParameters.layersCount;var componentsCount=siz.Csiz;var precinctsSizes=getPrecinctSizesInImageScale(tile);var l=0,r=0,c=0,px=0,py=0;this.nextPacket = function JpxImage_nextPacket(){for(;c < componentsCount;++c) {var component=tile.components[c];var precinctsIterationSizes=precinctsSizes.components[c];var decompositionLevelsCount=component.codingStyleParameters.decompositionLevelsCount;for(;py < precinctsIterationSizes.maxNumHigh;py++) {for(;px < precinctsIterationSizes.maxNumWide;px++) {for(;r <= decompositionLevelsCount;r++) {var resolution=component.resolutions[r];var sizeInImageScale=precinctsIterationSizes.resolutions[r];var k=getPrecinctIndexIfExist(px,py,sizeInImageScale,precinctsIterationSizes,resolution);if(k === null){continue;}for(;l < layersCount;) {var packet=createPacket(resolution,k,l);l++;return packet;}l = 0;}r = 0;}px = 0;}py = 0;}};}function getPrecinctIndexIfExist(pxIndex,pyIndex,sizeInImageScale,precinctIterationSizes,resolution){var posX=pxIndex * precinctIterationSizes.minWidth;var posY=pyIndex * precinctIterationSizes.minHeight;if(posX % sizeInImageScale.width !== 0 || posY % sizeInImageScale.height !== 0){return null;}var startPrecinctRowIndex=posY / sizeInImageScale.width * resolution.precinctParameters.numprecinctswide;return posX / sizeInImageScale.height + startPrecinctRowIndex;}function getPrecinctSizesInImageScale(tile){var componentsCount=tile.components.length;var minWidth=Number.MAX_VALUE;var minHeight=Number.MAX_VALUE;var maxNumWide=0;var maxNumHigh=0;var sizePerComponent=new Array(componentsCount);for(var c=0;c < componentsCount;c++) {var component=tile.components[c];var decompositionLevelsCount=component.codingStyleParameters.decompositionLevelsCount;var sizePerResolution=new Array(decompositionLevelsCount + 1);var minWidthCurrentComponent=Number.MAX_VALUE;var minHeightCurrentComponent=Number.MAX_VALUE;var maxNumWideCurrentComponent=0;var maxNumHighCurrentComponent=0;var scale=1;for(var r=decompositionLevelsCount;r >= 0;--r) {var resolution=component.resolutions[r];var widthCurrentResolution=scale * resolution.precinctParameters.precinctWidth;var heightCurrentResolution=scale * resolution.precinctParameters.precinctHeight;minWidthCurrentComponent = Math.min(minWidthCurrentComponent,widthCurrentResolution);minHeightCurrentComponent = Math.min(minHeightCurrentComponent,heightCurrentResolution);maxNumWideCurrentComponent = Math.max(maxNumWideCurrentComponent,resolution.precinctParameters.numprecinctswide);maxNumHighCurrentComponent = Math.max(maxNumHighCurrentComponent,resolution.precinctParameters.numprecinctshigh);sizePerResolution[r] = {width:widthCurrentResolution,height:heightCurrentResolution};scale <<= 1;}minWidth = Math.min(minWidth,minWidthCurrentComponent);minHeight = Math.min(minHeight,minHeightCurrentComponent);maxNumWide = Math.max(maxNumWide,maxNumWideCurrentComponent);maxNumHigh = Math.max(maxNumHigh,maxNumHighCurrentComponent);sizePerComponent[c] = {resolutions:sizePerResolution,minWidth:minWidthCurrentComponent,minHeight:minHeightCurrentComponent,maxNumWide:maxNumWideCurrentComponent,maxNumHigh:maxNumHighCurrentComponent};}return {components:sizePerComponent,minWidth:minWidth,minHeight:minHeight,maxNumWide:maxNumWide,maxNumHigh:maxNumHigh};}function buildPackets(context){var siz=context.SIZ;var tileIndex=context.currentTile.index;var tile=context.tiles[tileIndex];var componentsCount=siz.Csiz;for(var c=0;c < componentsCount;c++) {var component=tile.components[c];var decompositionLevelsCount=component.codingStyleParameters.decompositionLevelsCount;var resolutions=[];var subbands=[];for(var r=0;r <= decompositionLevelsCount;r++) {var blocksDimensions=getBlocksDimensions(context,component,r);var resolution={};var scale=1 << decompositionLevelsCount - r;resolution.trx0 = Math.ceil(component.tcx0 / scale);resolution.try0 = Math.ceil(component.tcy0 / scale);resolution.trx1 = Math.ceil(component.tcx1 / scale);resolution.try1 = Math.ceil(component.tcy1 / scale);resolution.resLevel = r;buildPrecincts(context,resolution,blocksDimensions);resolutions.push(resolution);var subband;if(r === 0){subband = {};subband.type = "LL";subband.tbx0 = Math.ceil(component.tcx0 / scale);subband.tby0 = Math.ceil(component.tcy0 / scale);subband.tbx1 = Math.ceil(component.tcx1 / scale);subband.tby1 = Math.ceil(component.tcy1 / scale);subband.resolution = resolution;buildCodeblocks(context,subband,blocksDimensions);subbands.push(subband);resolution.subbands = [subband];}else {var bscale=1 << decompositionLevelsCount - r + 1;var resolutionSubbands=[];subband = {};subband.type = "HL";subband.tbx0 = Math.ceil(component.tcx0 / bscale - 0.5);subband.tby0 = Math.ceil(component.tcy0 / bscale);subband.tbx1 = Math.ceil(component.tcx1 / bscale - 0.5);subband.tby1 = Math.ceil(component.tcy1 / bscale);subband.resolution = resolution;buildCodeblocks(context,subband,blocksDimensions);subbands.push(subband);resolutionSubbands.push(subband);subband = {};subband.type = "LH";subband.tbx0 = Math.ceil(component.tcx0 / bscale);subband.tby0 = Math.ceil(component.tcy0 / bscale - 0.5);subband.tbx1 = Math.ceil(component.tcx1 / bscale);subband.tby1 = Math.ceil(component.tcy1 / bscale - 0.5);subband.resolution = resolution;buildCodeblocks(context,subband,blocksDimensions);subbands.push(subband);resolutionSubbands.push(subband);subband = {};subband.type = "HH";subband.tbx0 = Math.ceil(component.tcx0 / bscale - 0.5);subband.tby0 = Math.ceil(component.tcy0 / bscale - 0.5);subband.tbx1 = Math.ceil(component.tcx1 / bscale - 0.5);subband.tby1 = Math.ceil(component.tcy1 / bscale - 0.5);subband.resolution = resolution;buildCodeblocks(context,subband,blocksDimensions);subbands.push(subband);resolutionSubbands.push(subband);resolution.subbands = resolutionSubbands;}}component.resolutions = resolutions;component.subbands = subbands;}var progressionOrder=tile.codingStyleDefaultParameters.progressionOrder;switch(progressionOrder){case 0:tile.packetsIterator = new LayerResolutionComponentPositionIterator(context);break;case 1:tile.packetsIterator = new ResolutionLayerComponentPositionIterator(context);break;case 2:tile.packetsIterator = new ResolutionPositionComponentLayerIterator(context);break;case 3:tile.packetsIterator = new PositionComponentResolutionLayerIterator(context);break;case 4:tile.packetsIterator = new ComponentPositionResolutionLayerIterator(context);break;default:throw new Error("JPX Error: Unsupported progression order " + progressionOrder);}}function parseTilePackets(context,data,offset,dataLength){var position=0;var buffer,bufferSize=0,skipNextBit=false;function readBits(count){while(bufferSize < count) {var b=data[offset + position];position++;if(skipNextBit){buffer = buffer << 7 | b;bufferSize += 7;skipNextBit = false;}else {buffer = buffer << 8 | b;bufferSize += 8;}if(b === 0xFF){skipNextBit = true;}}bufferSize -= count;return buffer >>> bufferSize & (1 << count) - 1;}function skipMarkerIfEqual(value){if(data[offset + position - 1] === 0xFF && data[offset + position] === value){skipBytes(1);return true;}else if(data[offset + position] === 0xFF && data[offset + position + 1] === value){skipBytes(2);return true;}return false;}function skipBytes(count){position += count;}function alignToByte(){bufferSize = 0;if(skipNextBit){position++;skipNextBit = false;}}function readCodingpasses(){if(readBits(1) === 0){return 1;}if(readBits(1) === 0){return 2;}var value=readBits(2);if(value < 3){return value + 3;}value = readBits(5);if(value < 31){return value + 6;}value = readBits(7);return value + 37;}var tileIndex=context.currentTile.index;var tile=context.tiles[tileIndex];var sopMarkerUsed=context.COD.sopMarkerUsed;var ephMarkerUsed=context.COD.ephMarkerUsed;var packetsIterator=tile.packetsIterator;while(position < dataLength) {alignToByte();if(sopMarkerUsed && skipMarkerIfEqual(0x91)){skipBytes(4);}var packet=packetsIterator.nextPacket();if(packet === undefined){return;}if(!readBits(1)){continue;}var layerNumber=packet.layerNumber;var queue=[],codeblock;for(var i=0,ii=packet.codeblocks.length;i < ii;i++) {codeblock = packet.codeblocks[i];var precinct=codeblock.precinct;var codeblockColumn=codeblock.cbx - precinct.cbxMin;var codeblockRow=codeblock.cby - precinct.cbyMin;var codeblockIncluded=false;var firstTimeInclusion=false;var valueReady;if(codeblock["included"] !== undefined){codeblockIncluded = !!readBits(1);}else {precinct = codeblock.precinct;var inclusionTree,zeroBitPlanesTree;if(precinct["inclusionTree"] !== undefined){inclusionTree = precinct.inclusionTree;}else {var width=precinct.cbxMax - precinct.cbxMin + 1;var height=precinct.cbyMax - precinct.cbyMin + 1;inclusionTree = new InclusionTree(width,height);zeroBitPlanesTree = new TagTree(width,height);precinct.inclusionTree = inclusionTree;precinct.zeroBitPlanesTree = zeroBitPlanesTree;}inclusionTree.reset(codeblockColumn,codeblockRow,layerNumber);while(true) {if(position >= data.length){return;}if(inclusionTree.isAboveThreshold()){break;}if(inclusionTree.isKnown()){inclusionTree.nextLevel();continue;}if(readBits(1)){inclusionTree.setKnown();if(inclusionTree.isLeaf()){codeblock.included = true;codeblockIncluded = firstTimeInclusion = true;break;}else {inclusionTree.nextLevel();}}else {inclusionTree.incrementValue();}}}if(!codeblockIncluded){continue;}if(firstTimeInclusion){zeroBitPlanesTree = precinct.zeroBitPlanesTree;zeroBitPlanesTree.reset(codeblockColumn,codeblockRow);while(true) {if(position >= data.length){return;}if(readBits(1)){valueReady = !zeroBitPlanesTree.nextLevel();if(valueReady){break;}}else {zeroBitPlanesTree.incrementValue();}}codeblock.zeroBitPlanes = zeroBitPlanesTree.value;}var codingpasses=readCodingpasses();while(readBits(1)) {codeblock.Lblock++;}var codingpassesLog2=log2(codingpasses);var bits=(codingpasses < 1 << codingpassesLog2?codingpassesLog2 - 1:codingpassesLog2) + codeblock.Lblock;var codedDataLength=readBits(bits);queue.push({codeblock:codeblock,codingpasses:codingpasses,dataLength:codedDataLength});}alignToByte();if(ephMarkerUsed){skipMarkerIfEqual(0x92);}while(queue.length > 0) {var packetItem=queue.shift();codeblock = packetItem.codeblock;if(codeblock["data"] === undefined){codeblock.data = [];}codeblock.data.push({data:data,start:offset + position,end:offset + position + packetItem.dataLength,codingpasses:packetItem.codingpasses});position += packetItem.dataLength;}}return position;}function copyCoefficients(coefficients,levelWidth,levelHeight,subband,delta,mb,reversible,segmentationSymbolUsed){var x0=subband.tbx0;var y0=subband.tby0;var width=subband.tbx1 - subband.tbx0;var codeblocks=subband.codeblocks;var right=subband.type.charAt(0) === "H"?1:0;var bottom=subband.type.charAt(1) === "H"?levelWidth:0;for(var i=0,ii=codeblocks.length;i < ii;++i) {var codeblock=codeblocks[i];var blockWidth=codeblock.tbx1_ - codeblock.tbx0_;var blockHeight=codeblock.tby1_ - codeblock.tby0_;if(blockWidth === 0 || blockHeight === 0){continue;}if(codeblock["data"] === undefined){continue;}var bitModel,currentCodingpassType;bitModel = new BitModel(blockWidth,blockHeight,codeblock.subbandType,codeblock.zeroBitPlanes,mb);currentCodingpassType = 2;var data=codeblock.data,totalLength=0,codingpasses=0;var j,jj,dataItem;for(j = 0,jj = data.length;j < jj;j++) {dataItem = data[j];totalLength += dataItem.end - dataItem.start;codingpasses += dataItem.codingpasses;}var encodedData=new Int16Array(totalLength);var position=0;for(j = 0,jj = data.length;j < jj;j++) {dataItem = data[j];var chunk=dataItem.data.subarray(dataItem.start,dataItem.end);encodedData.set(chunk,position);position += chunk.length;}var decoder=new ArithmeticDecoder(encodedData,0,totalLength);bitModel.setDecoder(decoder);for(j = 0;j < codingpasses;j++) {switch(currentCodingpassType){case 0:bitModel.runSignificancePropogationPass();break;case 1:bitModel.runMagnitudeRefinementPass();break;case 2:bitModel.runCleanupPass();if(segmentationSymbolUsed){bitModel.checkSegmentationSymbol();}break;}currentCodingpassType = (currentCodingpassType + 1) % 3;}var offset=codeblock.tbx0_ - x0 + (codeblock.tby0_ - y0) * width;var sign=bitModel.coefficentsSign;var magnitude=bitModel.coefficentsMagnitude;var bitsDecoded=bitModel.bitsDecoded;var magnitudeCorrection=reversible?0:0.5;var k,n,nb;position = 0;var interleave=subband.type !== "LL";for(j = 0;j < blockHeight;j++) {var row=offset / width | 0;var levelOffset=2 * row * (levelWidth - width) + right + bottom;for(k = 0;k < blockWidth;k++) {n = magnitude[position];if(n !== 0){n = (n + magnitudeCorrection) * delta;if(sign[position] !== 0){n = -n;}nb = bitsDecoded[position];var pos=interleave?levelOffset + (offset << 1):offset;if(reversible && nb >= mb){coefficients[pos] = n;}else {coefficients[pos] = n * (1 << mb - nb);}}offset++;position++;}offset += width - blockWidth;}}}function transformTile(context,tile,c){var component=tile.components[c];var codingStyleParameters=component.codingStyleParameters;var quantizationParameters=component.quantizationParameters;var decompositionLevelsCount=codingStyleParameters.decompositionLevelsCount;var spqcds=quantizationParameters.SPqcds;var scalarExpounded=quantizationParameters.scalarExpounded;var guardBits=quantizationParameters.guardBits;var segmentationSymbolUsed=codingStyleParameters.segmentationSymbolUsed;var precision=context.components[c].precision;var reversible=codingStyleParameters.reversibleTransformation;var transform=reversible?new ReversibleTransform():new IrreversibleTransform();var subbandCoefficients=[];var b=0;for(var i=0;i <= decompositionLevelsCount;i++) {var resolution=component.resolutions[i];var width=resolution.trx1 - resolution.trx0;var height=resolution.try1 - resolution.try0;var coefficients=new Float32Array(width * height);for(var j=0,jj=resolution.subbands.length;j < jj;j++) {var mu,epsilon;if(!scalarExpounded){mu = spqcds[0].mu;epsilon = spqcds[0].epsilon + (i > 0?1 - i:0);}else {mu = spqcds[b].mu;epsilon = spqcds[b].epsilon;b++;}var subband=resolution.subbands[j];var gainLog2=SubbandsGainLog2[subband.type];var delta=reversible?1:Math.pow(2,precision + gainLog2 - epsilon) * (1 + mu / 2048);var mb=guardBits + epsilon - 1;copyCoefficients(coefficients,width,height,subband,delta,mb,reversible,segmentationSymbolUsed);}subbandCoefficients.push({width:width,height:height,items:coefficients});}var result=transform.calculate(subbandCoefficients,component.tcx0,component.tcy0);return {left:component.tcx0,top:component.tcy0,width:result.width,height:result.height,items:result.items};}function transformComponents(context){var siz=context.SIZ;var components=context.components;var componentsCount=siz.Csiz;var resultImages=[];for(var i=0,ii=context.tiles.length;i < ii;i++) {var tile=context.tiles[i];var transformedTiles=[];var c;for(c = 0;c < componentsCount;c++) {transformedTiles[c] = transformTile(context,tile,c);}var tile0=transformedTiles[0];var isSigned=components[0].isSigned;if(isSigned){var out=new Int16Array(tile0.items.length * componentsCount);}else {var out=new Uint16Array(tile0.items.length * componentsCount);}var result={left:tile0.left,top:tile0.top,width:tile0.width,height:tile0.height,items:out};var shift,offset,max,min,maxK;var pos=0,j,jj,y0,y1,y2,r,g,b,k,val;if(tile.codingStyleDefaultParameters.multipleComponentTransform){var fourComponents=componentsCount === 4;var y0items=transformedTiles[0].items;var y1items=transformedTiles[1].items;var y2items=transformedTiles[2].items;var y3items=fourComponents?transformedTiles[3].items:null;shift = components[0].precision - 8;offset = (128 << shift) + 0.5;max = 255 * (1 << shift);maxK = max * 0.5;min = -maxK;var component0=tile.components[0];var alpha01=componentsCount - 3;jj = y0items.length;if(!component0.codingStyleParameters.reversibleTransformation){for(j = 0;j < jj;j++,pos += alpha01) {y0 = y0items[j] + offset;y1 = y1items[j];y2 = y2items[j];r = y0 + 1.402 * y2;g = y0 - 0.34413 * y1 - 0.71414 * y2;b = y0 + 1.772 * y1;out[pos++] = r <= 0?0:r >= max?255:r >> shift;out[pos++] = g <= 0?0:g >= max?255:g >> shift;out[pos++] = b <= 0?0:b >= max?255:b >> shift;}}else {for(j = 0;j < jj;j++,pos += alpha01) {y0 = y0items[j] + offset;y1 = y1items[j];y2 = y2items[j];g = y0 - (y2 + y1 >> 2);r = g + y2;b = g + y1;out[pos++] = r <= 0?0:r >= max?255:r >> shift;out[pos++] = g <= 0?0:g >= max?255:g >> shift;out[pos++] = b <= 0?0:b >= max?255:b >> shift;}}if(fourComponents){for(j = 0,pos = 3;j < jj;j++,pos += 4) {k = y3items[j];out[pos] = k <= min?0:k >= maxK?255:k + offset >> shift;}}}else {for(c = 0;c < componentsCount;c++) {if(components[c].precision === 8){var items=transformedTiles[c].items;shift = components[c].precision - 8;offset = (128 << shift) + 0.5;max = 127.5 * (1 << shift);min = -max;for(pos = c,j = 0,jj = items.length;j < jj;j++) {val = items[j];out[pos] = val <= min?0:val >= max?255:val + offset >> shift;pos += componentsCount;}}else {var isSigned=components[c].isSigned;var items=transformedTiles[c].items;if(isSigned){for(pos = c,j = 0,jj = items.length;j < jj;j++) {out[pos] = items[j];pos += componentsCount;}}else {shift = components[c].precision - 8;offset = (128 << shift) + 0.5;var precisionMax=Math.pow(2,components[c].precision) - 1;for(pos = c,j = 0,jj = items.length;j < jj;j++) {val = items[j];out[pos] = Math.max(Math.min(val + offset,precisionMax),0);pos += componentsCount;}}}}}resultImages.push(result);}return resultImages;}function initializeTile(context,tileIndex){var siz=context.SIZ;var componentsCount=siz.Csiz;var tile=context.tiles[tileIndex];for(var c=0;c < componentsCount;c++) {var component=tile.components[c];var qcdOrQcc=context.currentTile.QCC[c] !== undefined?context.currentTile.QCC[c]:context.currentTile.QCD;component.quantizationParameters = qcdOrQcc;var codOrCoc=context.currentTile.COC[c] !== undefined?context.currentTile.COC[c]:context.currentTile.COD;component.codingStyleParameters = codOrCoc;}tile.codingStyleDefaultParameters = context.currentTile.COD;}var TagTree=(function TagTreeClosure(){function TagTree(width,height){var levelsLength=log2(Math.max(width,height)) + 1;this.levels = [];for(var i=0;i < levelsLength;i++) {var level={width:width,height:height,items:[]};this.levels.push(level);width = Math.ceil(width / 2);height = Math.ceil(height / 2);}}TagTree.prototype = {reset:function TagTree_reset(i,j){var currentLevel=0,value=0,level;while(currentLevel < this.levels.length) {level = this.levels[currentLevel];var index=i + j * level.width;if(level.items[index] !== undefined){value = level.items[index];break;}level.index = index;i >>= 1;j >>= 1;currentLevel++;}currentLevel--;level = this.levels[currentLevel];level.items[level.index] = value;this.currentLevel = currentLevel;delete this.value;},incrementValue:function TagTree_incrementValue(){var level=this.levels[this.currentLevel];level.items[level.index]++;},nextLevel:function TagTree_nextLevel(){var currentLevel=this.currentLevel;var level=this.levels[currentLevel];var value=level.items[level.index];currentLevel--;if(currentLevel < 0){this.value = value;return false;}this.currentLevel = currentLevel;level = this.levels[currentLevel];level.items[level.index] = value;return true;}};return TagTree;})();var InclusionTree=(function InclusionTreeClosure(){function InclusionTree(width,height){var levelsLength=log2(Math.max(width,height)) + 1;this.levels = [];for(var i=0;i < levelsLength;i++) {var items=new Uint8Array(width * height);var status=new Uint8Array(width * height);for(var j=0,jj=items.length;j < jj;j++) {items[j] = 0;status[j] = 0;}var level={width:width,height:height,items:items,status:status};this.levels.push(level);width = Math.ceil(width / 2);height = Math.ceil(height / 2);}}InclusionTree.prototype = {reset:function InclusionTree_reset(i,j,stopValue){this.currentStopValue = stopValue;var currentLevel=0;while(currentLevel < this.levels.length) {var level=this.levels[currentLevel];var index=i + j * level.width;level.index = index;i >>= 1;j >>= 1;currentLevel++;}this.currentLevel = this.levels.length - 1;this.minValue = this.levels[this.currentLevel].items[0];return;},incrementValue:function InclusionTree_incrementValue(){var level=this.levels[this.currentLevel];level.items[level.index] = level.items[level.index] + 1;if(level.items[level.index] > this.minValue){this.minValue = level.items[level.index];}},nextLevel:function InclusionTree_nextLevel(){var currentLevel=this.currentLevel;currentLevel--;if(currentLevel < 0){return false;}else {this.currentLevel = currentLevel;var level=this.levels[currentLevel];if(level.items[level.index] < this.minValue){level.items[level.index] = this.minValue;}else if(level.items[level.index] > this.minValue){this.minValue = level.items[level.index];}return true;}},isLeaf:function InclusionTree_isLeaf(){return this.currentLevel === 0;},isAboveThreshold:function InclusionTree_isAboveThreshold(){var levelindex=this.currentLevel;var level=this.levels[levelindex];return level.items[level.index] > this.currentStopValue;},isKnown:function InclusionTree_isKnown(){var levelindex=this.currentLevel;var level=this.levels[levelindex];return level.status[level.index] > 0;},setKnown:function InclusionTree_setKnown(){var levelindex=this.currentLevel;var level=this.levels[levelindex];level.status[level.index] = 1;return;}};return InclusionTree;})();var BitModel=(function BitModelClosure(){var UNIFORM_CONTEXT=17;var RUNLENGTH_CONTEXT=18;var LLAndLHContextsLabel=new Uint8Array([0,5,8,0,3,7,8,0,4,7,8,0,0,0,0,0,1,6,8,0,3,7,8,0,4,7,8,0,0,0,0,0,2,6,8,0,3,7,8,0,4,7,8,0,0,0,0,0,2,6,8,0,3,7,8,0,4,7,8,0,0,0,0,0,2,6,8,0,3,7,8,0,4,7,8]);var HLContextLabel=new Uint8Array([0,3,4,0,5,7,7,0,8,8,8,0,0,0,0,0,1,3,4,0,6,7,7,0,8,8,8,0,0,0,0,0,2,3,4,0,6,7,7,0,8,8,8,0,0,0,0,0,2,3,4,0,6,7,7,0,8,8,8,0,0,0,0,0,2,3,4,0,6,7,7,0,8,8,8]);var HHContextLabel=new Uint8Array([0,1,2,0,1,2,2,0,2,2,2,0,0,0,0,0,3,4,5,0,4,5,5,0,5,5,5,0,0,0,0,0,6,7,7,0,7,7,7,0,7,7,7,0,0,0,0,0,8,8,8,0,8,8,8,0,8,8,8,0,0,0,0,0,8,8,8,0,8,8,8,0,8,8,8]);function BitModel(width,height,subband,zeroBitPlanes,mb){this.width = width;this.height = height;this.contextLabelTable = subband === "HH"?HHContextLabel:subband === "HL"?HLContextLabel:LLAndLHContextsLabel;var coefficientCount=width * height;this.neighborsSignificance = new Uint8Array(coefficientCount);this.coefficentsSign = new Uint8Array(coefficientCount);this.coefficentsMagnitude = mb > 14?new Uint32Array(coefficientCount):mb > 6?new Uint16Array(coefficientCount):new Uint8Array(coefficientCount);this.processingFlags = new Uint8Array(coefficientCount);var bitsDecoded=new Uint8Array(coefficientCount);if(zeroBitPlanes !== 0){for(var i=0;i < coefficientCount;i++) {bitsDecoded[i] = zeroBitPlanes;}}this.bitsDecoded = bitsDecoded;this.reset();}BitModel.prototype = {setDecoder:function BitModel_setDecoder(decoder){this.decoder = decoder;},reset:function BitModel_reset(){this.contexts = new Int8Array(19);this.contexts[0] = 4 << 1 | 0;this.contexts[UNIFORM_CONTEXT] = 46 << 1 | 0;this.contexts[RUNLENGTH_CONTEXT] = 3 << 1 | 0;},setNeighborsSignificance:function BitModel_setNeighborsSignificance(row,column,index){var neighborsSignificance=this.neighborsSignificance;var width=this.width,height=this.height;var left=column > 0;var right=column + 1 < width;var i;if(row > 0){i = index - width;if(left){neighborsSignificance[i - 1] += 0x10;}if(right){neighborsSignificance[i + 1] += 0x10;}neighborsSignificance[i] += 0x04;}if(row + 1 < height){i = index + width;if(left){neighborsSignificance[i - 1] += 0x10;}if(right){neighborsSignificance[i + 1] += 0x10;}neighborsSignificance[i] += 0x04;}if(left){neighborsSignificance[index - 1] += 0x01;}if(right){neighborsSignificance[index + 1] += 0x01;}neighborsSignificance[index] |= 0x80;},runSignificancePropogationPass:function BitModel_runSignificancePropogationPass(){var decoder=this.decoder;var width=this.width,height=this.height;var coefficentsMagnitude=this.coefficentsMagnitude;var coefficentsSign=this.coefficentsSign;var neighborsSignificance=this.neighborsSignificance;var processingFlags=this.processingFlags;var contexts=this.contexts;var labels=this.contextLabelTable;var bitsDecoded=this.bitsDecoded;var processedInverseMask=~1;var processedMask=1;var firstMagnitudeBitMask=2;for(var i0=0;i0 < height;i0 += 4) {for(var j=0;j < width;j++) {var index=i0 * width + j;for(var i1=0;i1 < 4;i1++,index += width) {var i=i0 + i1;if(i >= height){break;}processingFlags[index] &= processedInverseMask;if(coefficentsMagnitude[index] || !neighborsSignificance[index]){continue;}var contextLabel=labels[neighborsSignificance[index]];var decision=decoder.readBit(contexts,contextLabel);if(decision){var sign=this.decodeSignBit(i,j,index);coefficentsSign[index] = sign;coefficentsMagnitude[index] = 1;this.setNeighborsSignificance(i,j,index);processingFlags[index] |= firstMagnitudeBitMask;}bitsDecoded[index]++;processingFlags[index] |= processedMask;}}}},decodeSignBit:function BitModel_decodeSignBit(row,column,index){var width=this.width,height=this.height;var coefficentsMagnitude=this.coefficentsMagnitude;var coefficentsSign=this.coefficentsSign;var contribution,sign0,sign1,significance1;var contextLabel,decoded;significance1 = column > 0 && coefficentsMagnitude[index - 1] !== 0;if(column + 1 < width && coefficentsMagnitude[index + 1] !== 0){sign1 = coefficentsSign[index + 1];if(significance1){sign0 = coefficentsSign[index - 1];contribution = 1 - sign1 - sign0;}else {contribution = 1 - sign1 - sign1;}}else if(significance1){sign0 = coefficentsSign[index - 1];contribution = 1 - sign0 - sign0;}else {contribution = 0;}var horizontalContribution=3 * contribution;significance1 = row > 0 && coefficentsMagnitude[index - width] !== 0;if(row + 1 < height && coefficentsMagnitude[index + width] !== 0){sign1 = coefficentsSign[index + width];if(significance1){sign0 = coefficentsSign[index - width];contribution = 1 - sign1 - sign0 + horizontalContribution;}else {contribution = 1 - sign1 - sign1 + horizontalContribution;}}else if(significance1){sign0 = coefficentsSign[index - width];contribution = 1 - sign0 - sign0 + horizontalContribution;}else {contribution = horizontalContribution;}if(contribution >= 0){contextLabel = 9 + contribution;decoded = this.decoder.readBit(this.contexts,contextLabel);}else {contextLabel = 9 - contribution;decoded = this.decoder.readBit(this.contexts,contextLabel) ^ 1;}return decoded;},runMagnitudeRefinementPass:function BitModel_runMagnitudeRefinementPass(){var decoder=this.decoder;var width=this.width,height=this.height;var coefficentsMagnitude=this.coefficentsMagnitude;var neighborsSignificance=this.neighborsSignificance;var contexts=this.contexts;var bitsDecoded=this.bitsDecoded;var processingFlags=this.processingFlags;var processedMask=1;var firstMagnitudeBitMask=2;var length=width * height;var width4=width * 4;for(var index0=0,indexNext;index0 < length;index0 = indexNext) {indexNext = Math.min(length,index0 + width4);for(var j=0;j < width;j++) {for(var index=index0 + j;index < indexNext;index += width) {if(!coefficentsMagnitude[index] || (processingFlags[index] & processedMask) !== 0){continue;}var contextLabel=16;if((processingFlags[index] & firstMagnitudeBitMask) !== 0){processingFlags[index] ^= firstMagnitudeBitMask;var significance=neighborsSignificance[index] & 127;contextLabel = significance === 0?15:14;}var bit=decoder.readBit(contexts,contextLabel);coefficentsMagnitude[index] = coefficentsMagnitude[index] << 1 | bit;bitsDecoded[index]++;processingFlags[index] |= processedMask;}}}},runCleanupPass:function BitModel_runCleanupPass(){var decoder=this.decoder;var width=this.width,height=this.height;var neighborsSignificance=this.neighborsSignificance;var coefficentsMagnitude=this.coefficentsMagnitude;var coefficentsSign=this.coefficentsSign;var contexts=this.contexts;var labels=this.contextLabelTable;var bitsDecoded=this.bitsDecoded;var processingFlags=this.processingFlags;var processedMask=1;var firstMagnitudeBitMask=2;var oneRowDown=width;var twoRowsDown=width * 2;var threeRowsDown=width * 3;var iNext;for(var i0=0;i0 < height;i0 = iNext) {iNext = Math.min(i0 + 4,height);var indexBase=i0 * width;var checkAllEmpty=i0 + 3 < height;for(var j=0;j < width;j++) {var index0=indexBase + j;var allEmpty=checkAllEmpty && processingFlags[index0] === 0 && processingFlags[index0 + oneRowDown] === 0 && processingFlags[index0 + twoRowsDown] === 0 && processingFlags[index0 + threeRowsDown] === 0 && neighborsSignificance[index0] === 0 && neighborsSignificance[index0 + oneRowDown] === 0 && neighborsSignificance[index0 + twoRowsDown] === 0 && neighborsSignificance[index0 + threeRowsDown] === 0;var i1=0,index=index0;var i=i0,sign;if(allEmpty){var hasSignificantCoefficent=decoder.readBit(contexts,RUNLENGTH_CONTEXT);if(!hasSignificantCoefficent){bitsDecoded[index0]++;bitsDecoded[index0 + oneRowDown]++;bitsDecoded[index0 + twoRowsDown]++;bitsDecoded[index0 + threeRowsDown]++;continue;}i1 = decoder.readBit(contexts,UNIFORM_CONTEXT) << 1 | decoder.readBit(contexts,UNIFORM_CONTEXT);if(i1 !== 0){i = i0 + i1;index += i1 * width;}sign = this.decodeSignBit(i,j,index);coefficentsSign[index] = sign;coefficentsMagnitude[index] = 1;this.setNeighborsSignificance(i,j,index);processingFlags[index] |= firstMagnitudeBitMask;index = index0;for(var i2=i0;i2 <= i;i2++,index += width) {bitsDecoded[index]++;}i1++;}for(i = i0 + i1;i < iNext;i++,index += width) {if(coefficentsMagnitude[index] || (processingFlags[index] & processedMask) !== 0){continue;}var contextLabel=labels[neighborsSignificance[index]];var decision=decoder.readBit(contexts,contextLabel);if(decision === 1){sign = this.decodeSignBit(i,j,index);coefficentsSign[index] = sign;coefficentsMagnitude[index] = 1;this.setNeighborsSignificance(i,j,index);processingFlags[index] |= firstMagnitudeBitMask;}bitsDecoded[index]++;}}}},checkSegmentationSymbol:function BitModel_checkSegmentationSymbol(){var decoder=this.decoder;var contexts=this.contexts;var symbol=decoder.readBit(contexts,UNIFORM_CONTEXT) << 3 | decoder.readBit(contexts,UNIFORM_CONTEXT) << 2 | decoder.readBit(contexts,UNIFORM_CONTEXT) << 1 | decoder.readBit(contexts,UNIFORM_CONTEXT);if(symbol !== 0xA){throw new Error("JPX Error: Invalid segmentation symbol");}}};return BitModel;})();var Transform=(function TransformClosure(){function Transform(){}Transform.prototype.calculate = function transformCalculate(subbands,u0,v0){var ll=subbands[0];for(var i=1,ii=subbands.length;i < ii;i++) {ll = this.iterate(ll,subbands[i],u0,v0);}return ll;};Transform.prototype.extend = function extend(buffer,offset,size){var i1=offset - 1,j1=offset + 1;var i2=offset + size - 2,j2=offset + size;buffer[i1--] = buffer[j1++];buffer[j2++] = buffer[i2--];buffer[i1--] = buffer[j1++];buffer[j2++] = buffer[i2--];buffer[i1--] = buffer[j1++];buffer[j2++] = buffer[i2--];buffer[i1] = buffer[j1];buffer[j2] = buffer[i2];};Transform.prototype.iterate = function Transform_iterate(ll,hl_lh_hh,u0,v0){var llWidth=ll.width,llHeight=ll.height,llItems=ll.items;var width=hl_lh_hh.width;var height=hl_lh_hh.height;var items=hl_lh_hh.items;var i,j,k,l,u,v;for(k = 0,i = 0;i < llHeight;i++) {l = i * 2 * width;for(j = 0;j < llWidth;j++,k++,l += 2) {items[l] = llItems[k];}}llItems = ll.items = null;var bufferPadding=4;var rowBuffer=new Float32Array(width + 2 * bufferPadding);if(width === 1){if((u0 & 1) !== 0){for(v = 0,k = 0;v < height;v++,k += width) {items[k] *= 0.5;}}}else {for(v = 0,k = 0;v < height;v++,k += width) {rowBuffer.set(items.subarray(k,k + width),bufferPadding);this.extend(rowBuffer,bufferPadding,width);this.filter(rowBuffer,bufferPadding,width);items.set(rowBuffer.subarray(bufferPadding,bufferPadding + width),k);}}var numBuffers=16;var colBuffers=[];for(i = 0;i < numBuffers;i++) {colBuffers.push(new Float32Array(height + 2 * bufferPadding));}var b,currentBuffer=0;ll = bufferPadding + height;if(height === 1){if((v0 & 1) !== 0){for(u = 0;u < width;u++) {items[u] *= 0.5;}}}else {for(u = 0;u < width;u++) {if(currentBuffer === 0){numBuffers = Math.min(width - u,numBuffers);for(k = u,l = bufferPadding;l < ll;k += width,l++) {for(b = 0;b < numBuffers;b++) {colBuffers[b][l] = items[k + b];}}currentBuffer = numBuffers;}currentBuffer--;var buffer=colBuffers[currentBuffer];this.extend(buffer,bufferPadding,height);this.filter(buffer,bufferPadding,height);if(currentBuffer === 0){k = u - numBuffers + 1;for(l = bufferPadding;l < ll;k += width,l++) {for(b = 0;b < numBuffers;b++) {items[k + b] = colBuffers[b][l];}}}}}return {width:width,height:height,items:items};};return Transform;})();var IrreversibleTransform=(function IrreversibleTransformClosure(){function IrreversibleTransform(){Transform.call(this);}IrreversibleTransform.prototype = Object.create(Transform.prototype);IrreversibleTransform.prototype.filter = function irreversibleTransformFilter(x,offset,length){var len=length >> 1;offset = offset | 0;var j,n,current,next;var alpha=-1.586134342059924;var beta=-0.052980118572961;var gamma=0.882911075530934;var delta=0.443506852043971;var K=1.230174104914001;var K_=1 / K;j = offset - 3;for(n = len + 4;n--;j += 2) {x[j] *= K_;}j = offset - 2;current = delta * x[j - 1];for(n = len + 3;n--;j += 2) {next = delta * x[j + 1];x[j] = K * x[j] - current - next;if(n--){j += 2;current = delta * x[j + 1];x[j] = K * x[j] - current - next;}else {break;}}j = offset - 1;current = gamma * x[j - 1];for(n = len + 2;n--;j += 2) {next = gamma * x[j + 1];x[j] -= current + next;if(n--){j += 2;current = gamma * x[j + 1];x[j] -= current + next;}else {break;}}j = offset;current = beta * x[j - 1];for(n = len + 1;n--;j += 2) {next = beta * x[j + 1];x[j] -= current + next;if(n--){j += 2;current = beta * x[j + 1];x[j] -= current + next;}else {break;}}if(len !== 0){j = offset + 1;current = alpha * x[j - 1];for(n = len;n--;j += 2) {next = alpha * x[j + 1];x[j] -= current + next;if(n--){j += 2;current = alpha * x[j + 1];x[j] -= current + next;}else {break;}}}};return IrreversibleTransform;})();var ReversibleTransform=(function ReversibleTransformClosure(){function ReversibleTransform(){Transform.call(this);}ReversibleTransform.prototype = Object.create(Transform.prototype);ReversibleTransform.prototype.filter = function reversibleTransformFilter(x,offset,length){var len=length >> 1;offset = offset | 0;var j,n;for(j = offset,n = len + 1;n--;j += 2) {x[j] -= x[j - 1] + x[j + 1] + 2 >> 2;}for(j = offset + 1,n = len;n--;j += 2) {x[j] += x[j - 1] + x[j + 1] >> 1;}};return ReversibleTransform;})();return JpxImage;})();"use strict";var ArithmeticDecoder=(function ArithmeticDecoderClosure(){var QeTable=[{qe:0x5601,nmps:1,nlps:1,switchFlag:1},{qe:0x3401,nmps:2,nlps:6,switchFlag:0},{qe:0x1801,nmps:3,nlps:9,switchFlag:0},{qe:0x0AC1,nmps:4,nlps:12,switchFlag:0},{qe:0x0521,nmps:5,nlps:29,switchFlag:0},{qe:0x0221,nmps:38,nlps:33,switchFlag:0},{qe:0x5601,nmps:7,nlps:6,switchFlag:1},{qe:0x5401,nmps:8,nlps:14,switchFlag:0},{qe:0x4801,nmps:9,nlps:14,switchFlag:0},{qe:0x3801,nmps:10,nlps:14,switchFlag:0},{qe:0x3001,nmps:11,nlps:17,switchFlag:0},{qe:0x2401,nmps:12,nlps:18,switchFlag:0},{qe:0x1C01,nmps:13,nlps:20,switchFlag:0},{qe:0x1601,nmps:29,nlps:21,switchFlag:0},{qe:0x5601,nmps:15,nlps:14,switchFlag:1},{qe:0x5401,nmps:16,nlps:14,switchFlag:0},{qe:0x5101,nmps:17,nlps:15,switchFlag:0},{qe:0x4801,nmps:18,nlps:16,switchFlag:0},{qe:0x3801,nmps:19,nlps:17,switchFlag:0},{qe:0x3401,nmps:20,nlps:18,switchFlag:0},{qe:0x3001,nmps:21,nlps:19,switchFlag:0},{qe:0x2801,nmps:22,nlps:19,switchFlag:0},{qe:0x2401,nmps:23,nlps:20,switchFlag:0},{qe:0x2201,nmps:24,nlps:21,switchFlag:0},{qe:0x1C01,nmps:25,nlps:22,switchFlag:0},{qe:0x1801,nmps:26,nlps:23,switchFlag:0},{qe:0x1601,nmps:27,nlps:24,switchFlag:0},{qe:0x1401,nmps:28,nlps:25,switchFlag:0},{qe:0x1201,nmps:29,nlps:26,switchFlag:0},{qe:0x1101,nmps:30,nlps:27,switchFlag:0},{qe:0x0AC1,nmps:31,nlps:28,switchFlag:0},{qe:0x09C1,nmps:32,nlps:29,switchFlag:0},{qe:0x08A1,nmps:33,nlps:30,switchFlag:0},{qe:0x0521,nmps:34,nlps:31,switchFlag:0},{qe:0x0441,nmps:35,nlps:32,switchFlag:0},{qe:0x02A1,nmps:36,nlps:33,switchFlag:0},{qe:0x0221,nmps:37,nlps:34,switchFlag:0},{qe:0x0141,nmps:38,nlps:35,switchFlag:0},{qe:0x0111,nmps:39,nlps:36,switchFlag:0},{qe:0x0085,nmps:40,nlps:37,switchFlag:0},{qe:0x0049,nmps:41,nlps:38,switchFlag:0},{qe:0x0025,nmps:42,nlps:39,switchFlag:0},{qe:0x0015,nmps:43,nlps:40,switchFlag:0},{qe:0x0009,nmps:44,nlps:41,switchFlag:0},{qe:0x0005,nmps:45,nlps:42,switchFlag:0},{qe:0x0001,nmps:45,nlps:43,switchFlag:0},{qe:0x5601,nmps:46,nlps:46,switchFlag:0}];function ArithmeticDecoder(data,start,end){this.data = data;this.bp = start;this.dataEnd = end;this.chigh = data[start];this.clow = 0;this.byteIn();this.chigh = this.chigh << 7 & 0xFFFF | this.clow >> 9 & 0x7F;this.clow = this.clow << 7 & 0xFFFF;this.ct -= 7;this.a = 0x8000;}ArithmeticDecoder.prototype = {byteIn:function ArithmeticDecoder_byteIn(){var data=this.data;var bp=this.bp;if(data[bp] === 0xFF){var b1=data[bp + 1];if(b1 > 0x8F){this.clow += 0xFF00;this.ct = 8;}else {bp++;this.clow += data[bp] << 9;this.ct = 7;this.bp = bp;}}else {bp++;this.clow += bp < this.dataEnd?data[bp] << 8:0xFF00;this.ct = 8;this.bp = bp;}if(this.clow > 0xFFFF){this.chigh += this.clow >> 16;this.clow &= 0xFFFF;}},readBit:function ArithmeticDecoder_readBit(contexts,pos){var cx_index=contexts[pos] >> 1,cx_mps=contexts[pos] & 1;var qeTableIcx=QeTable[cx_index];var qeIcx=qeTableIcx.qe;var d;var a=this.a - qeIcx;if(this.chigh < qeIcx){if(a < qeIcx){a = qeIcx;d = cx_mps;cx_index = qeTableIcx.nmps;}else {a = qeIcx;d = 1 ^ cx_mps;if(qeTableIcx.switchFlag === 1){cx_mps = d;}cx_index = qeTableIcx.nlps;}}else {this.chigh -= qeIcx;if((a & 0x8000) !== 0){this.a = a;return cx_mps;}if(a < qeIcx){d = 1 ^ cx_mps;if(qeTableIcx.switchFlag === 1){cx_mps = d;}cx_index = qeTableIcx.nlps;}else {d = cx_mps;cx_index = qeTableIcx.nmps;}}do {if(this.ct === 0){this.byteIn();}a <<= 1;this.chigh = this.chigh << 1 & 0xFFFF | this.clow >> 15 & 1;this.clow = this.clow << 1 & 0xFFFF;this.ct--;}while((a & 0x8000) === 0);this.a = a;contexts[pos] = cx_index << 1 | cx_mps;return d;}};return ArithmeticDecoder;})();"use strict";var globalScope=typeof window === "undefined"?this:window;var isWorker=typeof window === "undefined";var FONT_IDENTITY_MATRIX=[0.001,0,0,0.001,0,0];var TextRenderingMode={FILL:0,STROKE:1,FILL_STROKE:2,INVISIBLE:3,FILL_ADD_TO_PATH:4,STROKE_ADD_TO_PATH:5,FILL_STROKE_ADD_TO_PATH:6,ADD_TO_PATH:7,FILL_STROKE_MASK:3,ADD_TO_PATH_FLAG:4};var ImageKind={GRAYSCALE_1BPP:1,RGB_24BPP:2,RGBA_32BPP:3};var AnnotationType={WIDGET:1,TEXT:2,LINK:3};var StreamType={UNKNOWN:0,FLATE:1,LZW:2,DCT:3,JPX:4,JBIG:5,A85:6,AHX:7,CCF:8,RL:9};var FontType={UNKNOWN:0,TYPE1:1,TYPE1C:2,CIDFONTTYPE0:3,CIDFONTTYPE0C:4,TRUETYPE:5,CIDFONTTYPE2:6,TYPE3:7,OPENTYPE:8,TYPE0:9,MMTYPE1:10};if(!globalScope.PDFJS){globalScope.PDFJS = {};}globalScope.PDFJS.pdfBug = false;PDFJS.VERBOSITY_LEVELS = {errors:0,warnings:1,infos:5};var OPS=PDFJS.OPS = {dependency:1,setLineWidth:2,setLineCap:3,setLineJoin:4,setMiterLimit:5,setDash:6,setRenderingIntent:7,setFlatness:8,setGState:9,save:10,restore:11,transform:12,moveTo:13,lineTo:14,curveTo:15,curveTo2:16,curveTo3:17,closePath:18,rectangle:19,stroke:20,closeStroke:21,fill:22,eoFill:23,fillStroke:24,eoFillStroke:25,closeFillStroke:26,closeEOFillStroke:27,endPath:28,clip:29,eoClip:30,beginText:31,endText:32,setCharSpacing:33,setWordSpacing:34,setHScale:35,setLeading:36,setFont:37,setTextRenderingMode:38,setTextRise:39,moveText:40,setLeadingMoveText:41,setTextMatrix:42,nextLine:43,showText:44,showSpacedText:45,nextLineShowText:46,nextLineSetSpacingShowText:47,setCharWidth:48,setCharWidthAndBounds:49,setStrokeColorSpace:50,setFillColorSpace:51,setStrokeColor:52,setStrokeColorN:53,setFillColor:54,setFillColorN:55,setStrokeGray:56,setFillGray:57,setStrokeRGBColor:58,setFillRGBColor:59,setStrokeCMYKColor:60,setFillCMYKColor:61,shadingFill:62,beginInlineImage:63,beginImageData:64,endInlineImage:65,paintXObject:66,markPoint:67,markPointProps:68,beginMarkedContent:69,beginMarkedContentProps:70,endMarkedContent:71,beginCompat:72,endCompat:73,paintFormXObjectBegin:74,paintFormXObjectEnd:75,beginGroup:76,endGroup:77,beginAnnotations:78,endAnnotations:79,beginAnnotation:80,endAnnotation:81,paintJpegXObject:82,paintImageMaskXObject:83,paintImageMaskXObjectGroup:84,paintImageXObject:85,paintInlineImageXObject:86,paintInlineImageXObjectGroup:87,paintImageXObjectRepeat:88,paintImageMaskXObjectRepeat:89,paintSolidColorImageMask:90,constructPath:91};function info(msg){if(PDFJS.verbosity >= PDFJS.VERBOSITY_LEVELS.infos){console.log("Info: " + msg);}}function warn(msg){if(PDFJS.verbosity >= PDFJS.VERBOSITY_LEVELS.warnings){console.log("Warning: " + msg);}}function error(msg){if(arguments.length > 1){var logArguments=["Error:"];logArguments.push.apply(logArguments,arguments);console.log.apply(console,logArguments);msg = [].join.call(arguments," ");}else {console.log("Error: " + msg);}console.log(backtrace());UnsupportedManager.notify(UNSUPPORTED_FEATURES.unknown);throw new Error(msg);}function backtrace(){try{throw new Error();}catch(e) {return e.stack?e.stack.split("\n").slice(2).join("\n"):"";}}function assert(cond,msg){if(!cond){error(msg);}}var UNSUPPORTED_FEATURES=PDFJS.UNSUPPORTED_FEATURES = {unknown:"unknown",forms:"forms",javaScript:"javaScript",smask:"smask",shadingPattern:"shadingPattern",font:"font"};var UnsupportedManager=PDFJS.UnsupportedManager = (function UnsupportedManagerClosure(){var listeners=[];return {listen:function listen(cb){listeners.push(cb);},notify:function notify(featureId){warn("Unsupported feature \"" + featureId + "\"");for(var i=0,ii=listeners.length;i < ii;i++) {listeners[i](featureId);}}};})();function combineUrl(baseUrl,url){if(!url){return baseUrl;}if(/^[a-z][a-z0-9+\-.]*:/i.test(url)){return url;}var i;if(url.charAt(0) === "/"){i = baseUrl.indexOf("://");if(url.charAt(1) === "/"){++i;}else {i = baseUrl.indexOf("/",i + 3);}return baseUrl.substring(0,i) + url;}else {var pathLength=baseUrl.length;i = baseUrl.lastIndexOf("#");pathLength = i >= 0?i:pathLength;i = baseUrl.lastIndexOf("?",pathLength);pathLength = i >= 0?i:pathLength;var prefixLength=baseUrl.lastIndexOf("/",pathLength);return baseUrl.substring(0,prefixLength + 1) + url;}}function isValidUrl(url,allowRelative){if(!url){return false;}var protocol=/^[a-z][a-z0-9+\-.]*(?=:)/i.exec(url);if(!protocol){return allowRelative;}protocol = protocol[0].toLowerCase();switch(protocol){case "http":case "https":case "ftp":case "mailto":case "tel":return true;default:return false;}}PDFJS.isValidUrl = isValidUrl;function shadow(obj,prop,value){Object.defineProperty(obj,prop,{value:value,enumerable:true,configurable:true,writable:false});return value;}PDFJS.shadow = shadow;var PasswordResponses=PDFJS.PasswordResponses = {NEED_PASSWORD:1,INCORRECT_PASSWORD:2};var PasswordException=(function PasswordExceptionClosure(){function PasswordException(msg,code){this.name = "PasswordException";this.message = msg;this.code = code;}PasswordException.prototype = new Error();PasswordException.constructor = PasswordException;return PasswordException;})();PDFJS.PasswordException = PasswordException;var UnknownErrorException=(function UnknownErrorExceptionClosure(){function UnknownErrorException(msg,details){this.name = "UnknownErrorException";this.message = msg;this.details = details;}UnknownErrorException.prototype = new Error();UnknownErrorException.constructor = UnknownErrorException;return UnknownErrorException;})();PDFJS.UnknownErrorException = UnknownErrorException;var InvalidPDFException=(function InvalidPDFExceptionClosure(){function InvalidPDFException(msg){this.name = "InvalidPDFException";this.message = msg;}InvalidPDFException.prototype = new Error();InvalidPDFException.constructor = InvalidPDFException;return InvalidPDFException;})();PDFJS.InvalidPDFException = InvalidPDFException;var MissingPDFException=(function MissingPDFExceptionClosure(){function MissingPDFException(msg){this.name = "MissingPDFException";this.message = msg;}MissingPDFException.prototype = new Error();MissingPDFException.constructor = MissingPDFException;return MissingPDFException;})();PDFJS.MissingPDFException = MissingPDFException;var UnexpectedResponseException=(function UnexpectedResponseExceptionClosure(){function UnexpectedResponseException(msg,status){this.name = "UnexpectedResponseException";this.message = msg;this.status = status;}UnexpectedResponseException.prototype = new Error();UnexpectedResponseException.constructor = UnexpectedResponseException;return UnexpectedResponseException;})();PDFJS.UnexpectedResponseException = UnexpectedResponseException;var NotImplementedException=(function NotImplementedExceptionClosure(){function NotImplementedException(msg){this.message = msg;}NotImplementedException.prototype = new Error();NotImplementedException.prototype.name = "NotImplementedException";NotImplementedException.constructor = NotImplementedException;return NotImplementedException;})();var MissingDataException=(function MissingDataExceptionClosure(){function MissingDataException(begin,end){this.begin = begin;this.end = end;this.message = "Missing data [" + begin + ", " + end + ")";}MissingDataException.prototype = new Error();MissingDataException.prototype.name = "MissingDataException";MissingDataException.constructor = MissingDataException;return MissingDataException;})();var XRefParseException=(function XRefParseExceptionClosure(){function XRefParseException(msg){this.message = msg;}XRefParseException.prototype = new Error();XRefParseException.prototype.name = "XRefParseException";XRefParseException.constructor = XRefParseException;return XRefParseException;})();function bytesToString(bytes){assert(bytes !== null && typeof bytes === "object" && bytes.length !== undefined,"Invalid argument for bytesToString");var length=bytes.length;var MAX_ARGUMENT_COUNT=8192;if(length < MAX_ARGUMENT_COUNT){return String.fromCharCode.apply(null,bytes);}var strBuf=[];for(var i=0;i < length;i += MAX_ARGUMENT_COUNT) {var chunkEnd=Math.min(i + MAX_ARGUMENT_COUNT,length);var chunk=bytes.subarray(i,chunkEnd);strBuf.push(String.fromCharCode.apply(null,chunk));}return strBuf.join("");}function stringToBytes(str){assert(typeof str === "string","Invalid argument for stringToBytes");var length=str.length;var bytes=new Uint8Array(length);for(var i=0;i < length;++i) {bytes[i] = str.charCodeAt(i) & 0xFF;}return bytes;}function string32(value){return String.fromCharCode(value >> 24 & 0xff,value >> 16 & 0xff,value >> 8 & 0xff,value & 0xff);}function log2(x){var n=1,i=0;while(x > n) {n <<= 1;i++;}return i;}function readInt8(data,start){return data[start] << 24 >> 24;}function readUint16(data,offset){return data[offset] << 8 | data[offset + 1];}function readUint32(data,offset){return (data[offset] << 24 | data[offset + 1] << 16 | data[offset + 2] << 8 | data[offset + 3]) >>> 0;}function isLittleEndian(){var buffer8=new Uint8Array(2);buffer8[0] = 1;var buffer16=new Uint16Array(buffer8.buffer);return buffer16[0] === 1;}Object.defineProperty(PDFJS,"isLittleEndian",{configurable:true,get:function PDFJS_isLittleEndian(){return shadow(PDFJS,"isLittleEndian",isLittleEndian());}});function hasCanvasTypedArrays(){var canvas=document.createElement("canvas");canvas.width = canvas.height = 1;var ctx=canvas.getContext("2d");var imageData=ctx.createImageData(1,1);return typeof imageData.data.buffer !== "undefined";}Object.defineProperty(PDFJS,"hasCanvasTypedArrays",{configurable:true,get:function PDFJS_hasCanvasTypedArrays(){return shadow(PDFJS,"hasCanvasTypedArrays",hasCanvasTypedArrays());}});var Uint32ArrayView=(function Uint32ArrayViewClosure(){function Uint32ArrayView(buffer,length){this.buffer = buffer;this.byteLength = buffer.length;this.length = length === undefined?this.byteLength >> 2:length;ensureUint32ArrayViewProps(this.length);}Uint32ArrayView.prototype = Object.create(null);var uint32ArrayViewSetters=0;function createUint32ArrayProp(index){return {get:function get(){var buffer=this.buffer,offset=index << 2;return (buffer[offset] | buffer[offset + 1] << 8 | buffer[offset + 2] << 16 | buffer[offset + 3] << 24) >>> 0;},set:function set(value){var buffer=this.buffer,offset=index << 2;buffer[offset] = value & 255;buffer[offset + 1] = value >> 8 & 255;buffer[offset + 2] = value >> 16 & 255;buffer[offset + 3] = value >>> 24 & 255;}};}function ensureUint32ArrayViewProps(length){while(uint32ArrayViewSetters < length) {Object.defineProperty(Uint32ArrayView.prototype,uint32ArrayViewSetters,createUint32ArrayProp(uint32ArrayViewSetters));uint32ArrayViewSetters++;}}return Uint32ArrayView;})();var IDENTITY_MATRIX=[1,0,0,1,0,0];var Util=PDFJS.Util = (function UtilClosure(){function Util(){}var rgbBuf=["rgb(",0,",",0,",",0,")"];Util.makeCssRgb = function Util_makeCssRgb(r,g,b){rgbBuf[1] = r;rgbBuf[3] = g;rgbBuf[5] = b;return rgbBuf.join("");};Util.transform = function Util_transform(m1,m2){return [m1[0] * m2[0] + m1[2] * m2[1],m1[1] * m2[0] + m1[3] * m2[1],m1[0] * m2[2] + m1[2] * m2[3],m1[1] * m2[2] + m1[3] * m2[3],m1[0] * m2[4] + m1[2] * m2[5] + m1[4],m1[1] * m2[4] + m1[3] * m2[5] + m1[5]];};Util.applyTransform = function Util_applyTransform(p,m){var xt=p[0] * m[0] + p[1] * m[2] + m[4];var yt=p[0] * m[1] + p[1] * m[3] + m[5];return [xt,yt];};Util.applyInverseTransform = function Util_applyInverseTransform(p,m){var d=m[0] * m[3] - m[1] * m[2];var xt=(p[0] * m[3] - p[1] * m[2] + m[2] * m[5] - m[4] * m[3]) / d;var yt=(-p[0] * m[1] + p[1] * m[0] + m[4] * m[1] - m[5] * m[0]) / d;return [xt,yt];};Util.getAxialAlignedBoundingBox = function Util_getAxialAlignedBoundingBox(r,m){var p1=Util.applyTransform(r,m);var p2=Util.applyTransform(r.slice(2,4),m);var p3=Util.applyTransform([r[0],r[3]],m);var p4=Util.applyTransform([r[2],r[1]],m);return [Math.min(p1[0],p2[0],p3[0],p4[0]),Math.min(p1[1],p2[1],p3[1],p4[1]),Math.max(p1[0],p2[0],p3[0],p4[0]),Math.max(p1[1],p2[1],p3[1],p4[1])];};Util.inverseTransform = function Util_inverseTransform(m){var d=m[0] * m[3] - m[1] * m[2];return [m[3] / d,-m[1] / d,-m[2] / d,m[0] / d,(m[2] * m[5] - m[4] * m[3]) / d,(m[4] * m[1] - m[5] * m[0]) / d];};Util.apply3dTransform = function Util_apply3dTransform(m,v){return [m[0] * v[0] + m[1] * v[1] + m[2] * v[2],m[3] * v[0] + m[4] * v[1] + m[5] * v[2],m[6] * v[0] + m[7] * v[1] + m[8] * v[2]];};Util.singularValueDecompose2dScale = function Util_singularValueDecompose2dScale(m){var transpose=[m[0],m[2],m[1],m[3]];var a=m[0] * transpose[0] + m[1] * transpose[2];var b=m[0] * transpose[1] + m[1] * transpose[3];var c=m[2] * transpose[0] + m[3] * transpose[2];var d=m[2] * transpose[1] + m[3] * transpose[3];var first=(a + d) / 2;var second=Math.sqrt((a + d) * (a + d) - 4 * (a * d - c * b)) / 2;var sx=first + second || 1;var sy=first - second || 1;return [Math.sqrt(sx),Math.sqrt(sy)];};Util.normalizeRect = function Util_normalizeRect(rect){var r=rect.slice(0);if(rect[0] > rect[2]){r[0] = rect[2];r[2] = rect[0];}if(rect[1] > rect[3]){r[1] = rect[3];r[3] = rect[1];}return r;};Util.intersect = function Util_intersect(rect1,rect2){function compare(a,b){return a - b;}var orderedX=[rect1[0],rect1[2],rect2[0],rect2[2]].sort(compare),orderedY=[rect1[1],rect1[3],rect2[1],rect2[3]].sort(compare),result=[];rect1 = Util.normalizeRect(rect1);rect2 = Util.normalizeRect(rect2);if(orderedX[0] === rect1[0] && orderedX[1] === rect2[0] || orderedX[0] === rect2[0] && orderedX[1] === rect1[0]){result[0] = orderedX[1];result[2] = orderedX[2];}else {return false;}if(orderedY[0] === rect1[1] && orderedY[1] === rect2[1] || orderedY[0] === rect2[1] && orderedY[1] === rect1[1]){result[1] = orderedY[1];result[3] = orderedY[2];}else {return false;}return result;};Util.sign = function Util_sign(num){return num < 0?-1:1;};Util.appendToArray = function Util_appendToArray(arr1,arr2){Array.prototype.push.apply(arr1,arr2);};Util.prependToArray = function Util_prependToArray(arr1,arr2){Array.prototype.unshift.apply(arr1,arr2);};Util.extendObj = function extendObj(obj1,obj2){for(var key in obj2) {obj1[key] = obj2[key];}};Util.getInheritableProperty = function Util_getInheritableProperty(dict,name){while(dict && !dict.has(name)) {dict = dict.get("Parent");}if(!dict){return null;}return dict.get(name);};Util.inherit = function Util_inherit(sub,base,prototype){sub.prototype = Object.create(base.prototype);sub.prototype.constructor = sub;for(var prop in prototype) {sub.prototype[prop] = prototype[prop];}};Util.loadScript = function Util_loadScript(src,callback){var script=document.createElement("script");var loaded=false;script.setAttribute("src",src);if(callback){script.onload = function(){if(!loaded){callback();}loaded = true;};}document.getElementsByTagName("head")[0].appendChild(script);};return Util;})();var PageViewport=PDFJS.PageViewport = (function PageViewportClosure(){function PageViewport(viewBox,scale,rotation,offsetX,offsetY,dontFlip){this.viewBox = viewBox;this.scale = scale;this.rotation = rotation;this.offsetX = offsetX;this.offsetY = offsetY;var centerX=(viewBox[2] + viewBox[0]) / 2;var centerY=(viewBox[3] + viewBox[1]) / 2;var rotateA,rotateB,rotateC,rotateD;rotation = rotation % 360;rotation = rotation < 0?rotation + 360:rotation;switch(rotation){case 180:rotateA = -1;rotateB = 0;rotateC = 0;rotateD = 1;break;case 90:rotateA = 0;rotateB = 1;rotateC = 1;rotateD = 0;break;case 270:rotateA = 0;rotateB = -1;rotateC = -1;rotateD = 0;break;default:rotateA = 1;rotateB = 0;rotateC = 0;rotateD = -1;break;}if(dontFlip){rotateC = -rotateC;rotateD = -rotateD;}var offsetCanvasX,offsetCanvasY;var width,height;if(rotateA === 0){offsetCanvasX = Math.abs(centerY - viewBox[1]) * scale + offsetX;offsetCanvasY = Math.abs(centerX - viewBox[0]) * scale + offsetY;width = Math.abs(viewBox[3] - viewBox[1]) * scale;height = Math.abs(viewBox[2] - viewBox[0]) * scale;}else {offsetCanvasX = Math.abs(centerX - viewBox[0]) * scale + offsetX;offsetCanvasY = Math.abs(centerY - viewBox[1]) * scale + offsetY;width = Math.abs(viewBox[2] - viewBox[0]) * scale;height = Math.abs(viewBox[3] - viewBox[1]) * scale;}this.transform = [rotateA * scale,rotateB * scale,rotateC * scale,rotateD * scale,offsetCanvasX - rotateA * scale * centerX - rotateC * scale * centerY,offsetCanvasY - rotateB * scale * centerX - rotateD * scale * centerY];this.width = width;this.height = height;this.fontScale = scale;}PageViewport.prototype = {clone:function PageViewPort_clone(args){args = args || {};var scale="scale" in args?args.scale:this.scale;var rotation="rotation" in args?args.rotation:this.rotation;return new PageViewport(this.viewBox.slice(),scale,rotation,this.offsetX,this.offsetY,args.dontFlip);},convertToViewportPoint:function PageViewport_convertToViewportPoint(x,y){return Util.applyTransform([x,y],this.transform);},convertToViewportRectangle:function PageViewport_convertToViewportRectangle(rect){var tl=Util.applyTransform([rect[0],rect[1]],this.transform);var br=Util.applyTransform([rect[2],rect[3]],this.transform);return [tl[0],tl[1],br[0],br[1]];},convertToPdfPoint:function PageViewport_convertToPdfPoint(x,y){return Util.applyInverseTransform([x,y],this.transform);}};return PageViewport;})();var PDFStringTranslateTable=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0x2D8,0x2C7,0x2C6,0x2D9,0x2DD,0x2DB,0x2DA,0x2DC,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0x2022,0x2020,0x2021,0x2026,0x2014,0x2013,0x192,0x2044,0x2039,0x203A,0x2212,0x2030,0x201E,0x201C,0x201D,0x2018,0x2019,0x201A,0x2122,0xFB01,0xFB02,0x141,0x152,0x160,0x178,0x17D,0x131,0x142,0x153,0x161,0x17E,0,0x20AC];function stringToPDFString(str){var i,n=str.length,strBuf=[];if(str[0] === "þ" && str[1] === "ÿ"){for(i = 2;i < n;i += 2) {strBuf.push(String.fromCharCode(str.charCodeAt(i) << 8 | str.charCodeAt(i + 1)));}}else {for(i = 0;i < n;++i) {var code=PDFStringTranslateTable[str.charCodeAt(i)];strBuf.push(code?String.fromCharCode(code):str.charAt(i));}}return strBuf.join("");}function stringToUTF8String(str){return decodeURIComponent(escape(str));}function isEmptyObj(obj){for(var key in obj) {return false;}return true;}function isBool(v){return typeof v === "boolean";}function isInt(v){return typeof v === "number" && (v | 0) === v;}function isNum(v){return typeof v === "number";}function isString(v){return typeof v === "string";}function isNull(v){return v === null;}function isName(v){return v instanceof Name;}function isCmd(v,cmd){return v instanceof Cmd && (cmd === undefined || v.cmd === cmd);}function isDict(v,type){if(!(v instanceof Dict)){return false;}if(!type){return true;}var dictType=v.get("Type");return isName(dictType) && dictType.name === type;}function isArray(v){return v instanceof Array;}function isStream(v){return typeof v === "object" && v !== null && v.getBytes !== undefined;}function isArrayBuffer(v){return typeof v === "object" && v !== null && v.byteLength !== undefined;}function isRef(v){return v instanceof Ref;}function createPromiseCapability(){var capability={};capability.promise = new Promise(function(resolve,reject){capability.resolve = resolve;capability.reject = reject;});return capability;}PDFJS.createPromiseCapability = createPromiseCapability;(function PromiseClosure(){if(globalScope.Promise){if(typeof globalScope.Promise.all !== "function"){globalScope.Promise.all = function(iterable){var count=0,results=[],resolve,reject;var promise=new globalScope.Promise(function(resolve_,reject_){resolve = resolve_;reject = reject_;});iterable.forEach(function(p,i){count++;p.then(function(result){results[i] = result;count--;if(count === 0){resolve(results);}},reject);});if(count === 0){resolve(results);}return promise;};}if(typeof globalScope.Promise.resolve !== "function"){globalScope.Promise.resolve = function(value){return new globalScope.Promise(function(resolve){resolve(value);});};}if(typeof globalScope.Promise.reject !== "function"){globalScope.Promise.reject = function(reason){return new globalScope.Promise(function(resolve,reject){reject(reason);});};}if(typeof globalScope.Promise.prototype["catch"] !== "function"){globalScope.Promise.prototype["catch"] = function(onReject){return globalScope.Promise.prototype.then(undefined,onReject);};}return;}var STATUS_PENDING=0;var STATUS_RESOLVED=1;var STATUS_REJECTED=2;var REJECTION_TIMEOUT=500;var HandlerManager={handlers:[],running:false,unhandledRejections:[],pendingRejectionCheck:false,scheduleHandlers:function scheduleHandlers(promise){if(promise._status === STATUS_PENDING){return;}this.handlers = this.handlers.concat(promise._handlers);promise._handlers = [];if(this.running){return;}this.running = true;setTimeout(this.runHandlers.bind(this),0);},runHandlers:function runHandlers(){var RUN_TIMEOUT=1;var timeoutAt=Date.now() + RUN_TIMEOUT;while(this.handlers.length > 0) {var handler=this.handlers.shift();var nextStatus=handler.thisPromise._status;var nextValue=handler.thisPromise._value;try{if(nextStatus === STATUS_RESOLVED){if(typeof handler.onResolve === "function"){nextValue = handler.onResolve(nextValue);}}else if(typeof handler.onReject === "function"){nextValue = handler.onReject(nextValue);nextStatus = STATUS_RESOLVED;if(handler.thisPromise._unhandledRejection){this.removeUnhandeledRejection(handler.thisPromise);}}}catch(ex) {nextStatus = STATUS_REJECTED;nextValue = ex;}handler.nextPromise._updateStatus(nextStatus,nextValue);if(Date.now() >= timeoutAt){break;}}if(this.handlers.length > 0){setTimeout(this.runHandlers.bind(this),0);return;}this.running = false;},addUnhandledRejection:function addUnhandledRejection(promise){this.unhandledRejections.push({promise:promise,time:Date.now()});this.scheduleRejectionCheck();},removeUnhandeledRejection:function removeUnhandeledRejection(promise){promise._unhandledRejection = false;for(var i=0;i < this.unhandledRejections.length;i++) {if(this.unhandledRejections[i].promise === promise){this.unhandledRejections.splice(i);i--;}}},scheduleRejectionCheck:function scheduleRejectionCheck(){if(this.pendingRejectionCheck){return;}this.pendingRejectionCheck = true;setTimeout((function rejectionCheck(){this.pendingRejectionCheck = false;var now=Date.now();for(var i=0;i < this.unhandledRejections.length;i++) {if(now - this.unhandledRejections[i].time > REJECTION_TIMEOUT){var unhandled=this.unhandledRejections[i].promise._value;var msg="Unhandled rejection: " + unhandled;if(unhandled.stack){msg += "\n" + unhandled.stack;}warn(msg);this.unhandledRejections.splice(i);i--;}}if(this.unhandledRejections.length){this.scheduleRejectionCheck();}}).bind(this),REJECTION_TIMEOUT);}};function Promise(resolver){this._status = STATUS_PENDING;this._handlers = [];try{resolver.call(this,this._resolve.bind(this),this._reject.bind(this));}catch(e) {this._reject(e);}}Promise.all = function Promise_all(promises){var resolveAll,rejectAll;var deferred=new Promise(function(resolve,reject){resolveAll = resolve;rejectAll = reject;});var unresolved=promises.length;var results=[];if(unresolved === 0){resolveAll(results);return deferred;}function reject(reason){if(deferred._status === STATUS_REJECTED){return;}results = [];rejectAll(reason);}for(var i=0,ii=promises.length;i < ii;++i) {var promise=promises[i];var resolve=(function(i){return function(value){if(deferred._status === STATUS_REJECTED){return;}results[i] = value;unresolved--;if(unresolved === 0){resolveAll(results);}};})(i);if(Promise.isPromise(promise)){promise.then(resolve,reject);}else {resolve(promise);}}return deferred;};Promise.isPromise = function Promise_isPromise(value){return value && typeof value.then === "function";};Promise.resolve = function Promise_resolve(value){return new Promise(function(resolve){resolve(value);});};Promise.reject = function Promise_reject(reason){return new Promise(function(resolve,reject){reject(reason);});};Promise.prototype = {_status:null,_value:null,_handlers:null,_unhandledRejection:null,_updateStatus:function Promise__updateStatus(status,value){if(this._status === STATUS_RESOLVED || this._status === STATUS_REJECTED){return;}if(status === STATUS_RESOLVED && Promise.isPromise(value)){value.then(this._updateStatus.bind(this,STATUS_RESOLVED),this._updateStatus.bind(this,STATUS_REJECTED));return;}this._status = status;this._value = value;if(status === STATUS_REJECTED && this._handlers.length === 0){this._unhandledRejection = true;HandlerManager.addUnhandledRejection(this);}HandlerManager.scheduleHandlers(this);},_resolve:function Promise_resolve(value){this._updateStatus(STATUS_RESOLVED,value);},_reject:function Promise_reject(reason){this._updateStatus(STATUS_REJECTED,reason);},then:function Promise_then(onResolve,onReject){var nextPromise=new Promise(function(resolve,reject){this.resolve = resolve;this.reject = reject;});this._handlers.push({thisPromise:this,onResolve:onResolve,onReject:onReject,nextPromise:nextPromise});HandlerManager.scheduleHandlers(this);return nextPromise;},"catch":function Promise_catch(onReject){return this.then(undefined,onReject);}};globalScope.Promise = Promise;})();var StatTimer=(function StatTimerClosure(){function rpad(str,pad,length){while(str.length < length) {str += pad;}return str;}function StatTimer(){this.started = {};this.times = [];this.enabled = true;}StatTimer.prototype = {time:function StatTimer_time(name){if(!this.enabled){return;}if(name in this.started){warn("Timer is already running for " + name);}this.started[name] = Date.now();},timeEnd:function StatTimer_timeEnd(name){if(!this.enabled){return;}if(!(name in this.started)){warn("Timer has not been started for " + name);}this.times.push({"name":name,"start":this.started[name],"end":Date.now()});delete this.started[name];},toString:function StatTimer_toString(){var i,ii;var times=this.times;var out="";var longest=0;for(i = 0,ii = times.length;i < ii;++i) {var name=times[i]["name"];if(name.length > longest){longest = name.length;}}for(i = 0,ii = times.length;i < ii;++i) {var span=times[i];var duration=span.end - span.start;out += rpad(span["name"]," ",longest) + " " + duration + "ms\n";}return out;}};return StatTimer;})();PDFJS.createBlob = function createBlob(data,contentType){if(typeof Blob !== "undefined"){return new Blob([data],{type:contentType});}var bb=new MozBlobBuilder();bb.append(data);return bb.getBlob(contentType);};PDFJS.createObjectURL = (function createObjectURLClosure(){var digits="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";return function createObjectURL(data,contentType){if(!PDFJS.disableCreateObjectURL && typeof URL !== "undefined" && URL.createObjectURL){var blob=PDFJS.createBlob(data,contentType);return URL.createObjectURL(blob);}var buffer="data:" + contentType + ";base64,";for(var i=0,ii=data.length;i < ii;i += 3) {var b1=data[i] & 0xFF;var b2=data[i + 1] & 0xFF;var b3=data[i + 2] & 0xFF;var d1=b1 >> 2,d2=(b1 & 3) << 4 | b2 >> 4;var d3=i + 1 < ii?(b2 & 0xF) << 2 | b3 >> 6:64;var d4=i + 2 < ii?b3 & 0x3F:64;buffer += digits[d1] + digits[d2] + digits[d3] + digits[d4];}return buffer;};})();function MessageHandler(name,comObj){this.name = name;this.comObj = comObj;this.callbackIndex = 1;this.postMessageTransfers = true;var callbacksCapabilities=this.callbacksCapabilities = {};var ah=this.actionHandler = {};ah["console_log"] = [function ahConsoleLog(data){console.log.apply(console,data);}];ah["console_error"] = [function ahConsoleError(data){console.error.apply(console,data);}];ah["_unsupported_feature"] = [function ah_unsupportedFeature(data){UnsupportedManager.notify(data);}];comObj.onmessage = function messageHandlerComObjOnMessage(event){var data=event.data;if(data.isReply){var callbackId=data.callbackId;if(data.callbackId in callbacksCapabilities){var callback=callbacksCapabilities[callbackId];delete callbacksCapabilities[callbackId];if("error" in data){callback.reject(data.error);}else {callback.resolve(data.data);}}else {error("Cannot resolve callback " + callbackId);}}else if(data.action in ah){var action=ah[data.action];if(data.callbackId){Promise.resolve().then(function(){return action[0].call(action[1],data.data);}).then(function(result){comObj.postMessage({isReply:true,callbackId:data.callbackId,data:result});},function(reason){comObj.postMessage({isReply:true,callbackId:data.callbackId,error:reason});});}else {action[0].call(action[1],data.data);}}else {error("Unknown action from worker: " + data.action);}};}MessageHandler.prototype = {on:function messageHandlerOn(actionName,handler,scope){var ah=this.actionHandler;if(ah[actionName]){error("There is already an actionName called \"" + actionName + "\"");}ah[actionName] = [handler,scope];},send:function messageHandlerSend(actionName,data,transfers){var message={action:actionName,data:data};this.postMessage(message,transfers);},sendWithPromise:function messageHandlerSendWithPromise(actionName,data,transfers){var callbackId=this.callbackIndex++;var message={action:actionName,data:data,callbackId:callbackId};var capability=createPromiseCapability();this.callbacksCapabilities[callbackId] = capability;try{this.postMessage(message,transfers);}catch(e) {capability.reject(e);}return capability.promise;},postMessage:function postMessage(message,transfers){if(transfers && this.postMessageTransfers){this.comObj.postMessage(message,transfers);}else {this.comObj.postMessage(message);}}};function loadJpegStream(id,imageUrl,objs){var img=new Image();img.onload = function loadJpegStream_onloadClosure(){objs.resolve(id,img);};img.onerror = function loadJpegStream_onerrorClosure(){objs.resolve(id,null);warn("Error during JPEG image loading");};img.src = imageUrl;}var moduleType=typeof module;if(moduleType !== "undefined" && module.exports){module.exports = JpxImage;}},{}],12:[function(require,module,exports){"use strict";var dicomParser=require("dicom-parser");var jpx=require("./jpx.js");var VJS=VJS || {};VJS.parsers = VJS.parsers || {};VJS.parsers.dicom = function(arrayBuffer,id){this._id = id;this._arrayBuffer = arrayBuffer;var byteArray=new Uint8Array(arrayBuffer);try{this._dataSet = dicomParser.parseDicom(byteArray);}catch(e) {window.console.log(e);throw "VJS.parsers.dicom could not parse the dicom";}};VJS.parsers.dicom.prototype.seriesInstanceUID = function(){return this._dataSet.string("x0020000e");};VJS.parsers.dicom.prototype.modality = function(){return this._dataSet.string("x00080060");};VJS.parsers.dicom.prototype.sopInstanceUID = function(){return this._dataSet.string("x00200018");};VJS.parsers.dicom.prototype.transferSyntaxUID = function(){return this._dataSet.string("x00020010");};VJS.parsers.dicom.prototype.photometricInterpretation = function(){return this._dataSet.string("x00280004");};VJS.parsers.dicom.prototype.planarConfiguration = function(){var planarConfiguration=this._dataSet.uint16("x00280006");if(typeof planarConfiguration === "undefined"){planarConfiguration = null;}return planarConfiguration;};VJS.parsers.dicom.prototype.samplesPerPixel = function(){return this._dataSet.uint16("x00280002");};VJS.parsers.dicom.prototype.numberOfFrames = function(){var numberOfFrames=this._dataSet.intString("x00280008");if(typeof numberOfFrames === "undefined"){numberOfFrames = null;}return numberOfFrames;};VJS.parsers.dicom.prototype.numberOfChannels = function(){var numberOfChannels=1;var photometricInterpretation=this.photometricInterpretation();if(photometricInterpretation === "RGB" || photometricInterpretation === "PALETTE COLOR" || photometricInterpretation === "YBR_FULL" || photometricInterpretation === "YBR_FULL_422" || photometricInterpretation === "YBR_PARTIAL_422" || photometricInterpretation === "YBR_PARTIAL_420" || photometricInterpretation === "YBR_RCT"){numberOfChannels = 3;}return numberOfChannels;};VJS.parsers.dicom.prototype.imageOrientation = function(frameIndex){var imageOrientation=this._dataSet.string("x00200037");if(typeof imageOrientation === "undefined"){var perFrameFunctionnalGroupSequence=this._dataSet.elements.x52009230;if(typeof perFrameFunctionnalGroupSequence !== "undefined"){var planeOrientationSequence=perFrameFunctionnalGroupSequence.items[frameIndex].dataSet.elements.x00209116.items[0].dataSet;imageOrientation = planeOrientationSequence.string("x00200037");}else {imageOrientation = null;}}if(imageOrientation){imageOrientation = imageOrientation.split("\\").map(Number);}return imageOrientation;};VJS.parsers.dicom.prototype.pixelAspectRatio = function(){var pixelAspectRatio=[this._dataSet.intString("x00280034",0),this._dataSet.intString("x00280034",1)];if(typeof pixelAspectRatio[0] === "undefined"){pixelAspectRatio = null;}return pixelAspectRatio;};VJS.parsers.dicom.prototype.imagePosition = function(frameIndex){var imagePosition=null;var perFrameFunctionnalGroupSequence=this._dataSet.elements.x52009230;if(typeof perFrameFunctionnalGroupSequence !== "undefined"){var planeOrientationSequence=perFrameFunctionnalGroupSequence.items[frameIndex].dataSet.elements.x00209113.items[0].dataSet;imagePosition = planeOrientationSequence.string("x00200032");}else {imagePosition = this._dataSet.string("x00200032");if(typeof imagePosition === "undefined"){imagePosition = null;}}if(imagePosition){imagePosition = imagePosition.split("\\").map(Number);}return imagePosition;};VJS.parsers.dicom.prototype.instanceNumber = function(frameIndex){var instanceNumber=null;var perFrameFunctionnalGroupSequence=this._dataSet.elements.x52009230;if(typeof perFrameFunctionnalGroupSequence !== "undefined"){if(perFrameFunctionnalGroupSequence.items[frameIndex].dataSet.elements.x2005140f){var planeOrientationSequence=perFrameFunctionnalGroupSequence.items[frameIndex].dataSet.elements.x2005140f.items[0].dataSet;instanceNumber = planeOrientationSequence.intString("x00200013");}else {instanceNumber = this._dataSet.intString("x00200013");if(typeof instanceNumber === "undefined"){instanceNumber = null;}}}else {instanceNumber = this._dataSet.intString("x00200013");if(typeof instanceNumber === "undefined"){instanceNumber = null;}}return instanceNumber;};VJS.parsers.dicom.prototype.pixelSpacing = function(frameIndex){var pixelSpacing=this._dataSet.string("x00280030");if(typeof pixelSpacing === "undefined"){var perFrameFunctionnalGroupSequence=this._dataSet.elements.x52009230;if(typeof perFrameFunctionnalGroupSequence !== "undefined"){var planeOrientationSequence=perFrameFunctionnalGroupSequence.items[frameIndex].dataSet.elements.x00289110.items[0].dataSet;pixelSpacing = planeOrientationSequence.string("x00280030");}else {pixelSpacing = null;}}if(pixelSpacing){pixelSpacing = pixelSpacing.split("\\").map(Number);}return pixelSpacing;};VJS.parsers.dicom.prototype.sopInstanceUID = function(frameIndex){var sopInstanceUID=this._dataSet.string("x00080018");return sopInstanceUID;};VJS.parsers.dicom.prototype.sliceThickness = function(frameIndex){var sliceThickness=this._dataSet.floatString("x00180050");if(typeof sliceThickness === "undefined"){var perFrameFunctionnalGroupSequence=this._dataSet.elements.x52009230;if(typeof perFrameFunctionnalGroupSequence !== "undefined"){var planeOrientationSequence=perFrameFunctionnalGroupSequence.items[frameIndex].dataSet.elements.x00289110.items[0].dataSet;sliceThickness = planeOrientationSequence.floatString("x00180050");}else {sliceThickness = null;}}return sliceThickness;};VJS.parsers.dicom.prototype.rows = function(frameIndex){var rows=this._dataSet.uint16("x00280010");if(typeof rows === "undefined"){rows = null;}return rows;};VJS.parsers.dicom.prototype.columns = function(frameIndex){var columns=this._dataSet.uint16("x00280011");if(typeof columns === "undefined"){columns = null;}return columns;};VJS.parsers.dicom.prototype.pixelRepresentation = function(frameIndex){var pixelRepresentation=this._dataSet.uint16("x00280103");return pixelRepresentation;};VJS.parsers.dicom.prototype.bitsAllocated = function(frameIndex){var bitsAllocated=this._dataSet.uint16("x00280100");return bitsAllocated;};VJS.parsers.dicom.prototype.highBit = function(frameIndex){var highBit=this._dataSet.uint16("x00280102");return highBit;};VJS.parsers.dicom.prototype.rescaleIntercept = function(frameIndex){var rescaleIntercept=this._dataSet.floatString("x00281052");if(typeof rescaleIntercept === "undefined"){var perFrameFunctionnalGroupSequence=this._dataSet.elements.x52009230;if(typeof perFrameFunctionnalGroupSequence !== "undefined"){var philipsPrivateSequence=perFrameFunctionnalGroupSequence.items[frameIndex].dataSet.elements.x00289145.items[0].dataSet;rescaleIntercept = philipsPrivateSequence.floatString("x00281052");}else {rescaleIntercept = null;}}return rescaleIntercept;};VJS.parsers.dicom.prototype.rescaleSlope = function(frameIndex){var rescaleSlope=this._dataSet.floatString("x00281053");if(typeof rescaleSlope === "undefined"){var perFrameFunctionnalGroupSequence=this._dataSet.elements.x52009230;if(typeof perFrameFunctionnalGroupSequence !== "undefined"){var philipsPrivateSequence=perFrameFunctionnalGroupSequence.items[frameIndex].dataSet.elements.x00289145.items[0].dataSet;rescaleSlope = philipsPrivateSequence.floatString("x00281052");}else {rescaleSlope = null;}}return rescaleSlope;};VJS.parsers.dicom.prototype.windowCenter = function(frameIndex){var windowCenter=this._dataSet.floatString("x00281050");if(typeof windowCenter === "undefined"){var perFrameFunctionnalGroupSequence=this._dataSet.elements.x52009230;if(typeof perFrameFunctionnalGroupSequence !== "undefined"){var philipsPrivateSequence=perFrameFunctionnalGroupSequence.items[frameIndex].dataSet.elements.x00289132.items[0].dataSet;windowCenter = philipsPrivateSequence.floatString("x00281050");}else {windowCenter = null;}}return windowCenter;};VJS.parsers.dicom.prototype.windowWidth = function(frameIndex){var windowWidth=this._dataSet.floatString("x00281051");if(typeof windowWidth === "undefined"){var perFrameFunctionnalGroupSequence=this._dataSet.elements.x52009230;if(typeof perFrameFunctionnalGroupSequence !== "undefined"){var philipsPrivateSequence=perFrameFunctionnalGroupSequence.items[frameIndex].dataSet.elements.x00289132.items[0].dataSet;windowWidth = philipsPrivateSequence.floatString("x00281051");}else {windowWidth = null;}}return windowWidth;};VJS.parsers.dicom.prototype.dimensionIndexValues = function(frameIndex){var dimensionIndexValues=[];var perFrameFunctionnalGroupSequence=this._dataSet.elements.x52009230;if(typeof perFrameFunctionnalGroupSequence !== "undefined"){var philipsPrivateSequence=perFrameFunctionnalGroupSequence.items[frameIndex].dataSet.elements.x00209111.items[0].dataSet;var element=philipsPrivateSequence.elements.x00209157;var nbValues=element.length / 4;for(var i=0;i < nbValues;i++) {dimensionIndexValues.push(philipsPrivateSequence.uint32("x00209157",i));}}else {dimensionIndexValues = null;}return dimensionIndexValues;};VJS.parsers.dicom.prototype.inStackPositionNumber = function(frameIndex){var inStackPositionNumber=null;var perFrameFunctionnalGroupSequence=this._dataSet.elements.x52009230;if(typeof perFrameFunctionnalGroupSequence !== "undefined"){var philipsPrivateSequence=perFrameFunctionnalGroupSequence.items[frameIndex].dataSet.elements.x00209111.items[0].dataSet;inStackPositionNumber = philipsPrivateSequence.uint32("x00209057");}else {inStackPositionNumber = null;}return inStackPositionNumber;};VJS.parsers.dicom.prototype.stackID = function(frameIndex){var stackID=null;var perFrameFunctionnalGroupSequence=this._dataSet.elements.x52009230;if(typeof perFrameFunctionnalGroupSequence !== "undefined"){var philipsPrivateSequence=perFrameFunctionnalGroupSequence.items[frameIndex].dataSet.elements.x00209111.items[0].dataSet;stackID = philipsPrivateSequence.intString("x00209056");}else {stackID = null;}return stackID;};VJS.parsers.dicom.prototype.decompressPixelData = function(frameIndex){var dPixelData=[];var transferSyntaxUID=this.transferSyntaxUID();if(transferSyntaxUID === "1.2.840.10008.1.2.4.90" || transferSyntaxUID === "1.2.840.10008.1.2.4.91"){var compressedPixelData=dicomParser.readEncapsulatedPixelData(this._dataSet,this._dataSet.elements.x7fe00010,frameIndex);var jpxImage=new jpx();jpxImage.parse(compressedPixelData);var componentsCount=jpxImage.componentsCount;if(componentsCount !== 1){throw "JPEG2000 decoder returned a componentCount of " + componentsCount + ", when 1 is expected";}var tileCount=jpxImage.tiles.length;if(tileCount !== 1){throw "JPEG2000 decoder returned a tileCount of " + tileCount + ", when 1 is expected";}var tileComponents=jpxImage.tiles[0];var pixelData=tileComponents.items;return pixelData;}return dPixelData;};VJS.parsers.dicom.prototype.extractPixelData = function(frameIndex){var ePixelData=null;var transferSyntaxUID=this.transferSyntaxUID();if(transferSyntaxUID === "1.2.840.10008.1.2.4.90" || transferSyntaxUID === "1.2.840.10008.1.2.4.91"){return this.decompressPixelData(frameIndex);}var pixelRepresentation=this.pixelRepresentation(frameIndex);var bitsAllocated=this.bitsAllocated(frameIndex);var pixelDataElement=this._dataSet.elements.x7fe00010;var pixelDataOffset=pixelDataElement.dataOffset;var numberOfChannels=this.numberOfChannels();var numPixels=this.rows(frameIndex) * this.columns(frameIndex) * numberOfChannels;var frameOffset=0;if(numberOfChannels === 1){if(pixelRepresentation === 0 && bitsAllocated === 8){frameOffset = pixelDataOffset + frameIndex * numPixels;ePixelData = new Uint8Array(this._dataSet.byteArray.buffer,frameOffset,numPixels);}else if(pixelRepresentation === 0 && bitsAllocated === 16){frameOffset = pixelDataOffset + frameIndex * numPixels * 2;ePixelData = new Uint16Array(this._dataSet.byteArray.buffer,frameOffset,numPixels);}else if(pixelRepresentation === 1 && bitsAllocated === 16){frameOffset = pixelDataOffset + frameIndex * numPixels * 2;ePixelData = new Int16Array(this._dataSet.byteArray.buffer,frameOffset,numPixels);}}else {frameOffset = pixelDataOffset + frameIndex * numPixels;var encodedPixelData=new Uint8Array(this._dataSet.byteArray.buffer,frameOffset,numPixels);var photometricInterpretation=this.photometricInterpretation();if(photometricInterpretation === "RGB"){ePixelData = encodedPixelData;}else if(photometricInterpretation === "YBR_FULL"){ePixelData = new Uint8Array(numPixels);var nPixels=numPixels / 3;var ybrIndex=0;var rgbaIndex=0;for(var i=0;i < nPixels;i++) {var y=encodedPixelData[ybrIndex++];var cb=encodedPixelData[ybrIndex++];var cr=encodedPixelData[ybrIndex++];ePixelData[rgbaIndex++] = y + 1.40200 * (cr - 128);ePixelData[rgbaIndex++] = y - 0.34414 * (cb - 128) - 0.71414 * (cr - 128);ePixelData[rgbaIndex++] = y + 1.77200 * (cb - 128);ePixelData[rgbaIndex++] = 255;}}else {window.console.log("photometric interpolation not supported: " + photometricInterpretation);}}return ePixelData;};VJS.parsers.dicom.prototype.minMaxPixelData = function(pixelData){var minMax=[65535,-32768];var numPixels=pixelData.length;for(var index=0;index < numPixels;index++) {var spv=pixelData[index];minMax[0] = Math.min(minMax[0],spv);minMax[1] = Math.max(minMax[1],spv);}return minMax;};var moduleType=typeof module;if(moduleType !== "undefined" && module.exports){module.exports = VJS.parsers.dicom;}},{"./jpx.js":11,"dicom-parser":2}],13:[function(require,module,exports){"use strict";var VJS=VJS || {};VJS.shaders = VJS.shaders || {};VJS.shaders.data = {"parameters":{uniforms:{"uTextureSize":{type:"f",value:0.0},"uTextureContainer":{type:"tv",value:null},"uDataDimensions":{type:"v3",value:new THREE.Vector3()},"uWorldToData":{type:"m4",value:new THREE.Matrix4()},"uWindowLevel":{type:"fv1",value:[0.0,0.0]},"uNumberOfChannels":{type:"i",value:1},"uBitsAllocated":{type:"i",value:8},"uInvert":{type:"i",value:0},"uLut":{type:"i",value:0},"uLutI":{type:"fv1",value:[0.0]},"uLutR":{type:"fv1",value:[0.0]},"uLutG":{type:"fv1",value:[0.0]},"uLutB":{type:"fv1",value:[0.0]}}}};module.exports = VJS.shaders.data;},{}],14:[function(require,module,exports){"use strict";var VJS=VJS || {};VJS.widgets = VJS.widgets || {};VJS.widgets.orientation = function(parentID,targetCamera,targetControl){this._ParentId = parentID;this._TargetCamera = targetCamera;this._TargetControl = targetControl;this._DomElement = null;this._Renderer = null;this._Scene = null;this._Camera = null;this._Axes = null;this._Style = {width:200,height:200};this.createDomContainer();this.setupObject();};VJS.widgets.orientation.prototype.createDomContainer = function(){this._DomElement = document.createElement("div");this._DomElement.setAttribute("id","VJSOrientation");this._DomElement.style.width = this._Style.width + "px";this._DomElement.style.height = this._Style.height + "px";var parent=document.getElementById(this._ParentId);parent.appendChild(this._DomElement);};VJS.widgets.orientation.prototype.setupObject = function(){this._Renderer = new THREE.WebGLRenderer({alpha:true});this._Renderer.setClearColor(0x000000,0);this._Renderer.setSize(this._Style.width,this._Style.height);this._DomElement.appendChild(this._Renderer.domElement);this._Scene = new THREE.Scene();this._Camera = new THREE.PerspectiveCamera(50,this._Style.width / this._Style.height,1,1000);this._Camera.up = this._TargetCamera.up;this._Axes = new THREE.AxisHelper(100);this._Scene.add(this._Axes);};VJS.widgets.orientation.prototype.update = function(){this._Camera.position.copy(this._TargetCamera.position);this._Camera.position.sub(this._TargetControl.target);this._Camera.position.setLength(300);this._Camera.lookAt(this._Scene.position);this._Renderer.render(this._Scene,this._Camera);};var moduleType=typeof module;if(moduleType !== "undefined" && module.exports){module.exports = VJS.widgets.orientation;}},{}],15:[function(require,module,exports){"use strict";var VJS=VJS || {};VJS.widgets = VJS.widgets || {};VJS.widgets.pixelProbe = function(image,imageMeshes){THREE.Object3D.call(this);this.domElement = null;this.rasContainer = null;this.ijkContainer = null;this.valueContainer = null;this.imageMeshes = imageMeshes;this.image = image;this.volumeCore = null;this.marks = [];this.createDomElement();this._worldCoordinate = null;this._dataCoordinate = null;this._dataValue = null;this._labelValue = null;};VJS.widgets.pixelProbe.prototype = Object.create(THREE.Object3D.prototype);VJS.widgets.pixelProbe.prototype.constructor = VJS.widgets.pixelProbe;VJS.widgets.pixelProbe.prototype.createDomElement = function(){this.rasContainer = document.createElement("div");this.rasContainer.setAttribute("id","VJSProbeRAS");this.ijkContainer = document.createElement("div");this.ijkContainer.setAttribute("id","VJSProbeIJK");this.valueContainer = document.createElement("div");this.valueContainer.setAttribute("id","VJSProbeValue");this.domElement = document.createElement("div");this.domElement.setAttribute("id","VJSProbe");this.domElement.appendChild(this.rasContainer);this.domElement.appendChild(this.ijkContainer);this.domElement.appendChild(this.valueContainer);};VJS.widgets.pixelProbe.prototype.computeValues = function(){if(this.image){var worldToData=this.image._stack[0]._lps2IJK;var dataCoordinate=new THREE.Vector3().copy(this._worldCoordinate).applyMatrix4(worldToData);var temp=dataCoordinate.clone();dataCoordinate.x = Math.floor(dataCoordinate.x + 0.5);dataCoordinate.y = Math.floor(dataCoordinate.y + 0.5);dataCoordinate.z = Math.floor(dataCoordinate.z + 0.5);this._dataCoordinate = dataCoordinate;if(dataCoordinate.x >= 0 && dataCoordinate.y >= 0 && dataCoordinate.z >= 0){var rows=this.image._stack[0]._rows;var columns=this.image._stack[0]._columns;this._dataValue = this.image._stack[0]._frame[this._dataCoordinate.z]._pixelData[this._dataCoordinate.x + columns * this._dataCoordinate.y];}else {window.console.log("something funny happening in compute value");window.console.log(dataCoordinate);window.console.log(temp);}}};VJS.widgets.pixelProbe.prototype.updateUI = function(mouse){var rasContent=this._worldCoordinate.x.toFixed(2) + " : " + this._worldCoordinate.y.toFixed(2) + " : " + this._worldCoordinate.z.toFixed(2);this.rasContainer.innerHTML = "LPS: " + rasContent;var ijkContent=this._dataCoordinate.x + " : " + this._dataCoordinate.y + " : " + this._dataCoordinate.z;this.ijkContainer.innerHTML = "IJK: " + ijkContent;var valueContent=this._dataValue;this.valueContainer.innerHTML = "Value: " + valueContent;document.getElementById("VJSProbe").style.display = "block";document.getElementById("VJSProbe").style.top = mouse.clientY + 10;document.getElementById("VJSProbe").style.left = mouse.clientX + 10;};VJS.widgets.pixelProbe.prototype.update = function(raycaster,mouse,camera,canvas){if(!this.imageMeshes){return;}this.updateMarkDom(raycaster,mouse,camera,canvas);var intersects=raycaster.intersectObjects(this.imageMeshes);for(var intersect in intersects) {var worldCoordinates=new THREE.Vector3().copy(intersects[intersect].point);if(intersects[intersect].object.material.type === "ShaderMaterial"){this._worldCoordinate = worldCoordinates;this.computeValues();this.updateUI(mouse);return;}}this.hideUI();};VJS.widgets.pixelProbe.prototype.hideUI = function(){document.getElementById("VJSProbe").style.display = "none";};VJS.widgets.pixelProbe.prototype.mark = function(raycaster,mouse){var intersects=raycaster.intersectObjects(this.children);var worldCoordinates=null;window.console.log(this);intersects = raycaster.intersectObjects(this.imageMeshes);for(var intersect2 in intersects) {worldCoordinates = new THREE.Vector3().copy(intersects[intersect2].point);if(intersects[intersect2].object.material.type === "ShaderMaterial"){window.console.log("intersect shader material!");this._worldCoordinate = worldCoordinates;this.computeValues();for(var i=0;i < this.marks.length;i++) {if(this.marks[i].ijk.x === this._dataCoordinate.x && this.marks[i].ijk.y === this._dataCoordinate.y && this.marks[i].ijk.z === this._dataCoordinate.z){return;}}var dataToWorld=this.image._stack[0]._ijk2LPS;var worldCenterCoordinate=new THREE.Vector3().copy(this._dataCoordinate).applyMatrix4(dataToWorld);var voxDataCoord=this._dataCoordinate.clone();var voxelGeometry=new THREE.BoxGeometry(1,1,1);voxelGeometry.applyMatrix(new THREE.Matrix4().makeTranslation(this._dataCoordinate.x,this._dataCoordinate.y,this._dataCoordinate.z));voxelGeometry.applyMatrix(this.image._stack[0]._ijk2LPS);var voxelMaterial=new THREE.MeshBasicMaterial({wireframe:true,color:0xFFC107});var voxel=new THREE.Mesh(voxelGeometry,voxelMaterial);voxel.name = "pixelProbeMark";this.add(voxel);var mark={id:voxel.id,position:worldCenterCoordinate,ijk:voxDataCoord};this.marks.push(mark);window.console.log(this.marks);var domElement=this.markDom(mark,mouse);return domElement;}}};VJS.widgets.pixelProbe.prototype.markDom = function(mark,mouse){var rasContainer=document.createElement("div");rasContainer.setAttribute("class","VJSProbeRAS");var rasContent=this._worldCoordinate.x.toFixed(2) + " : " + this._worldCoordinate.y.toFixed(2) + " : " + this._worldCoordinate.z.toFixed(2);rasContainer.innerHTML = "LPS: " + rasContent;var ijkContainer=document.createElement("div");ijkContainer.setAttribute("class","VJSProbeIJK");var ijkContent=this._dataCoordinate.x + " : " + this._dataCoordinate.y + " : " + this._dataCoordinate.z;ijkContainer.innerHTML = "IJK: " + ijkContent;var valueContainer=document.createElement("div");valueContainer.setAttribute("class","VJSProbeValue");var valueContent=this._dataValue;valueContainer.innerHTML = "Value: " + valueContent;var domElement=document.createElement("div");domElement.setAttribute("id","mark" + mark.id);domElement.setAttribute("class","mark");domElement.appendChild(rasContainer);domElement.appendChild(ijkContainer);domElement.appendChild(valueContainer);domElement.style.display = "block";domElement.style.top = mouse.clientY + 10;domElement.style.left = mouse.clientX + 10;return domElement;};VJS.widgets.pixelProbe.prototype.updateMarkDom = function(raycaster,mouse,camera,canvas){for(var i=0;i < this.marks.length;i++) {var screenCoordinates=this.marks[i].position.clone();screenCoordinates.project(camera);screenCoordinates.x = Math.round((screenCoordinates.x + 1) * canvas.offsetWidth / 2);screenCoordinates.y = Math.round((-screenCoordinates.y + 1) * canvas.offsetHeight / 2);screenCoordinates.z = 0;document.getElementById("mark" + this.marks[i].id).style.top = screenCoordinates.y + 10;document.getElementById("mark" + this.marks[i].id).style.left = screenCoordinates.x + 10;}};var moduleType=typeof module;if(moduleType !== "undefined" && module.exports){module.exports = VJS.widgets.pixelProbe;}},{}]},{},[1]);
//# sourceMappingURL=../loader_dicoms/loader_dicoms.js.map