"use strict";!function e(t,i,n){function r(o,s){if(!i[o]){if(!t[o]){var l="function"==typeof require&&require;if(!s&&l)return l(o,!0);if(a)return a(o,!0);var d=new Error("Cannot find module '"+o+"'");throw d.code="MODULE_NOT_FOUND",d}var u=i[o]={exports:{}};t[o][0].call(u.exports,function(e){var i=t[o][1][e];return r(i?i:e)},u,u.exports,e,t,i,n)}return i[o].exports}for(var a="function"==typeof require&&require,o=0;o<n.length;o++)r(n[o]);return r}({1:[function(e,t,i){function n(e,t){var i=Math.round(e.loaded/e.total*100);window.console.log(t);var n=document.getElementById(t);if(n)n.innerHTML="Downloading "+t+": "+i+"%";else{var r=document.getElementById("my-progress-container"),a=document.createElement("div");a.setAttribute("id",t),a.innerHTML="Downloading "+t+": "+i+"%",r.appendChild(a)}}function r(){function e(e){m.x=e.clientX/n.offsetWidth*2-1,m.y=2*-(e.clientY/n.offsetHeight)+1,m.clientX=e.clientX,m.clientY=e.clientY}function t(e){e.preventDefault(),h.setFromCamera(m,d);var t=c.mark(h,m);if(t){var i=document.getElementById("r3d");i.appendChild(t)}}function i(){m&&h&&c&&(h.setFromCamera(m,d),c.update(h,m,d,n)),f.update(),a.update(),o.render(l,d),s.update(),requestAnimationFrame(function(){i()})}var n=document.getElementById("r3d");o=new THREE.WebGLRenderer({antialias:!0}),o.setSize(n.offsetWidth,n.offsetHeight),o.setClearColor(16777215,1);var r=o.context.getParameter(o.context.MAX_TEXTURE_SIZE);window.console.log(r),n.appendChild(o.domElement),s=new Stats,n.appendChild(s.domElement),l=new THREE.Scene,d=new THREE.PerspectiveCamera(45,n.offsetWidth/n.offsetHeight,1,1e7),d.position.x=150,d.position.y=150,d.position.z=100,d.lookAt(l.position),a=new p(d,o.domElement),f=new g("r3d",d,a),h=new THREE.Raycaster,m=new THREE.Vector2,o.domElement.addEventListener("mousemove",e,!1),o.domElement.addEventListener("mousedown",t,!1),i()}var a,o,s,l,d,u,c,h,m,f,p=e("../../modules/controls/OrbitControls2D"),y=e("../../modules/widgets/widgets.pixelProbe"),g=e("../../modules/widgets/widgets.orientation"),x=e("../../modules/loaders/loaders.dicom");window.onload=function(){function e(e){var t=new x(s);t.load(e,function(e){o.push(e)},function(){window.console.log(e),n(event,e)},function(e){window.console.log("error: ",e)})}r(),window.console.log(u);var t=new THREE.BoxGeometry(500,500,500),i=new THREE.MeshBasicMaterial({wireframe:!0,color:6323595}),a=new THREE.Mesh(t,i);l.add(a);var o=[],s=new THREE.LoadingManager;s.onProgress=function(e,t,i){window.console.log("manager progress ----"),window.console.log(e);var n=document.getElementById(e);if(n&&(n.innerHTML=" "+e+" is ready! ("+t+"/"+i+")"),t===i){window.console.log(o);for(var r=[o[0]],a=0;a<o.length;a++)for(var s=0;s<r.length&&!r[s].merge(o[a]);s++)s===r.length-1&&r.push(o[a]);r[0].prepare(),l.add(r[0]),c=new y(r[0]._series,r[0].children),l.add(c);var d=document.getElementById("r3d");d.appendChild(c.domElement)}};var d=["36749810","36749824","36749838","36749852","36749866","36749880","36749894","36749908","36749922","36749936","36749950","36749964"],h=d.map(function(e){return"../../data/dcm/adi/"+e});window.console.log(h);for(var m=0;m<h.length;m++)e(h[m])}},{"../../modules/controls/OrbitControls2D":2,"../../modules/loaders/loaders.dicom":6,"../../modules/widgets/widgets.orientation":12,"../../modules/widgets/widgets.pixelProbe":13}],2:[function(e,t,i){THREE.OrbitControls2D=function(e,t){function i(){return 2*Math.PI/60/60*f.autoRotateSpeed}function n(){return Math.pow(.95,f.zoomSpeed)}function r(e){if(f.enabled!==!1){if(e.preventDefault(),e.button===f.mouseButtons.ORBIT){if(f.noRotate===!0)return;V=C.ROTATE,y.set(e.clientX,e.clientY)}else if(e.button===f.mouseButtons.ZOOM){if(f.noZoom===!0)return;V=C.DOLLY,S.set(e.clientX,e.clientY)}else if(e.button===f.mouseButtons.PAN){if(f.noPan===!0)return;V=C.PAN,v.set(e.clientX,e.clientY)}V!==C.NONE&&(document.addEventListener("mousemove",a,!1),document.addEventListener("mouseup",o,!1),f.dispatchEvent(k))}}function a(e){if(f.enabled!==!1){e.preventDefault();var t=f.domElement===document?f.domElement.body:f.domElement;if(V===C.ROTATE){if(f.noRotate===!0)return;g.set(e.clientX,e.clientY),x.subVectors(g,y),f.rotateLeft(2*Math.PI*x.x/t.clientWidth*f.rotateSpeed),f.rotateUp(2*Math.PI*x.y/t.clientHeight*f.rotateSpeed),y.copy(g)}else if(V===C.DOLLY){if(f.noZoom===!0)return;T.set(e.clientX,e.clientY),D.subVectors(T,S),D.y>0?f.dollyIn():f.dollyOut(),S.copy(T)}else if(V===C.PAN){if(f.noPan===!0)return;_.set(e.clientX,e.clientY),w.subVectors(_,v),f.pan(w.x,w.y),v.copy(_)}V!==C.NONE&&f.update()}}function o(){f.enabled!==!1&&(document.removeEventListener("mousemove",a,!1),document.removeEventListener("mouseup",o,!1),f.dispatchEvent(L),V=C.NONE)}function s(e){if(f.enabled!==!1&&f.noZoom!==!0&&V===C.NONE){e.preventDefault(),e.stopPropagation();var t=0;void 0!==e.wheelDelta?t=e.wheelDelta:void 0!==e.detail&&(t=-e.detail),t>0?f.dollyOut():f.dollyIn(),f.update(),f.dispatchEvent(k),f.dispatchEvent(L)}}function l(e){if(f.enabled!==!1&&f.noKeys!==!0&&f.noPan!==!0)switch(e.keyCode){case f.keys.UP:f.pan(0,f.keyPanSpeed),f.update();break;case f.keys.BOTTOM:f.pan(0,-f.keyPanSpeed),f.update();break;case f.keys.LEFT:f.pan(f.keyPanSpeed,0),f.update();break;case f.keys.RIGHT:f.pan(-f.keyPanSpeed,0),f.update()}}function d(e){if(f.enabled!==!1){switch(e.touches.length){case 1:if(f.noRotate===!0)return;V=C.TOUCH_ROTATE,y.set(e.touches[0].pageX,e.touches[0].pageY);break;case 2:if(f.noZoom===!0)return;V=C.TOUCH_DOLLY;var t=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY,n=Math.sqrt(t*t+i*i);S.set(0,n);break;case 3:if(f.noPan===!0)return;V=C.TOUCH_PAN,v.set(e.touches[0].pageX,e.touches[0].pageY);break;default:V=C.NONE}V!==C.NONE&&f.dispatchEvent(k)}}function u(e){if(f.enabled!==!1){e.preventDefault(),e.stopPropagation();var t=f.domElement===document?f.domElement.body:f.domElement;switch(e.touches.length){case 1:if(f.noRotate===!0)return;if(V!==C.TOUCH_ROTATE)return;g.set(e.touches[0].pageX,e.touches[0].pageY),x.subVectors(g,y),f.rotateLeft(2*Math.PI*x.x/t.clientWidth*f.rotateSpeed),f.rotateUp(2*Math.PI*x.y/t.clientHeight*f.rotateSpeed),y.copy(g),f.update();break;case 2:if(f.noZoom===!0)return;if(V!==C.TOUCH_DOLLY)return;var i=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY,r=Math.sqrt(i*i+n*n);T.set(0,r),D.subVectors(T,S),D.y>0?f.dollyOut():f.dollyIn(),S.copy(T),f.update();break;case 3:if(f.noPan===!0)return;if(V!==C.TOUCH_PAN)return;_.set(e.touches[0].pageX,e.touches[0].pageY),w.subVectors(_,v),f.pan(w.x,w.y),v.copy(_),f.update();break;default:V=C.NONE}}}function c(){f.enabled!==!1&&(f.dispatchEvent(L),V=C.NONE)}this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.target=new THREE.Vector3,this.center=this.target,this.noZoom=!1,this.zoomSpeed=1,this.minDistance=0,this.maxDistance=1/0,this.noRotate=!1,this.rotateSpeed=1,this.noPan=!1,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-(1/0),this.maxAzimuthAngle=1/0,this.noKeys=!1,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={ORBIT:THREE.MOUSE.LEFT,ZOOM:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT};var h,m,f=this,p=1e-6,y=new THREE.Vector2,g=new THREE.Vector2,x=new THREE.Vector2,v=new THREE.Vector2,_=new THREE.Vector2,w=new THREE.Vector2,E=new THREE.Vector3,b=new THREE.Vector3,S=new THREE.Vector2,T=new THREE.Vector2,D=new THREE.Vector2,P=0,I=0,A=1,O=new THREE.Vector3,R=new THREE.Vector3,z=new THREE.Quaternion,C={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},V=C.NONE;this.target0=this.target.clone(),this.position0=this.object.position.clone();var H=(new THREE.Quaternion).setFromUnitVectors(e.up,new THREE.Vector3(0,1,0)),M=H.clone().inverse(),B={type:"change"},k={type:"start"},L={type:"end"};this.rotateLeft=function(e){void 0===e&&(e=i()),I-=e},this.rotateUp=function(e){void 0===e&&(e=i()),P-=e},this.panLeft=function(e){var t=this.object.matrix.elements;E.set(t[0],t[1],t[2]),E.multiplyScalar(-e),O.add(E)},this.panUp=function(e){var t=this.object.matrix.elements;E.set(t[4],t[5],t[6]),E.multiplyScalar(e),O.add(E)},this.pan=function(e,t){var i=f.domElement===document?f.domElement.body:f.domElement;if(void 0!==f.object.fov){var n=f.object.position,r=n.clone().sub(f.target),a=r.length();a*=Math.tan(f.object.fov/2*Math.PI/180),f.panLeft(2*e*a/i.clientHeight),f.panUp(2*t*a/i.clientHeight)}else void 0!==f.object.top?(f.panLeft(e*(f.object.right-f.object.left)/(i.clientWidth*this.object.zoom)),f.panUp(t*(f.object.top-f.object.bottom)/(i.clientHeight*this.object.zoom))):console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled.")},this.dollyIn=function(e){void 0===e&&(e=n()),void 0!==f.object.top?(this.object.zoom*=e,this.object.updateProjectionMatrix()):A/=e},this.dollyOut=function(e){void 0===e&&(e=n()),void 0!==f.object.top?(this.object.zoom/=e,this.object.updateProjectionMatrix()):A*=e},this.update=function(){var e=this.object.position;b.copy(e).sub(this.target),b.applyQuaternion(H),h=Math.atan2(b.x,b.z),m=Math.atan2(Math.sqrt(b.x*b.x+b.z*b.z),b.y),this.autoRotate&&V===C.NONE&&this.rotateLeft(i()),h+=I,m+=P,h=Math.max(this.minAzimuthAngle,Math.min(this.maxAzimuthAngle,h)),m=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,m)),m=Math.max(p,Math.min(Math.PI-p,m));var t=b.length()*A;t=Math.max(this.minDistance,Math.min(this.maxDistance,t)),this.target.add(O),b.x=t*Math.sin(m)*Math.sin(h),b.y=t*Math.cos(m),b.z=t*Math.sin(m)*Math.cos(h),b.applyQuaternion(M),e.copy(this.target).add(b),this.object.lookAt(this.target),I=0,P=0,A=1,O.set(0,0,0),(R.distanceToSquared(this.object.position)>p||8*(1-z.dot(this.object.quaternion))>p)&&(this.dispatchEvent(B),R.copy(this.object.position),z.copy(this.object.quaternion))},this.reset=function(){V=C.NONE,this.target.copy(this.target0),this.object.position.copy(this.position0),this.update()},this.getPolarAngle=function(){return m},this.getAzimuthalAngle=function(){return h},this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousedown",r,!1),this.domElement.addEventListener("mousewheel",s,!1),this.domElement.addEventListener("DOMMouseScroll",s,!1),this.domElement.addEventListener("touchstart",d,!1),this.domElement.addEventListener("touchend",c,!1),this.domElement.addEventListener("touchmove",u,!1),window.addEventListener("keydown",l,!1),this.update()},THREE.OrbitControls2D.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.OrbitControls2D.prototype.constructor=THREE.OrbitControls2D,t.exports=THREE.OrbitControls2D},{}],3:[function(e,t,i){var n=n||{};n.intersections=n.intersections||{},n.intersections.obbPlane=function(e,t){var i=[],n=t.direction.clone().applyMatrix4(e.toOBBSpace),r=new THREE.Vector3(0,0,0).applyMatrix4(e.toOBBSpace),a={position:t.position.clone().applyMatrix4(e.toOBBSpace),direction:new THREE.Vector3(n.x-r.x,n.y-r.y,n.z-r.z).normalize()},o=new THREE.Vector3(e.center.x-e.halfDimensions.x,e.center.y-e.halfDimensions.y,e.center.z-e.halfDimensions.z),s=new THREE.Vector3(e.center.x+e.halfDimensions.x,e.center.y+e.halfDimensions.y,e.center.z+e.halfDimensions.z),l={position:new THREE.Vector3(e.center.x-e.halfDimensions.x,e.center.y-e.halfDimensions.y,e.center.z-e.halfDimensions.z),direction:e.orientation.x},d=this.rayPlane(l,a);return d&&d.x>=o.x&&d.y>=o.y&&d.z>=o.z&&d.x<=s.x&&d.y<=s.y&&d.z<=s.z&&i.push(d.applyMatrix4(e.toOBBSpaceInvert)),l.direction=e.orientation.y,d=this.rayPlane(l,a),d&&d.x>=o.x&&d.y>=o.y&&d.z>=o.z&&d.x<=s.x&&d.y<=s.y&&d.z<=s.z&&i.push(d.applyMatrix4(e.toOBBSpaceInvert)),l.direction=e.orientation.z,d=this.rayPlane(l,a),d&&d.x>=o.x&&d.y>=o.y&&d.z>=o.z&&d.x<=s.x&&d.y<=s.y&&d.z<=s.z&&i.push(d.applyMatrix4(e.toOBBSpaceInvert)),l={position:new THREE.Vector3(e.center.x+e.halfDimensions.x,e.center.y+e.halfDimensions.y,e.center.z+e.halfDimensions.z),direction:e.orientation.x},d=this.rayPlane(l,a),d&&d.x>=o.x&&d.y>=o.y&&d.z>=o.z&&d.x<=s.x&&d.y<=s.y&&d.z<=s.z&&i.push(d.applyMatrix4(e.toOBBSpaceInvert)),l.direction=e.orientation.y,d=this.rayPlane(l,a),d&&d.x>=o.x&&d.y>=o.y&&d.z>=o.z&&d.x<=s.x&&d.y<=s.y&&d.z<=s.z&&i.push(d.applyMatrix4(e.toOBBSpaceInvert)),l.direction=e.orientation.z,d=this.rayPlane(l,a),d&&d.x>=o.x&&d.y>=o.y&&d.z>=o.z&&d.x<=s.x&&d.y<=s.y&&d.z<=s.z&&i.push(d.applyMatrix4(e.toOBBSpaceInvert)),l={position:new THREE.Vector3(e.center.x+e.halfDimensions.x,e.center.y-e.halfDimensions.y,e.center.z-e.halfDimensions.z),direction:e.orientation.y},d=this.rayPlane(l,a),d&&d.x>=o.x&&d.y>=o.y&&d.z>=o.z&&d.x<=s.x&&d.y<=s.y&&d.z<=s.z&&i.push(d.applyMatrix4(e.toOBBSpaceInvert)),l.direction=e.orientation.z,d=this.rayPlane(l,a),d&&d.x>=o.x&&d.y>=o.y&&d.z>=o.z&&d.x<=s.x&&d.y<=s.y&&d.z<=s.z&&i.push(d.applyMatrix4(e.toOBBSpaceInvert)),l={position:new THREE.Vector3(e.center.x-e.halfDimensions.x,e.center.y+e.halfDimensions.y,e.center.z-e.halfDimensions.z),direction:e.orientation.x},d=this.rayPlane(l,a),d&&d.x>=o.x&&d.y>=o.y&&d.z>=o.z&&d.x<=s.x&&d.y<=s.y&&d.z<=s.z&&i.push(d.applyMatrix4(e.toOBBSpaceInvert)),l.direction=e.orientation.z,d=this.rayPlane(l,a),d&&d.x>=o.x&&d.y>=o.y&&d.z>=o.z&&d.x<=s.x&&d.y<=s.y&&d.z<=s.z&&i.push(d.applyMatrix4(e.toOBBSpaceInvert)),l={position:new THREE.Vector3(e.center.x-e.halfDimensions.x,e.center.y-e.halfDimensions.y,e.center.z+e.halfDimensions.z),direction:e.orientation.x},d=this.rayPlane(l,a),d&&d.x>=o.x&&d.y>=o.y&&d.z>=o.z&&d.x<=s.x&&d.y<=s.y&&d.z<=s.z&&i.push(d.applyMatrix4(e.toOBBSpaceInvert)),l.direction=e.orientation.y,d=this.rayPlane(l,a),d&&d.x>=o.x&&d.y>=o.y&&d.z>=o.z&&d.x<=s.x&&d.y<=s.y&&d.z<=s.z&&i.push(d.applyMatrix4(e.toOBBSpaceInvert)),i},n.intersections.rayPlane=function(e,t){if(0!==e.direction.dot(t.direction)){var i=(t.direction.x*(t.position.x-e.position.x)+t.direction.y*(t.position.y-e.position.y)+t.direction.z*(t.position.z-e.position.z))/(t.direction.x*e.direction.x+t.direction.y*e.direction.y+t.direction.z*e.direction.z),n=new THREE.Vector3(e.position.x+i*e.direction.x,e.position.y+i*e.direction.y,e.position.z+i*e.direction.z);return n}return null},t.exports=n.intersections},{}],4:[function(e,t,i){var n=e("../core/Intersections"),r=r||{};r.geometries=r.geometries||{},r.geometries.slice=function(e,t,i,r,a){var o={halfDimensions:e,center:t,orientation:i,toOBBSpace:new THREE.Matrix4,toOBBSpaceInvert:new THREE.Matrix4},s={position:r,direction:a},l=n.obbPlane(o,s);l.length<3&&(window.console.log("WARNING: Less than 3 intersections between OBB and Plane."),window.console.log("OBB"),window.console.log(o),window.console.log("Plane"),window.console.log(s),window.console.log("exiting..."));for(var d=this.centerOfMass(l),u=this.orderIntersections(l,d,a),c=[],h=[],m=0;m<u.length;m++)c.push(u[m].point),h.push(u[m].xy);var f=new THREE.Shape;f.moveTo(h[0].x,h[0].y);for(var p=1;p<h.length;p++)f.lineTo(h[p].x,h[p].y);f.lineTo(h[0].x,h[0].y),THREE.ShapeGeometry.call(this,f),this.type="SliceGeometry",this.vertices=c,this.verticesNeedUpdate=!0},r.geometries.slice.prototype=Object.create(THREE.ShapeGeometry.prototype),r.geometries.slice.prototype.constructor=r.geometries.slice,r.geometries.slice.prototype.centerOfMass=function(e){for(var t=new THREE.Vector3(0,0,0),i=0;i<e.length;i++)t.x+=e[i].x,t.y+=e[i].y,t.z+=e[i].z;return t.divideScalar(e.length),t},r.geometries.slice.prototype.orderIntersections=function(e,t,i){for(var n=e[0].x,r=e[0].y,a=e[0].z,o=e[0].x-t.x,s=e[0].y-t.y,l=e[0].z-t.z,d={origin:new THREE.Vector3(n,r,a),direction:new THREE.Vector3(o,s,l).normalize()},u=new THREE.Vector3(0,0,0).crossVectors(d.direction,i).normalize(),c=[],h=0;h<e.length;h++){var m=e[h].x,f=e[h].y,p=e[h].z,y=e[h].x-t.x,g=e[h].y-t.y,x=e[h].z-t.z,v={origin:new THREE.Vector3(m,f,p),direction:new THREE.Vector3(y,g,x).normalize()},_=d.direction.dot(v.direction),w=u.dot(v.direction),E=Math.atan2(w,_),b=E*(180/Math.PI);c.push({angle:b,point:v.origin,xy:{x:_,y:w}})}return c.sort(function(e,t){return e.angle-t.angle}),c},t.exports=r.geometries.slice},{"../core/Intersections":3}],5:[function(e,t,i){var n=e("../geometries/geometries.slice"),r=e("../shaders/shaders.data"),a=a||{};a.helpers=a.helpers||{},a.helpers.series=function(){THREE.Object3D.call(this),this._series=null,this._uniforms=null,this._frameIndex=null,this._slice=null,this._border=null},a.helpers.series.prototype=Object.create(THREE.Object3D.prototype),a.helpers.series.prototype.constructor=a.helpers.series,a.helpers.series.prototype.merge=function(e){return this._series.merge(e._series)},a.helpers.series.prototype.addSeries=function(e){this._series=e},a.helpers.series.prototype.getStack=function(e){return e},a.helpers.series.prototype.prepare=function(){if(window.console.log("helpers Series Prepare!!!"),this._series){var e=this._series._stack[0];e.prepare(),window.console.log(e);var t=e._dimensions,i=e._halfDimensions,a=new THREE.Vector3(-.5,-.5,-.5),o=new THREE.BoxGeometry(t.x,t.y,t.z);o.applyMatrix((new THREE.Matrix4).makeTranslation(i.x+a.x,i.y+a.y,i.z+a.z)),o.applyMatrix(e._ijk2LPS);var s=new THREE.MeshBasicMaterial({wireframe:!0,color:6419187}),l=new THREE.Mesh(o,s);this.add(l);var d=new THREE.Vector3(0,0,0),u=new THREE.Vector3(new THREE.Vector3(1,0,0),new THREE.Vector3(0,1,0),new THREE.Vector3(0,0,1)),c=new THREE.Vector3(Math.floor(e._halfDimensions.x),Math.floor(e._halfDimensions.y),Math.floor(e._halfDimensions.z)+.5-e._halfDimensions.z),h=new THREE.Vector3(0,0,1),m=new n(i,d,u,c,h);m.applyMatrix((new THREE.Matrix4).makeTranslation(i.x+a.x,i.y+a.y,i.z+a.z)),m.applyMatrix(e._ijk2LPS),this._frameIndex=Math.round(i.z);for(var f=[],p=0;p<e._nbTextures;p++){var y=new THREE.DataTexture(e._rawData[p],e._textureSize,e._textureSize,THREE.RGBFormat,THREE.UnsignedByteType,THREE.UVMapping,THREE.ClampToEdgeWrapping,THREE.ClampToEdgeWrapping,THREE.NearestFilter,THREE.NearestFilter);y.needsUpdate=!0,f.push(y)}var g=new THREE.ShaderMaterial({side:THREE.DoubleSide,transparency:!0,uniforms:r.parameters.uniforms,vertexShader:"#define GLSLIFY 1\nvarying highp vec4 vPos;\n\n//\n// main\n//\nvoid main() {\n\n  vPos = modelMatrix * vec4(position, 1.0 );\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0 );\n\n}",fragmentShader:"#define GLSLIFY 1\nvec4 sampleAs3DTexture(sampler2D textureContainer[16], vec3 textureCoordinate, vec3 dataSize, float textureSize) {\n\n  float slicePixelSize = 1.0 / textureSize;\n  // Model coordinate (IJK) to data index\n  float index = textureCoordinate.x * dataSize.x + textureCoordinate.y * dataSize.y * dataSize.x + textureCoordinate.z * dataSize.z * dataSize.y * dataSize.x;\n\n  // Map data index to right sampler2D texture\n  float textureIndex = floor(index / (textureSize*textureSize));\n  float inTextureIndex = mod(index, textureSize*textureSize);\n\n  // Get row and column in the texture\n  float rowIndex = floor(inTextureIndex/textureSize);\n  float colIndex = mod(inTextureIndex, textureSize);\n\n  // Map row and column to uv\n  vec2 uv = vec2(0,0);\n  uv.x = slicePixelSize * 0.5 + colIndex * slicePixelSize;\n  uv.y = 1.0 - (slicePixelSize * 0.5 + rowIndex * slicePixelSize);\n\n  vec4 dataValue = vec4(0, 0, 0, 1);\n  if(textureIndex == 0.0){\n    dataValue = texture2D(textureContainer[0], uv);\n  }\n  else if(textureIndex == 1.0){\n    dataValue = texture2D(textureContainer[1], uv);\n  }\n  else if(textureIndex == 2.0){\n    dataValue = texture2D(textureContainer[2], uv);\n  }\n  else if(textureIndex == 3.0){\n    dataValue = texture2D(textureContainer[3], uv);\n  }\n  else if(textureIndex == 4.0){\n    dataValue = texture2D(textureContainer[4], uv);\n  }\n  else if(textureIndex == 5.0){\n    dataValue = texture2D(textureContainer[5], uv);\n  }\n  else if(textureIndex == 6.0){\n    dataValue = texture2D(textureContainer[6], uv);\n  }\n  else if(textureIndex == 7.0){\n    dataValue = texture2D(textureContainer[7], uv);\n  }\n  else if(textureIndex == 8.0){\n    dataValue = texture2D(textureContainer[8], uv);\n  }\n  else if(textureIndex == 9.0){\n    dataValue = texture2D(textureContainer[9], uv);\n  }\n  else if(textureIndex == 10.0){\n    dataValue = texture2D(textureContainer[10], uv);\n  }\n  else if(textureIndex == 11.0){\n    dataValue = texture2D(textureContainer[11], uv);\n  }\n  else if(textureIndex == 12.0){\n    dataValue = texture2D(textureContainer[12], uv);\n  }\n  else if(textureIndex == 13.0){\n    dataValue = texture2D(textureContainer[13], uv);\n  }\n  else if(textureIndex == 14.0){\n    dataValue = texture2D(textureContainer[14], uv);\n  }\n  else if(textureIndex == 15.0){\n    dataValue = texture2D(textureContainer[15], uv);\n  }\n  else {\n    discard;\n  }\n\n  return dataValue;\n}\n\nuniform lowp float uTextureSize;\nuniform lowp float uWindowLevel[2];\nuniform sampler2D uTextureContainer[16];\nuniform vec3 uDataDimensions;\nuniform mat4 uWorldToData;\nuniform int uNumberOfChannels;\nuniform int uBitsAllocated;\nuniform int uInvert;\n\n// hack because can not pass arrays if too big\n// best would be to pass texture but have to deal with 16bits\nuniform int uLut;\nuniform lowp float uLutI[16]; // 16 * 4 (intesity - r- g - b)\nuniform lowp float uLutR[16];\nuniform lowp float uLutG[16];\nuniform lowp float uLutB[16];\n\nvarying vec4 vPos;\n\nvoid main(void) {\n\n  // get texture coordinates of current pixel\n  // might not be the right way to do it:\n  // precision issues ar voxels limits\n  // need to add machine epsilon?\n  vec4 dataCoordinateRaw = uWorldToData * vPos;\n  dataCoordinateRaw += 0.5;\n  vec3 dataCoordinate = vec3(floor(dataCoordinateRaw.x), floor(dataCoordinateRaw.y), floor(dataCoordinateRaw.z));\n\n\n  // if data in range, look it up in the texture!\n  if(dataCoordinate.x >= 0.0\n  && dataCoordinate.y >= 0.0\n  && dataCoordinate.z >= 0.0\n  && dataCoordinate.x < uDataDimensions.x\n  && dataCoordinate.y < uDataDimensions.y\n  && dataCoordinate.z < uDataDimensions.z\n  ){\n    vec3 textureCoordinate = dataCoordinate/uDataDimensions;\n    vec4 dataValue = sampleAs3DTexture(uTextureContainer, textureCoordinate, uDataDimensions, uTextureSize);\n    \n\n    // Threshold? to copr intensities out?\n\n    if(uNumberOfChannels == 1){\n      // reconstruct 16bits data if any\n      float rawValue = dataValue.r * 255.0 * 256.0 + dataValue.g * 255.0;\n      float windowMin = uWindowLevel[0] - uWindowLevel[1]/2.0;\n      float windowMax = uWindowLevel[0] + uWindowLevel[1]/2.0;\n      float combined = ( rawValue - windowMin ) / uWindowLevel[1];\n\n      dataValue.r = dataValue.g = dataValue.b = combined;\n    }\n\n    // Apply LUT table...\n    // will pass it through a texture...\n\n    if(uLut == 1){\n    float lut[12];\n    // float[12](0.0, 1.0, 0.0, 0.0, 0.5, 1.0. 1.0. 0.0, 1.0, 1.0, 1.0, 1.0);\n    lut[0] = 0.0;\n    lut[1] = 1.0;\n    lut[2] = 0.0;\n    lut[3] = 0.0;\n\n    lut[4] = 0.5;\n    lut[5] = 1.0;\n    lut[6] = 1.0;\n    lut[7] = 0.0;\n\n    lut[8] = 1.0;\n    lut[9] = 1.0;\n    lut[10] = 1.0;\n    lut[11] = 1.0;\n    // if uApplyLUT\n    // if LUT Gradation? Interpolation\n    // get LUT from texture\n    for(int i=0; i<16; i++){\n      if(dataValue.r < uLutI[i]){\n        // i and i-1\n        float dataValuePosition = dataValue.r - uLutI[i-1];\n        float lutRange = uLutI[i] - uLutI[i-1];\n        float lutWeight = dataValuePosition/lutRange;\n        // use gradation or not??\n        // color distance\n        float colorDistanceR = uLutR[i] - uLutR[i-1];\n        float colorDistanceG = uLutG[i] - uLutG[i-1];\n        float colorDistanceB = uLutB[i] - uLutB[i-1];\n\n        // by weight\n        float colorIncrementR = lutWeight * colorDistanceR;\n        float colorIncrementG = lutWeight * colorDistanceG;\n        float colorIncrementB = lutWeight * colorDistanceB;\n\n        // add it\n        dataValue.r = uLutR[i-1] + colorIncrementR;\n        dataValue.g = uLutG[i-1] + colorIncrementG;\n        dataValue.b = uLutB[i-1] + colorIncrementB;\n        // dataValue.r += colorIncrementR;\n        // dataValue.g += colorIncrementG;\n        // dataValue.b += colorIncrementB;\n       break;\n     }\n    }\n    }\n\n    // Apply label map...?\n    // target specific intensity\n\n    if(uInvert == 1){\n      dataValue = vec4(1, 1, 1, 1) - dataValue;\n      dataValue.a = 1.0;\n    }\n\n    gl_FragColor = dataValue;\n  }\n  else{\n    // should be able to choose what we want to do if not in range:\n    // discard or specific color\n    //discard;\n    gl_FragColor = vec4(0.011, 0.662, 0.956, 1.0);\n  }\n}"}),x=g.clone();this._uniforms=x.uniforms,this._uniforms.uTextureSize.value=e._textureSize,this._uniforms.uTextureContainer.value=f,this._uniforms.uDataDimensions.value=e._dimensions,this._uniforms.uWorldToData.value=e._lps2IJK,this._uniforms.uWindowLevel.value=e._windowLevel,this._uniforms.uNumberOfChannels.value=e._numberOfChannels,this._uniforms.uBitsAllocated.value=e._bitsAllocated,this._uniforms.uInvert.value=e._invert,this._slice=new THREE.Mesh(m,x),this.add(this._slice);for(var v=new THREE.LineBasicMaterial({color:16711680,polygonOffset:!0,polygonOffsetFactor:-.1}),_=new THREE.Geometry,w=0;w<m.vertices.length;w++)_.vertices.push(m.vertices[w]);_.vertices.push(m.vertices[0]),this._border=new THREE.Line(_,v),this.add(this._border)}else window.console.log("no series to be prepared...")},a.helpers.series.prototype.updateSliceGeometry=function(){var e=this._series._stack[0],t=e._halfDimensions,i=new THREE.Vector3(-.5,-.5,-.5),r=new THREE.Vector3(0,0,0),a=new THREE.Vector3(new THREE.Vector3(1,0,0),new THREE.Vector3(0,1,0),new THREE.Vector3(0,0,1)),o=new THREE.Vector3(0,0,this._frameIndex+.5-e._halfDimensions.z),s=new THREE.Vector3(0,0,1),l=new n(t,r,a,o,s);l.applyMatrix((new THREE.Matrix4).makeTranslation(t.x+i.x,t.y+i.y,t.z+i.z)),l.applyMatrix(e._ijk2LPS),this._slice.geometry=l,this._slice.geometry.verticesNeedUpdate=!0},a.helpers.series.prototype.updateBorderGeometry=function(){for(var e=new THREE.Geometry,t=0;t<this._slice.geometry.vertices.length;t++)e.vertices.push(this._slice.geometry.vertices[t]);e.vertices.push(this._slice.geometry.vertices[0]),this._border.geometry.vertices=e.vertices,this._border.geometry.verticesNeedUpdate=!0},t.exports=a.helpers.series},{"../geometries/geometries.slice":4,"../shaders/shaders.data":11}],6:[function(e,t,i){var n=n||{};n.parsers=n.parsers||{},n.parsers.dicom=n.parsers.dicom||e("../parsers/parsers.dicom"),n.models=n.models||{},n.models.series=n.models.series||e("../models/models.series"),n.models.stack=n.models.stack||e("../models/models.stack"),n.models.frame=n.models.frame||e("../models/models.frame"),n.helpers=n.helpers||{},n.helpers.series=n.helpers.series||e("../helpers/helpers.series"),n.loaders=n.loaders||{},n.loaders.dicom=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager,this.crossOrigin=!0,this.responseType="arraybuffer",this._imageHelper=null,this._image=null},n.loaders.dicom.prototype.constructor=n.loaders.dicom,n.loaders.dicom.prototype.load=function(e,t,i,n){var r=this,a=new THREE.XHRLoader(r.manager);a.setCrossOrigin(this.crossOrigin),a.setResponseType(this.responseType),a.load(e,function(e){t(r.parse(e))},i,n)},n.loaders.dicom.prototype.parse=function(e){window.console.log(e),window.console.log("file downloaded yay!");var t=new n.helpers.series,i=new n.parsers.dicom(e,t.id),r=new n.models.series;r._seriesInstanceUID=i.seriesInstanceUID(),r._numberOfFrames=i.numberOfFrames(),r._numberOfFrames||(r._numberOfFrames=1),r._numberOfChannels=i.numberOfChannels();var a=new n.models.stack;a._numberOfChannels=i.numberOfChannels(),r._stack.push(a);for(var o=0;o<r._numberOfFrames;o++){var s=new n.models.frame;s._rows=i.rows(o),s._columns=i.columns(o),s._pixelData=i.extractPixelData(o),s._pixelSpacing=i.pixelSpacing(o),s._sliceThickness=i.sliceThickness(o),s._imageOrientation=i.imageOrientation(o),s._imagePosition=i.imagePosition(o),s._dimensionIndexValues=i.dimensionIndexValues(o),s._bitsAllocated=i.bitsAllocated(o),s._instanceNumber=i.instanceNumber(o),s._minMax=i.minMaxPixelData(s._pixelData),a._frame.push(s)}return t.addSeries(r),t},t.exports=n.loaders.dicom},{"../helpers/helpers.series":5,"../models/models.frame":7,"../models/models.series":8,"../models/models.stack":9,"../parsers/parsers.dicom":10}],7:[function(e,t,i){var n=n||{};n.models=n.models||{},n.models.frame=function(){this._id="-1",this._stackID=-1,this._rows=0,this._columns=0,this._dimensionIndexValues=[],this._imagePositionPatient={x:0,y:0,z:0},this._imageOrientationPatient={row:{x:0,y:0,z:0},column:{x:0,y:0,z:0}},this._sliceThickness=1,this._pixelSpacing={row:1,column:1},this._spacingBetweenSlices=null,this._pixelData=null,this._instanceNumber=null,this._minMax=null},n.models.frame.prototype.constructor=n.models.frame,t.exports=n.models.frame},{}],8:[function(e,t,i){var n=n||{};n.models=n.models||{},n.models.series=function(){this._id=-1,this._concatenationUID=-1,this._seriesInstanceUID=-1,this._seriesNumber=-1,this._dimensionIndexSequence=[],this._rows=0,this._columns=0,this._photometricInterpretation="",this._numberOfFrames=0,this._numberOfChannels=1,this._instanceNumber=0,this._stack=[]},n.models.series.prototype.merge=function(e){var t=!1;if(this._seriesInstanceUID===e._seriesInstanceUID){window.console.log("stacks belong to same series!"),t=!0;for(var i=e._stack,n=0;n<i.length;n++)for(var r=0;r<this._stack.length;r++){if(window.console.log(this._stack[r],i[n]),this._stack[r].merge(i[n])){window.console.log("stacks merged successfully!");break}r===this._stack.length-1&&(window.console.log("stacks added to the list!"),this._stack.push(i[n]))}}return t},t.exports=n.models.series},{}],9:[function(e,t,i){var n=n||{};n.models=n.models||{},n.models.stack=function(){this._id="-1",this._uid=null,this._stackID=-1,this._frame=[],this._rows=0,this._columns=0,this._numberOfFrames=0,this._pixelSpacing={row:0,column:0},this._spacingBetweenSlices=0,this._sliceThickness=0,this._origin=null,this._halfDimensions=null,this._orientation=null,this._textureSize=4096,this._nbTextures=7,this._rawData=[],this._windowLevel=[0,0],this._windowCenter=0,this._windowWidth=0,this._minMax=[65535,-32768],this._invert=0,this._ijk2LPS=null,this._lps2IJK=null,this._dimensions=null,this._spacing=null,this._origin=null,this._direction=null},n.models.stack.prototype.prepare=function(){this._numberOfFrames=this._frame.length,window.console.log(this),this.orderFrames();var e=this.zSpacing();this._frame[0]._pixelSpacing?(this._pixelSpacing.row=this._frame[0]._pixelSpacing[0],this._pixelSpacing.column=this._frame[0]._pixelSpacing[1]):this._frame[0]._pixelAspectRatio?(this._pixelSpacing.row=1,this._pixelSpacing.column=1*this._frame[0]._pixelAspectRatio[1]/this._frame[0]._pixelAspectRatio[0]):(this._pixelSpacing.row=1,this._pixelSpacing.column=1),this._frame[0]._imagePosition||(this._frame[0]._imagePosition=[0,0,0]),this._frame[0]._imageOrientation||(this._frame[0]._imageOrientation=[1,0,0,0,1,0]),this._rows=this._frame[0]._rows,this._columns=this._frame[0]._columns,this._dimensions=new THREE.Vector3(this._columns,this._rows,this._numberOfFrames),this._spacingBetweenSlices=this._frame[0]._spacingBetweenSlices,this._sliceThickness=this._frame[0]._sliceThickness;for(var t=0;t<this._frame.length;t++)this._rows!==this._frame[t]._rows&&(window.console.log("Numbers of rows in stack's frames is not consistent."),window.console.log(this),window.console.log("First frame had: ",this._rows," rows"),window.console.log("Frame index: ",t," has: ",this._frame[t]._rows," rows.")),this._columns!==this._frame[t]._columns&&(window.console.log("Numbers of columns in stack's frames is not consistent."),window.console.log(this),window.console.log("First frame had: ",this._columns," columns."),window.console.log("Frame index: ",t," has: ",this.frame[t]._columns," columns.")),this._minMax[0]=Math.min(this._minMax[0],this._frame[t]._minMax[0]),this._minMax[1]=Math.max(this._minMax[1],this._frame[t]._minMax[1]);this._origin=new THREE.Vector3(this._frame[0]._imagePosition[0],this._frame[0]._imagePosition[1],this._frame[0]._imagePosition[2]),window.console.log("first frame value!"),
window.console.log(this._frame[0]._imageOrientation[0]);var i=new THREE.Vector3(this._frame[0]._imageOrientation[0],this._frame[0]._imageOrientation[1],this._frame[0]._imageOrientation[2]);window.console.log(i);var n=new THREE.Vector3(this._frame[0]._imageOrientation[3],this._frame[0]._imageOrientation[4],this._frame[0]._imageOrientation[5]),r=new THREE.Vector3(0,0,0).crossVectors(i,n).normalize();this._direction=new THREE.Matrix4,this._direction.set(i.x,n.x,r.x,0,i.y,n.y,r.y,0,i.z,n.z,r.z,0,0,0,0,1),window.console.log(this._direction),this._spacing=new THREE.Vector3(this._pixelSpacing.row,this._pixelSpacing.column,e),window.console.log(this._spacing),this._halfDimensions=new THREE.Vector3(this._dimensions.x/2,this._dimensions.y/2,this._dimensions.z/2);var a=new THREE.Vector3(1,0,0),o=new THREE.Vector3(0,1,0),s=new THREE.Vector3(0,0,1);this._orientation=new THREE.Vector3(a,o,s),this._ijk2LPS=new THREE.Matrix4,this._ijk2LPS.set(i.x*this._spacing.x,n.x*this._spacing.y,r.x*this._spacing.z,this._origin.x,i.y*this._spacing.x,n.y*this._spacing.y,r.y*this._spacing.z,this._origin.y,i.z*this._spacing.x,n.z*this._spacing.y,r.z*this._spacing.z,this._origin.z,0,0,0,1),this._lps2IJK=new THREE.Matrix4,this._lps2IJK.getInverse(this._ijk2LPS),window.console.log(this._lps2IJK,this._ijk2LPS,this._direction);var l=this._dimensions.x*this._dimensions.y*this._dimensions.z;window.console.log(this._dimensions);for(var d=0;d<this._nbTextures;d++)this._rawData.push(new Uint8Array(this._textureSize*this._textureSize*3));var u=this._dimensions.x*this._dimensions.y,c=this._textureSize*this._textureSize;console.time("arrangeDataForWebgl");for(var h=0;l>h;h++){var m=Math.floor(h/u),f=h%u,p=Math.floor(h/c),y=h%c;if(3===this._numberOfChannels)this._rawData[p][3*y]=this._frame[m]._pixelData[3*f],this._rawData[p][3*y+1]=this._frame[m]._pixelData[3*f+1],this._rawData[p][3*y+2]=this._frame[m]._pixelData[3*f+2];else{var g=this._frame[m]._pixelData[f],x=255&g,v=g>>8&255;this._rawData[p][3*y]=v,this._rawData[p][3*y+1]=x,this._rawData[p][3*y+2]=m}}var _=this._minMax[1]-this._minMax[0],w=this._minMax[0]+_/2;this._windowWidth=_,this._windowCenter=w,this._windowLevel=[w,_],this._bitsAllocated=this._frame[0]._bitsAllocated,window.console.log("window level: ",this._windowLevel)},n.models.stack.prototype.orderFrameOnDimensionIndices=function(e,t){if("_dimensionIndexValues"in e&&"[object Array]"===Object.prototype.toString.call(e._dimensionIndexValues)&&"_dimensionIndexValues"in t&&"[object Array]"===Object.prototype.toString.call(t._dimensionIndexValues))for(var i=0;i<e._dimensionIndexValues.length;i++){if(parseInt(e._dimensionIndexValues[i])>parseInt(t._dimensionIndexValues[i]))return 1;if(parseInt(e._dimensionIndexValues[i])<parseInt(t._dimensionIndexValues[i]))return-1}else window.console.log("One of the frames doesn't have a _dimensionIndexValues array."),window.console.log(e),window.console.log(t);return 0},n.models.stack.prototype.orderFrames=function(){if(window.console.log(this),this._frame[0]._dimensionIndexValues)this._frame.sort(n.models.stack.prototype.orderFrameOnDimensionIndices);else if(this._frame[0]._imagePosition&&this._frame[0]._imageOrientation){var e=function(e,t){return t._dist=t._imagePosition[0]*e.x+t._imagePosition[1]*e.y+t._imagePosition[2]*e.z,t},t=new THREE.Vector3(this._frame[0]._imageOrientation[0],this._frame[0]._imageOrientation[1],this._frame[0]._imageOrientation[2]),i=new THREE.Vector3(this._frame[0]._imageOrientation[3],this._frame[0]._imageOrientation[4],this._frame[0]._imageOrientation[5]),r=new THREE.Vector3(0,0,0).crossVectors(t,i).normalize();this._frame.map(e.bind(null,r)),window.console.log(this._frame),this._frame.sort(function(e,t){return e._dist-t._dist}),window.console.log(this._frame)}},n.models.stack.prototype.zSpacing=function(){var e=1;if(window.console.log(this._frame[0]),this._numberOfFrames>1)if(this._spacingBetweenSlices)e=this._spacingBetweenSlices;else if(this._frame[0]._sliceThickness)e=this._frame[0]._sliceThickness;else{var t=function(e,t){return t._dist=t._imagePosition[0]*e.x+t._imagePosition[1]*e.y+t._imagePosition[2]*e.z,t},i=new THREE.Vector3(this._frame[0]._imageOrientation[0],this._frame[0]._imageOrientation[1],this._frame[0]._imageOrientation[2]),n=new THREE.Vector3(this._frame[0]._imageOrientation[3],this._frame[0]._imageOrientation[4],this._frame[0]._imageOrientation[5]),r=new THREE.Vector3(0,0,0).crossVectors(i,n).normalize();this._frame.map(t.bind(null,r)),window.console.log(this._frame),this._frame.sort(function(e,t){return e._dist-t._dist}),e=this._frame[1]._dist-this._frame[0]._dist}return 0===e&&(e=1),e},n.models.stack.prototype.merge=function(e){var t=!1;if(this._stackID===e._stackID){t=!0;for(var i=e._frame,n=0;n<i.length;n++)for(var r=0;r<this._frame.length;r++){if(this._frame[r]._dimensionIndexValues&&i[n]._dimensionIndexValues&&this._frame[r]._dimensionIndexValues.join()===i[n]._dimensionIndexValues.join()||this._frame[r]._instanceNumber&&i[n]._instanceNumber&&this._frame[r]._instanceNumber===i[n]._instanceNumber||this._frame[r]._imagePosition&&i[n]._imagePosition&&this._frame[r]._imagePosition.join()===i[n]._imagePosition.join()&&this._frame[r]._imageOrientation&&i[n]._imageOrientation&&this._frame[r]._imageOrientation.join()===i[n]._imageOrientation.join()){window.console.log("BREAKING!"),window.console.log(i[n],this._frame[r]);break}if(r===this._frame.length-1){window.console.log("PUSHING FRAME TO STACK!"),this._frame.push(i[n]);break}}}return window.console.log(this),t},t.exports=n.models.stack},{}],10:[function(e,t,i){var n=e("dicom-parser"),r=r||{};r.parsers=r.parsers||{},r.parsers.dicom=function(e,t){this._id=t,this._arrayBuffer=e;var i=new Uint8Array(e);this._dataSet=n.parseDicom(i)},r.parsers.dicom.prototype.seriesInstanceUID=function(){return this._dataSet.string("x0020000e")},r.parsers.dicom.prototype.modality=function(){return this._dataSet.string("x00080060")},r.parsers.dicom.prototype.sopInstanceUID=function(){return this._dataSet.string("x00200018")},r.parsers.dicom.prototype.transferSyntaxUID=function(){return this._dataSet.string("x00020010")},r.parsers.dicom.prototype.photometricInterpretation=function(){return this._dataSet.string("x00280004")},r.parsers.dicom.prototype.planarConfiguration=function(){var e=this._dataSet.uint16("x00280006");return"undefined"==typeof e&&(e=null),e},r.parsers.dicom.prototype.samplesPerPixel=function(){return this._dataSet.uint16("x00280002")},r.parsers.dicom.prototype.numberOfFrames=function(){var e=this._dataSet.intString("x00280008");return"undefined"==typeof e&&(e=null),e},r.parsers.dicom.prototype.numberOfChannels=function(){var e=1,t=this.photometricInterpretation();return("RGB"===t||"PALETTE COLOR"===t||"YBR_FULL"===t||"YBR_FULL_422"===t||"YBR_PARTIAL_422"===t||"YBR_PARTIAL_420"===t||"YBR_RCT"===t)&&(e=3),e},r.parsers.dicom.prototype.imageOrientation=function(e){var t=this._dataSet.string("x00200037");if("undefined"==typeof t){var i=this._dataSet.elements.x52009230;if("undefined"!=typeof i){var n=i.items[e].dataSet.elements.x00209116.items[0].dataSet;t=n.string("x00200037")}else t=null}return t&&(t=t.split("\\").map(Number)),t},r.parsers.dicom.prototype.pixelAspectRatio=function(){var e=[this._dataSet.intString("x00280034",0),this._dataSet.intString("x00280034",1)];return"undefined"==typeof e[0]&&(e=null),e},r.parsers.dicom.prototype.imagePosition=function(e){var t=null,i=this._dataSet.elements.x52009230;if("undefined"!=typeof i){var n=i.items[e].dataSet.elements.x00209113.items[0].dataSet;t=n.string("x00200032")}else t=this._dataSet.string("x00200032"),"undefined"==typeof t&&(t=null);return t&&(t=t.split("\\").map(Number)),t},r.parsers.dicom.prototype.instanceNumber=function(e){var t=null,i=this._dataSet.elements.x52009230;if("undefined"!=typeof i)if(i.items[e].dataSet.elements.x2005140f){var n=i.items[e].dataSet.elements.x2005140f.items[0].dataSet;t=n.intString("x00200013")}else t=this._dataSet.intString("x00200013"),"undefined"==typeof t&&(t=null);else t=this._dataSet.intString("x00200013"),"undefined"==typeof t&&(t=null);return t},r.parsers.dicom.prototype.pixelSpacing=function(e){var t=this._dataSet.string("x00280030");if("undefined"==typeof t){var i=this._dataSet.elements.x52009230;if("undefined"!=typeof i){var n=i.items[e].dataSet.elements.x00289110.items[0].dataSet;t=n.string("x00280030")}else t=null}return t&&(t=t.split("\\").map(Number)),t},r.parsers.dicom.prototype.sopInstanceUID=function(e){var t=this._dataSet.string("x00080018");return t},r.parsers.dicom.prototype.sliceThickness=function(e){var t=this._dataSet.floatString("x00180050");if("undefined"==typeof t){var i=this._dataSet.elements.x52009230;if("undefined"!=typeof i){var n=i.items[e].dataSet.elements.x00289110.items[0].dataSet;t=n.floatString("x00180050")}else t=null}return t},r.parsers.dicom.prototype.rows=function(e){var t=this._dataSet.uint16("x00280010");return"undefined"==typeof t&&(t=null),t},r.parsers.dicom.prototype.columns=function(e){var t=this._dataSet.uint16("x00280011");return"undefined"==typeof t&&(t=null),t},r.parsers.dicom.prototype.pixelRepresentation=function(e){var t=this._dataSet.uint16("x00280103");return t},r.parsers.dicom.prototype.bitsAllocated=function(e){var t=this._dataSet.uint16("x00280100");return t},r.parsers.dicom.prototype.highBit=function(e){var t=this._dataSet.uint16("x00280102");return t},r.parsers.dicom.prototype.rescaleIntercept=function(e){var t=this._dataSet.floatString("x00281052");if("undefined"==typeof t){var i=this._dataSet.elements.x52009230;if("undefined"!=typeof i){var n=i.items[e].dataSet.elements.x00289145.items[0].dataSet;t=n.floatString("x00281052")}else t=null}return t},r.parsers.dicom.prototype.rescaleSlope=function(e){var t=this._dataSet.floatString("x00281053");if("undefined"==typeof t){var i=this._dataSet.elements.x52009230;if("undefined"!=typeof i){var n=i.items[e].dataSet.elements.x00289145.items[0].dataSet;t=n.floatString("x00281052")}else t=null}return t},r.parsers.dicom.prototype.windowCenter=function(e){var t=this._dataSet.floatString("x00281050");if("undefined"==typeof t){var i=this._dataSet.elements.x52009230;if("undefined"!=typeof i){var n=i.items[e].dataSet.elements.x00289132.items[0].dataSet;t=n.floatString("x00281050")}else t=null}return t},r.parsers.dicom.prototype.windowWidth=function(e){var t=this._dataSet.floatString("x00281051");if("undefined"==typeof t){var i=this._dataSet.elements.x52009230;if("undefined"!=typeof i){var n=i.items[e].dataSet.elements.x00289132.items[0].dataSet;t=n.floatString("x00281051")}else t=null}return t},r.parsers.dicom.prototype.dimensionIndexValues=function(e){var t=[],i=this._dataSet.elements.x52009230;if("undefined"!=typeof i)for(var n=i.items[e].dataSet.elements.x00209111.items[0].dataSet,r=n.elements.x00209157,a=r.length/4,o=0;a>o;o++)t.push(n.uint32("x00209157",o));else t=null;return t},r.parsers.dicom.prototype.inStackPositionNumber=function(e){var t=null,i=this._dataSet.elements.x52009230;if("undefined"!=typeof i){var n=i.items[e].dataSet.elements.x00209111.items[0].dataSet;t=n.uint32("x00209057")}else t=null;return t},r.parsers.dicom.prototype.stackID=function(e){var t=null,i=this._dataSet.elements.x52009230;if("undefined"!=typeof i){var n=i.items[e].dataSet.elements.x00209111.items[0].dataSet;t=n.intString("x00209056")}else t=null;return t},r.parsers.dicom.prototype.dPixelData=function(e){var t=[],i=this.transferSyntaxUID();if("1.2.840.10008.1.2.4.90"===i||"1.2.840.10008.1.2.4.91"===i){var n=this._dataSet.elements.x7fe00010;new Uint8Array(this._dataSet.byteArray.buffer,n.dataOffset,n.length)}return t},r.parsers.dicom.prototype.extractPixelData=function(e){var t=null,i=this.transferSyntaxUID();if("1.2.840.10008.1.2.4.90"===i||"1.2.840.10008.1.2.4.91"===i)return t;var n=this.pixelRepresentation(e),r=this.bitsAllocated(e),a=this._dataSet.elements.x7fe00010,o=a.dataOffset,s=this.numberOfChannels(),l=this.rows(e)*this.columns(e)*s,d=0;if(1===s)0===n&&8===r?(d=o+e*l,t=new Uint8Array(this._dataSet.byteArray.buffer,d,l)):0===n&&16===r?(d=o+e*l*2,t=new Uint16Array(this._dataSet.byteArray.buffer,d,l)):1===n&&16===r&&(d=o+e*l*2,t=new Int16Array(this._dataSet.byteArray.buffer,d,l));else{d=o+e*l;var u=new Uint8Array(this._dataSet.byteArray.buffer,d,l),c=this.photometricInterpretation();if("RGB"===c)t=u;else if("YBR_FULL"===c){t=new Uint8Array(l);for(var h=l/3,m=0,f=0,p=0;h>p;p++){var y=u[m++],g=u[m++],x=u[m++];t[f++]=y+1.402*(x-128),t[f++]=y-.34414*(g-128)-.71414*(x-128),t[f++]=y+1.772*(g-128),t[f++]=255}}else window.console.log("photometric interpolation not supported: "+c)}return t},r.parsers.dicom.prototype.minMaxPixelData=function(e){for(var t=[65535,-32768],i=e.length,n=0;i>n;n++){var r=e[n];t[0]=Math.min(t[0],r),t[1]=Math.max(t[1],r)}return t},r.parsers.dicom.prototype.frameOfReferenceUID=function(e){var t=e.find('[tag="00200052"] Value').text();return""===t&&(t=1),t},t.exports=r.parsers.dicom},{"dicom-parser":14}],11:[function(e,t,i){var n=n||{};n.shaders=n.shaders||{},n.shaders.data={parameters:{uniforms:{uTextureSize:{type:"f",value:0},uTextureContainer:{type:"tv",value:null},uDataDimensions:{type:"v3",value:new THREE.Vector3},uWorldToData:{type:"m4",value:new THREE.Matrix4},uWindowLevel:{type:"fv1",value:[0,0]},uNumberOfChannels:{type:"i",value:1},uBitsAllocated:{type:"i",value:8},uInvert:{type:"i",value:0},uLut:{type:"i",value:0},uLutI:{type:"fv1",value:[0]},uLutR:{type:"fv1",value:[0]},uLutG:{type:"fv1",value:[0]},uLutB:{type:"fv1",value:[0]}}}},t.exports=n.shaders.data},{}],12:[function(e,t,i){var n=n||{};n.widgets=n.widgets||{},n.widgets.orientation=function(e,t,i){this._ParentId=e,this._TargetCamera=t,this._TargetControl=i,this._DomElement=null,this._Renderer=null,this._Scene=null,this._Camera=null,this._Axes=null,this._Style={width:200,height:200},this.createDomContainer(),this.setupObject()},n.widgets.orientation.prototype.createDomContainer=function(){this._DomElement=document.createElement("div"),this._DomElement.setAttribute("id","VJSOrientation"),this._DomElement.style.width=this._Style.width+"px",this._DomElement.style.height=this._Style.height+"px";var e=document.getElementById(this._ParentId);e.appendChild(this._DomElement)},n.widgets.orientation.prototype.setupObject=function(){this._Renderer=new THREE.WebGLRenderer({alpha:!0}),this._Renderer.setClearColor(0,0),this._Renderer.setSize(this._Style.width,this._Style.height),this._DomElement.appendChild(this._Renderer.domElement),this._Scene=new THREE.Scene,this._Camera=new THREE.PerspectiveCamera(50,this._Style.width/this._Style.height,1,1e3),this._Camera.up=this._TargetCamera.up,this._Axes=new THREE.AxisHelper(100),this._Scene.add(this._Axes)},n.widgets.orientation.prototype.update=function(){this._Camera.position.copy(this._TargetCamera.position),this._Camera.position.sub(this._TargetControl.target),this._Camera.position.setLength(300),this._Camera.lookAt(this._Scene.position),this._Renderer.render(this._Scene,this._Camera)},t.exports=n.widgets.orientation},{}],13:[function(e,t,i){var n=n||{};n.widgets=n.widgets||{},n.widgets.pixelProbe=function(e,t){THREE.Object3D.call(this),this.domElement=null,this.rasContainer=null,this.ijkContainer=null,this.valueContainer=null,this.imageMeshes=t,this.image=e,this.volumeCore=null,this.marks=[],this.createDomElement(),this._worldCoordinate=null,this._dataCoordinate=null,this._dataValue=null,this._labelValue=null},n.widgets.pixelProbe.prototype=Object.create(THREE.Object3D.prototype),n.widgets.pixelProbe.prototype.constructor=n.widgets.pixelProbe,n.widgets.pixelProbe.prototype.createDomElement=function(){this.rasContainer=document.createElement("div"),this.rasContainer.setAttribute("id","VJSProbeRAS"),this.ijkContainer=document.createElement("div"),this.ijkContainer.setAttribute("id","VJSProbeIJK"),this.valueContainer=document.createElement("div"),this.valueContainer.setAttribute("id","VJSProbeValue"),this.domElement=document.createElement("div"),this.domElement.setAttribute("id","VJSProbe"),this.domElement.appendChild(this.rasContainer),this.domElement.appendChild(this.ijkContainer),this.domElement.appendChild(this.valueContainer)},n.widgets.pixelProbe.prototype.computeValues=function(){if(this.image){var e=this.image._stack[0]._lps2IJK,t=(new THREE.Vector3).copy(this._worldCoordinate).applyMatrix4(e),i=t.clone();if(t.x=Math.floor(t.x+.5),t.y=Math.floor(t.y+.5),t.z=Math.floor(t.z+.5),this._dataCoordinate=t,t.x>=0&&t.y>=0&&t.z>=0){var n=(this.image._stack[0]._rows,this.image._stack[0]._columns);this._dataValue=this.image._stack[0]._frame[this._dataCoordinate.z]._pixelData[this._dataCoordinate.x+n*this._dataCoordinate.y]}else window.console.log("something funny happening in compute value"),window.console.log(t),window.console.log(i)}},n.widgets.pixelProbe.prototype.updateUI=function(e){var t=this._worldCoordinate.x.toFixed(2)+" : "+this._worldCoordinate.y.toFixed(2)+" : "+this._worldCoordinate.z.toFixed(2);this.rasContainer.innerHTML="LPS: "+t;var i=this._dataCoordinate.x+" : "+this._dataCoordinate.y+" : "+this._dataCoordinate.z;this.ijkContainer.innerHTML="IJK: "+i;var n=this._dataValue;this.valueContainer.innerHTML="Value: "+n,document.getElementById("VJSProbe").style.display="block",document.getElementById("VJSProbe").style.top=e.clientY+10,document.getElementById("VJSProbe").style.left=e.clientX+10},n.widgets.pixelProbe.prototype.update=function(e,t,i,n){if(this.imageMeshes){this.updateMarkDom(e,t,i,n);var r=e.intersectObjects(this.imageMeshes);for(var a in r){var o=(new THREE.Vector3).copy(r[a].point);if("ShaderMaterial"===r[a].object.material.type)return this._worldCoordinate=o,this.computeValues(),void this.updateUI(t)}this.hideUI()}},n.widgets.pixelProbe.prototype.hideUI=function(){document.getElementById("VJSProbe").style.display="none"},n.widgets.pixelProbe.prototype.mark=function(e,t){var i=e.intersectObjects(this.children),n=null;window.console.log(this),i=e.intersectObjects(this.imageMeshes);for(var r in i)if(n=(new THREE.Vector3).copy(i[r].point),"ShaderMaterial"===i[r].object.material.type){window.console.log("intersect shader material!"),this._worldCoordinate=n,this.computeValues();for(var a=0;a<this.marks.length;a++)if(this.marks[a].ijk.x===this._dataCoordinate.x&&this.marks[a].ijk.y===this._dataCoordinate.y&&this.marks[a].ijk.z===this._dataCoordinate.z)return;var o=this.image._stack[0]._ijk2LPS,s=(new THREE.Vector3).copy(this._dataCoordinate).applyMatrix4(o),l=this._dataCoordinate.clone(),d=new THREE.BoxGeometry(1,1,1);d.applyMatrix((new THREE.Matrix4).makeTranslation(this._dataCoordinate.x,this._dataCoordinate.y,this._dataCoordinate.z)),d.applyMatrix(this.image._stack[0]._ijk2LPS);var u=new THREE.MeshBasicMaterial({wireframe:!0,color:16761095}),c=new THREE.Mesh(d,u);c.name="pixelProbeMark",this.add(c);var h={id:c.id,position:s,ijk:l};this.marks.push(h),window.console.log(this.marks);var m=this.markDom(h,t);return m}},n.widgets.pixelProbe.prototype.markDom=function(e,t){var i=document.createElement("div");i.setAttribute("class","VJSProbeRAS");var n=this._worldCoordinate.x.toFixed(2)+" : "+this._worldCoordinate.y.toFixed(2)+" : "+this._worldCoordinate.z.toFixed(2);i.innerHTML="LPS: "+n;var r=document.createElement("div");r.setAttribute("class","VJSProbeIJK");var a=this._dataCoordinate.x+" : "+this._dataCoordinate.y+" : "+this._dataCoordinate.z;r.innerHTML="IJK: "+a;var o=document.createElement("div");o.setAttribute("class","VJSProbeValue");var s=this._dataValue;o.innerHTML="Value: "+s;var l=document.createElement("div");return l.setAttribute("id","mark"+e.id),l.setAttribute("class","mark"),l.appendChild(i),l.appendChild(r),l.appendChild(o),l.style.display="block",l.style.top=t.clientY+10,l.style.left=t.clientX+10,l},n.widgets.pixelProbe.prototype.updateMarkDom=function(e,t,i,n){for(var r=0;r<this.marks.length;r++){var a=this.marks[r].position.clone();a.project(i),a.x=Math.round((a.x+1)*n.offsetWidth/2),a.y=Math.round((-a.y+1)*n.offsetHeight/2),a.z=0,document.getElementById("mark"+this.marks[r].id).style.top=a.y+10,document.getElementById("mark"+this.marks[r].id).style.left=a.x+10}},t.exports=n.widgets.pixelProbe},{}],14:[function(e,t,i){!function(e,i){"undefined"!=typeof t&&t.exports?t.exports=i():"function"==typeof define&&define.amd?define([],i):(void 0===n&&(n={},"undefined"!=typeof Package&&(e.dicomParser=n)),n=i())}(this,function(){function e(e,t){function i(){c.seek(128);var e=c.readFixedString(4);if("DICM"!==e)throw"dicomParser.parseDicom: DICM prefix not found at location 132"}function r(){i();for(var e=[],t={};c.position<c.byteArray.length;){var r=c.position,a=n.readDicomElementExplicit(c,e);if(a.tag>"x0002ffff"){c.position=r;break}a.parser=n.littleEndianByteArrayParser,t[a.tag]=a}var o=new n.DataSet(c.byteArrayParser,c.byteArray,t);return o.warnings=c.warnings,o}function a(e){if(void 0===e.elements.x00020010)throw"dicomParser.parseDicom: missing required meta header attribute 0002,0010";var t=e.elements.x00020010;return n.readFixedString(c.byteArray,t.dataOffset,t.length)}function o(e){return"1.2.840.10008.1.2"===e?!1:!0}function s(t){return"1.2.840.10008.1.2.2"===t?new n.ByteStream(n.bigEndianByteArrayParser,e,c.position):new n.ByteStream(n.littleEndianByteArrayParser,e,c.position)}function l(e,t){for(var i in e.elements)e.elements.hasOwnProperty(i)&&(t.elements[i]=e.elements[i]);return void 0!==e.warnings&&(t.warnings=e.warnings.concat(t.warnings)),t}function d(e){var i=a(e),r=o(i),l=s(i),d={},u=new n.DataSet(l.byteArrayParser,l.byteArray,d);u.warnings=l.warnings;try{r?n.parseDicomDataSetExplicit(u,l,l.byteArray.length,t):n.parseDicomDataSetImplicit(u,l,l.byteArray.length,t)}catch(c){var h={exception:c,dataSet:u};throw h}return u}function u(){var e=r(),t=d(e);return l(e,t)}if(void 0===e)throw"dicomParser.parseDicom: missing required parameter 'byteArray'";var c=new n.ByteStream(n.littleEndianByteArrayParser,e);return u()}return void 0===n?{parseDicom:e}:(n.parseDicom=e,n)});var n=function(e){return void 0===e&&(e={}),e.bigEndianByteArrayParser={readUint16:function(e,t){if(0>t)throw"bigEndianByteArrayParser.readUint16: position cannot be less than 0";if(t+2>e.length)throw"bigEndianByteArrayParser.readUint16: attempt to read past end of buffer";return(e[t]<<8)+e[t+1]},readInt16:function(e,t){if(0>t)throw"bigEndianByteArrayParser.readInt16: position cannot be less than 0";if(t+2>e.length)throw"bigEndianByteArrayParser.readInt16: attempt to read past end of buffer";var i=(e[t]<<8)+e[t+1];return 32768&i&&(i=i-65535-1),i},readUint32:function(e,t){if(0>t)throw"bigEndianByteArrayParser.readUint32: position cannot be less than 0";if(t+4>e.length)throw"bigEndianByteArrayParser.readUint32: attempt to read past end of buffer";var i=256*(256*(256*e[t]+e[t+1])+e[t+2])+e[t+3];return i},readInt32:function(e,t){if(0>t)throw"bigEndianByteArrayParser.readInt32: position cannot be less than 0";if(t+4>e.length)throw"bigEndianByteArrayParser.readInt32: attempt to read past end of buffer";var i=(e[t]<<24)+(e[t+1]<<16)+(e[t+2]<<8)+e[t+3];return i},readFloat:function(e,t){if(0>t)throw"bigEndianByteArrayParser.readFloat: position cannot be less than 0";if(t+4>e.length)throw"bigEndianByteArrayParser.readFloat: attempt to read past end of buffer";var i=new Uint8Array(4);i[3]=e[t],i[2]=e[t+1],i[1]=e[t+2],i[0]=e[t+3];var n=new Float32Array(i.buffer);return n[0]},readDouble:function(e,t){if(0>t)throw"bigEndianByteArrayParser.readDouble: position cannot be less than 0";if(t+8>e.length)throw"bigEndianByteArrayParser.readDouble: attempt to read past end of buffer";var i=new Uint8Array(8);i[7]=e[t],i[6]=e[t+1],i[5]=e[t+2],i[4]=e[t+3],i[3]=e[t+4],i[2]=e[t+5],i[1]=e[t+6],i[0]=e[t+7];var n=new Float64Array(i.buffer);return n[0]}},e}(n),n=function(e){return void 0===e&&(e={}),e.readFixedString=function(e,t,i){if(0>i)throw"readFixedString - length cannot be less than 0";if(t+i>e.length)throw"dicomParser.readFixedString: attempt to read past end of buffer";for(var n="",r=0;i>r;r++){var a=e[t+r];if(0===a)return t+=i,n;n+=String.fromCharCode(a)}return n},e}(n),n=function(e){return void 0===e&&(e={}),e.ByteStream=function(e,t,i){if(void 0===e)throw"dicomParser.ByteStream: missing required parameter 'byteArrayParser'";if(void 0===t)throw"dicomParser.ByteStream: missing required parameter 'byteArray'";if(t instanceof Uint8Array==!1)throw"dicomParser.ByteStream: parameter byteArray is not of type Uint8Array";if(0>i)throw"dicomParser.ByteStream: parameter 'position' cannot be less than 0";if(i>=t.length)throw"dicomParser.ByteStream: parameter 'position' cannot be greater than or equal to 'byteArray' length";this.byteArrayParser=e,this.byteArray=t,this.position=i?i:0,this.warnings=[]},e.ByteStream.prototype.seek=function(e){if(this.position+e<0)throw"cannot seek to position < 0";this.position+=e},e.ByteStream.prototype.readByteStream=function(t){if(this.position+t>this.byteArray.length)throw"readByteStream - buffer overread";var i=new Uint8Array(this.byteArray.buffer,this.position,t);return this.position+=t,new e.ByteStream(this.byteArrayParser,i)},e.ByteStream.prototype.readUint16=function(){var e=this.byteArrayParser.readUint16(this.byteArray,this.position);return this.position+=2,e},e.ByteStream.prototype.readUint32=function(){var e=this.byteArrayParser.readUint32(this.byteArray,this.position);return this.position+=4,e},e.ByteStream.prototype.readFixedString=function(t){var i=e.readFixedString(this.byteArray,this.position,t);return this.position+=t,i},e}(n),n=function(e){function t(e,t){return void 0!==e.parser?e.parser:t}return void 0===e&&(e={}),e.DataSet=function(e,t,i){this.byteArrayParser=e,this.byteArray=t,this.elements=i},e.DataSet.prototype.uint16=function(e,i){var n=this.elements[e];return i=void 0!==i?i:0,n&&0!==n.length?t(n,this.byteArrayParser).readUint16(this.byteArray,n.dataOffset+2*i):void 0},e.DataSet.prototype.int16=function(e,i){var n=this.elements[e];return i=void 0!==i?i:0,n&&0!==n.length?t(n,this.byteArrayParser).readInt16(this.byteArray,n.dataOffset+2*i):void 0},e.DataSet.prototype.uint32=function(e,i){var n=this.elements[e];return i=void 0!==i?i:0,n&&0!==n.length?t(n,this.byteArrayParser).readUint32(this.byteArray,n.dataOffset+4*i):void 0},e.DataSet.prototype.int32=function(e,i){var n=this.elements[e];return i=void 0!==i?i:0,n&&0!==n.length?t(n,this.byteArrayParser).readInt32(this.byteArray,n.dataOffset+4*i):void 0},e.DataSet.prototype["float"]=function(e,i){var n=this.elements[e];return i=void 0!==i?i:0,n&&0!==n.length?t(n,this.byteArrayParser).readFloat(this.byteArray,n.dataOffset+4*i):void 0},e.DataSet.prototype["double"]=function(e,i){var n=this.elements[e];return i=void 0!==i?i:0,n&&0!==n.length?t(n,this.byteArrayParser).readDouble(this.byteArray,n.dataOffset+8*i):void 0},e.DataSet.prototype.numStringValues=function(t){var i=this.elements[t];if(i&&i.length>0){var n=e.readFixedString(this.byteArray,i.dataOffset,i.length),r=n.match(/\\/g);return null===r?1:r.length+1}return void 0},e.DataSet.prototype.string=function(t,i){var n=this.elements[t];if(n&&n.length>0){var r=e.readFixedString(this.byteArray,n.dataOffset,n.length);if(i>=0){var a=r.split("\\");return a[i].trim()}return r.trim()}return void 0},e.DataSet.prototype.text=function(t,i){var n=this.elements[t];if(n&&n.length>0){var r=e.readFixedString(this.byteArray,n.dataOffset,n.length);if(i>=0){var a=r.split("\\");return a[i].replace(/ +$/,"")}return r.replace(/ +$/,"")}return void 0},e.DataSet.prototype.floatString=function(e,t){var i=this.elements[e];if(i&&i.length>0){t=void 0!==t?t:0;var n=this.string(e,t);if(void 0!==n)return parseFloat(n)}return void 0},e.DataSet.prototype.intString=function(e,t){var i=this.elements[e];if(i&&i.length>0){t=void 0!==t?t:0;var n=this.string(e,t);if(void 0!==n)return parseInt(n)}return void 0},e}(n),n=function(e){return void 0===e&&(e={}),e.findEndOfEncapsulatedElement=function(t,i,n){if(void 0===t)throw"dicomParser.findEndOfEncapsulatedElement: missing required parameter 'byteStream'";if(void 0===i)throw"dicomParser.findEndOfEncapsulatedElement: missing required parameter 'element'";i.encapsulatedPixelData=!0,i.basicOffsetTable=[],i.fragments=[];var r=e.readTag(t);if("xfffee000"!==r)throw"dicomParser.findEndOfEncapsulatedElement: basic offset table not found";for(var a=t.readUint32(),o=a/4,s=0;o>s;s++){var l=t.readUint32();i.basicOffsetTable.push(l)}for(var d=t.position;t.position<t.byteArray.length;){var u=e.readTag(t),c=t.readUint32();if("xfffee0dd"===u)return t.seek(c),void(i.length=t.position-i.dataOffset);if("xfffee000"!==u)return n&&n.push("unexpected tag "+u+" while searching for end of pixel data element with undefined length"),c>t.byteArray.length-t.position&&(c=t.byteArray.length-t.position),i.fragments.push({offset:t.position-d-8,position:t.position,length:c}),t.seek(c),void(i.length=t.position-i.dataOffset);i.fragments.push({offset:t.position-d-8,position:t.position,length:c}),t.seek(c)}n&&n.push("pixel data element "+i.tag+" missing sequence delimiter tag xfffee0dd")},e}(n),n=function(e){return void 0===e&&(e={}),e.findItemDelimitationItemAndSetElementLength=function(e,t){if(void 0===e)throw"dicomParser.readDicomElementImplicit: missing required parameter 'byteStream'";for(var i=8,n=e.byteArray.length-i;e.position<=n;){var r=e.readUint16();if(65534===r){var a=e.readUint16();if(57357===a){var o=e.readUint32();return 0!==o&&e.warnings("encountered non zero length following item delimiter at position"+e.position-4+" while reading element of undefined length with tag ' + element.tag"),void(t.length=e.position-t.dataOffset)}}}t.length=e.byteArray.length-t.dataOffset,e.seek(e.byteArray.length-e.position)},e}(n),n=function(e){return void 0===e&&(e={}),e.littleEndianByteArrayParser={readUint16:function(e,t){if(0>t)throw"littleEndianByteArrayParser.readUint16: position cannot be less than 0";if(t+2>e.length)throw"littleEndianByteArrayParser.readUint16: attempt to read past end of buffer";return e[t]+256*e[t+1]},readInt16:function(e,t){if(0>t)throw"littleEndianByteArrayParser.readInt16: position cannot be less than 0";if(t+2>e.length)throw"littleEndianByteArrayParser.readInt16: attempt to read past end of buffer";var i=e[t]+(e[t+1]<<8);return 32768&i&&(i=i-65535-1),i},readUint32:function(e,t){if(0>t)throw"littleEndianByteArrayParser.readUint32: position cannot be less than 0";if(t+4>e.length)throw"littleEndianByteArrayParser.readUint32: attempt to read past end of buffer";var i=e[t]+256*e[t+1]+256*e[t+2]*256+256*e[t+3]*256*256;return i},readInt32:function(e,t){if(0>t)throw"littleEndianByteArrayParser.readInt32: position cannot be less than 0";if(t+4>e.length)throw"littleEndianByteArrayParser.readInt32: attempt to read past end of buffer";var i=e[t]+(e[t+1]<<8)+(e[t+2]<<16)+(e[t+3]<<24);return i},readFloat:function(e,t){if(0>t)throw"littleEndianByteArrayParser.readFloat: position cannot be less than 0";if(t+4>e.length)throw"littleEndianByteArrayParser.readFloat: attempt to read past end of buffer";var i=new Uint8Array(4);i[0]=e[t],i[1]=e[t+1],i[2]=e[t+2],i[3]=e[t+3];var n=new Float32Array(i.buffer);return n[0]},readDouble:function(e,t){if(0>t)throw"littleEndianByteArrayParser.readDouble: position cannot be less than 0";if(t+8>e.length)throw"littleEndianByteArrayParser.readDouble: attempt to read past end of buffer";var i=new Uint8Array(8);i[0]=e[t],i[1]=e[t+1],i[2]=e[t+2],i[3]=e[t+3],i[4]=e[t+4],i[5]=e[t+5],i[6]=e[t+6],i[7]=e[t+7];var n=new Float64Array(i.buffer);return n[0]}},e}(n),n=function(e){return void 0===e&&(e={}),e.parseDicomDataSetExplicit=function(t,i,n,r){if(n=void 0===n?i.byteArray.length:n,r=r||{},void 0===i)throw"dicomParser.parseDicomDataSetExplicit: missing required parameter 'byteStream'";if(n<i.position||n>i.byteArray.length)throw"dicomParser.parseDicomDataSetExplicit: invalid value for parameter 'maxPosition'";for(var a=t.elements;i.position<n;){var o=e.readDicomElementExplicit(i,t.warnings,r.untilTag);if(a[o.tag]=o,o.tag===r.untilTag)return}if(i.position>n)throw"dicomParser:parseDicomDataSetExplicit: buffer overrun"},e.parseDicomDataSetImplicit=function(t,i,n,r){if(n=void 0===n?t.byteArray.length:n,
r=r||{},void 0===i)throw"dicomParser.parseDicomDataSetImplicit: missing required parameter 'byteStream'";if(n<i.position||n>i.byteArray.length)throw"dicomParser.parseDicomDataSetImplicit: invalid value for parameter 'maxPosition'";for(var a=t.elements;i.position<n;){var o=e.readDicomElementImplicit(i,r.untilTag);if(a[o.tag]=o,o.tag===r.untilTag)return}},e}(n),n=function(e){function t(e){return"OB"===e||"OW"===e||"SQ"===e||"OF"===e||"UT"===e||"UN"===e?4:2}return void 0===e&&(e={}),e.readDicomElementExplicit=function(i,n,r){if(void 0===i)throw"dicomParser.readDicomElementExplicit: missing required parameter 'byteStream'";var a={tag:e.readTag(i),vr:i.readFixedString(2)},o=t(a.vr);return 2===o?(a.length=i.readUint16(),a.dataOffset=i.position):(i.seek(2),a.length=i.readUint32(),a.dataOffset=i.position),4294967295===a.length&&(a.hadUndefinedLength=!0),a.tag===r?a:"SQ"===a.vr?(e.readSequenceItemsExplicit(i,a,n),a):4294967295===a.length?"x7fe00010"===a.tag?(e.findEndOfEncapsulatedElement(i,a,n),a):(e.findItemDelimitationItemAndSetElementLength(i,a),a):(i.seek(a.length),a)},e}(n),n=function(e){return void 0===e&&(e={}),e.readDicomElementImplicit=function(t,i){if(void 0===t)throw"dicomParser.readDicomElementImplicit: missing required parameter 'byteStream'";var n={tag:e.readTag(t),length:t.readUint32(),dataOffset:t.position};if(4294967295===n.length&&(n.hadUndefinedLength=!0),n.tag===i)return n;if(t.position+4<=t.byteArray.length){var r=e.readTag(t);if(t.seek(-4),"xfffee000"===r)return e.readSequenceItemsImplicit(t,n),n}return 4294967295===n.length?(e.findItemDelimitationItemAndSetElementLength(t,n),n):(t.seek(n.length),n)},e}(n),n=function(e){function t(e,t,i){if(1===t.length)return new Uint8Array(e.byteArray.buffer,t[0].dataOffset,t[0].length);for(var n=new Uint8Array(i),r=0,a=0;a<t.length;a++)for(var o=t[a].dataOffset,s=0;s<t[a].length;s++)n[r++]=e.byteArray[o++];return n}function i(i,n){for(var r=[],a=0;i.position<n&&i.position<i.byteArray.length;){var o=e.readSequenceItem(i);if("xfffee0dd"===o.tag)break;r.push(o),i.seek(o.length),a+=o.length}var s=t(i,r,a);return s}function n(e,t,n){var r=e.basicOffsetTable.length;if(n>r)throw"dicomParser.readEncapsulatedPixelData: parameter frame exceeds number of frames in basic offset table";var a=e.basicOffsetTable[n];t.seek(a);var o=e.basicOffsetTable[n+1];void 0===o&&(o=t.position+e.length);var s=i(t,o);return s}function r(e,t,n){if(0!==n)throw"dicomParser.readEncapsulatedPixelData: non zero frame specified for single frame encapsulated pixel data";var r=t.position+e.length,a=i(t,r);return a}return void 0===e&&(e={}),e.readEncapsulatedPixelData=function(t,i,a){if(void 0===t)throw"dicomParser.readEncapsulatedPixelData: missing required parameter 'dataSet'";if(void 0===i)throw"dicomParser.readEncapsulatedPixelData: missing required parameter 'element'";if(void 0===a)throw"dicomParser.readEncapsulatedPixelData: missing required parameter 'frame'";if("x7fe00010"!==i.tag)throw"dicomParser.readEncapsulatedPixelData: parameter 'element' refers to non pixel data tag (expected tag = x7fe00010'";if(i.encapsulatedPixelData!==!0)throw"dicomParser.readEncapsulatedPixelData: parameter 'element' refers to pixel data element that does not have encapsulated pixel data";if(i.hadUndefinedLength!==!0)throw"dicomParser.readEncapsulatedPixelData: parameter 'element' refers to pixel data element that does not have encapsulated pixel data";if(void 0===i.basicOffsetTable)throw"dicomParser.readEncapsulatedPixelData: parameter 'element' refers to pixel data element that does not have encapsulated pixel data";if(void 0===i.fragments)throw"dicomParser.readEncapsulatedPixelData: parameter 'element' refers to pixel data element that does not have encapsulated pixel data";if(0>a)throw"dicomParser.readEncapsulatedPixelData: parameter 'frame' must be >= 0";var o=new e.ByteStream(t.byteArrayParser,t.byteArray,i.dataOffset),s=e.readSequenceItem(o);if("xfffee000"!==s.tag)throw"dicomParser.readEncapsulatedPixelData: missing basic offset table xfffee000";return o.seek(s.length),0!==i.basicOffsetTable.length?n(i,o,a):r(i,o,a)},e}(n),n=function(e){function t(t,i){for(var n={};t.position<t.byteArray.length;){var r=e.readDicomElementExplicit(t,i);if(n[r.tag]=r,"xfffee00d"===r.tag)return new e.DataSet(t.byteArrayParser,t.byteArray,n)}return t.warnings.push("eof encountered before finding sequence delimitation item while reading sequence item of undefined length"),new e.DataSet(t.byteArrayParser,t.byteArray,n)}function i(i,n){var r=e.readSequenceItem(i);return 4294967295===r.length?(r.hadUndefinedLength=!0,r.dataSet=t(i,n),r.length=i.position-r.dataOffset):(r.dataSet=new e.DataSet(i.byteArrayParser,i.byteArray,{}),e.parseDicomDataSetExplicit(r.dataSet,i,i.position+r.length)),r}function n(e,t,n){for(;e.position<e.byteArray.length;){var r=i(e,n);if(t.items.push(r),"xfffee0dd"===r.tag)return void(t.length=e.position-t.dataOffset)}e.warnings.push("eof encountered before finding sequence delimitation item in sequence element of undefined length with tag "+t.tag),t.length=e.byteArray.length-t.dataOffset}function r(e,t,n){for(var r=t.dataOffset+t.length;e.position<r;){var a=i(e,n);t.items.push(a)}}return void 0===e&&(e={}),e.readSequenceItemsExplicit=function(e,t,i){if(void 0===e)throw"dicomParser.readSequenceItemsExplicit: missing required parameter 'byteStream'";if(void 0===t)throw"dicomParser.readSequenceItemsExplicit: missing required parameter 'element'";t.items=[],4294967295===t.length?n(e,t):r(e,t,i)},e}(n),n=function(e){function t(t){for(var i={};t.position<t.byteArray.length;){var n=e.readDicomElementImplicit(t);if(i[n.tag]=n,"xfffee00d"===n.tag)return new e.DataSet(t.byteArrayParser,t.byteArray,i)}return t.warnings.push("eof encountered before finding sequence item delimiter in sequence item of undefined length"),new e.DataSet(t.byteArrayParser,t.byteArray,i)}function i(i){var n=e.readSequenceItem(i);return 4294967295===n.length?(n.hadUndefinedLength=!0,n.dataSet=t(i),n.length=i.position-n.dataOffset):(n.dataSet=new e.DataSet(i.byteArrayParser,i.byteArray,{}),e.parseDicomDataSetImplicit(n.dataSet,i,i.position+n.length)),n}function n(e,t){for(;e.position<e.byteArray.length;){var n=i(e);if(t.items.push(n),"xfffee0dd"===n.tag)return void(t.length=e.position-t.dataOffset)}e.warnings.push("eof encountered before finding sequence delimitation item in sequence of undefined length"),t.length=e.byteArray.length-t.dataOffset}function r(e,t){for(var n=t.dataOffset+t.length;e.position<n;){var r=i(e);t.items.push(r)}}return void 0===e&&(e={}),e.readSequenceItemsImplicit=function(e,t){if(void 0===e)throw"dicomParser.readSequenceItemsImplicit: missing required parameter 'byteStream'";if(void 0===t)throw"dicomParser.readSequenceItemsImplicit: missing required parameter 'element'";t.items=[],4294967295===t.length?n(e,t):r(e,t)},e}(n),n=function(e){return void 0===e&&(e={}),e.readSequenceItem=function(t){if(void 0===t)throw"dicomParser.readSequenceItem: missing required parameter 'byteStream'";var i={tag:e.readTag(t),length:t.readUint32(),dataOffset:t.position};return i},e}(n),n=function(e){return void 0===e&&(e={}),e.readTag=function(e){if(void 0===e)throw"dicomParser.readTag: missing required parameter 'byteStream'";var t=256*e.readUint16()*256,i=e.readUint16(),n="x"+("00000000"+(t+i).toString(16)).substr(-8);return n},e}(n),n=function(e){return void 0===e&&(e={}),e.explicitDataSetToJS=function(t,i){if(void 0===t)throw"dicomParser.explicitDataSetToJS: missing required parameter dataSet";i=i||{omitPrivateAttibutes:!0,maxElementLength:128};var n={};for(var r in t.elements){var a=t.elements[r];if(i.omitPrivateAttibutes!==!0||!e.isPrivateTag(r))if(a.items){for(var o=[],s=0;s<a.items.length;s++)o.push(e.explicitDataSetToJS(a.items[s].dataSet,i));n[r]=o}else{var l;l=void 0,a.length<i.maxElementLength&&(l=e.explicitElementToString(t,a)),n[r]=void 0!==l?l:{dataOffset:a.dataOffset,length:a.length}}}return n},e}(n),n=function(e){return void 0===e&&(e={}),e.explicitElementToString=function(t,i){function n(e,i){for(var n="",r=0;e>r;r++)0!==r&&(n+="/"),n+=i.call(t,o).toString();return n}if(void 0===t||void 0===i)throw"dicomParser.explicitElementToString: missing required parameters";if(void 0===i.vr)throw"dicomParser.explicitElementToString: cannot convert implicit element to string";var r,a=i.vr,o=i.tag;if(e.isStringVr(a)===!0)r=t.string(o);else{if("AT"==a){var s=t.uint32(o);return void 0===s?void 0:(0>s&&(s=4294967295+s+1),"x"+s.toString(16).toUpperCase())}"US"==a?r=n(i.length/2,t.uint16):"SS"===a?r=n(i.length/2,t.int16):"UL"==a?r=n(i.length/4,t.uint32):"SL"===a?r=n(i.length/4,t.int32):"FD"==a?r=n(i.length/8,t.int32):"FL"==a&&(r=n(i.length/4,t["float"]))}return r},e}(n),n=function(e){void 0===e&&(e={});var t={AE:!0,AS:!0,AT:!1,CS:!0,DA:!0,DS:!0,DT:!0,FL:!1,FD:!1,IS:!0,LO:!0,LT:!0,OB:!1,OD:!1,OF:!1,OW:!1,PN:!0,SH:!0,SL:!1,SQ:!1,SS:!1,ST:!0,TM:!0,UI:!0,UL:!1,UN:void 0,UR:!0,US:!1,UT:!0};return e.isStringVr=function(e){return t[e]},e.isPrivateTag=function(e){var t=parseInt(e[4]),i=t%2===1;return i},e.parsePN=function(e){if(void 0===e)return void 0;var t=e.split("^");return{familyName:t[0],givenName:t[1],middleName:t[2],prefix:t[3],suffix:t[4]}},e.parseDA=function(e){if(e&&8===e.length){var t=parseInt(e.substring(0,4),10),i=parseInt(e.substring(4,6),10),n=parseInt(e.substring(6,8),10);return{year:t,month:i,day:n}}return void 0},e.parseTM=function(e){if(e.length>=2){var t=parseInt(e.substring(0,2),10),i=e.length>=4?parseInt(e.substring(2,4),10):void 0,n=e.length>=6?parseInt(e.substring(4,6),10):void 0,r=e.length>=8?parseInt(e.substring(7,13),10):void 0;return{hours:t,minutes:i,seconds:n,fractionalSeconds:r}}return void 0},e}(n)},{}]},{},[1]);
//# sourceMappingURL=../../examples/loader_dicoms/loader_dicoms.js.map