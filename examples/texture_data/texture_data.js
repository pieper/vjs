"use strict";!function e(t,n,i){function r(o,s){if(!n[o]){if(!t[o]){var u="function"==typeof require&&require;if(!s&&u)return u(o,!0);if(a)return a(o,!0);var l=new Error("Cannot find module '"+o+"'");throw l.code="MODULE_NOT_FOUND",l}var d=n[o]={exports:{}};t[o][0].call(d.exports,function(e){var n=t[o][1][e];return r(n?n:e)},d,d.exports,e,t,n,i)}return n[o].exports}for(var a="function"==typeof require&&require,o=0;o<i.length;o++)r(i[o]);return r}({1:[function(e,t,n){function i(){function e(){if(m&&m.length===x.nbSpheres)for(var t=0;t<x.nbSpheres;t++)m[t].position.x>=d[1].x?h[t].x=-1:m[t].position.x<=d[0].x&&(h[t].x=1),m[t].position.y>=d[1].y?h[t].y=-1:m[t].position.y<=d[0].y&&(h[t].y=1),m[t].position.z>=d[1].z?h[t].z=-1:m[t].position.z<=d[0].z&&(h[t].z=1),m[t].position.x+=h[t].x*p[t].x,m[t].position.y+=h[t].y*p[t].y,m[t].position.z+=h[t].z*p[t].z;a.update(),o.render(u,l),s.update(),requestAnimationFrame(function(){e()})}x={nbSpheres:20};var t=document.getElementById("r3d");o=new THREE.WebGLRenderer({antialias:!0}),o.setSize(t.offsetWidth,t.offsetHeight),o.setClearColor(16777215,1);var n=o.context.getParameter(o.context.MAX_TEXTURE_SIZE);window.console.log(n),t.appendChild(o.domElement),s=new Stats,t.appendChild(s.domElement),u=new THREE.Scene,l=new THREE.PerspectiveCamera(45,t.offsetWidth/t.offsetHeight,1,1e7),l.position.x=150,l.position.y=150,l.position.z=100,l.lookAt(u.position),a=new y(l,o.domElement),e()}function r(e,t){var n=new THREE.Vector3(Math.random()<.5?-1:1,Math.random()<.5?-1:1,Math.random()<.5?-1:1),i=new THREE.Vector3(Math.random(),Math.random(),Math.random()),r=Math.floor(30*Math.random()+1),a=new THREE.SphereGeometry(r,32,32),o=new THREE.Mesh(a,t);o.position.x=d[0].x+(d[1].x-d[0].x)/2,o.position.y=d[0].y+(d[1].y-d[0].y)/2,o.position.z=d[0].z+(d[1].z-d[0].z)/2,m.push(o),h.push(n),p.push(i),u.add(o)}var a,o,s,u,l,d,c,f,m,h,p,x,y=e("../../modules/controls/OrbitControls2D"),g=e("../../modules/loaders/loaders.dicom"),v=e("../../modules/shaders/shaders.data");window.onload=function(){i();var e=["../../data/dcm/fruit.dcm"],t=new g;t.load(e,function(e){window.console.log("all parsed");var t=e._series._stack[0];window.console.log(t),t.prepare();var n=new THREE.BoxGeometry(896,896,60);n.applyMatrix((new THREE.Matrix4).makeTranslation(448,448,30)),n.applyMatrix(t._ijk2LPS);var i=new THREE.MeshBasicMaterial({wireframe:!0,color:6419187}),a=new THREE.Mesh(n,i);u.add(a);for(var o=[],s=0;s<t._nbTextures;s++){var l=new THREE.DataTexture(t._rawData[s],t._textureSize,t._textureSize,THREE.RGBFormat,THREE.UnsignedByteType,THREE.UVMapping,THREE.ClampToEdgeWrapping,THREE.ClampToEdgeWrapping,THREE.NearestFilter,THREE.NearestFilter);l.needsUpdate=!0,o.push(l)}var y=v.parameters.uniforms;y.uTextureSize.value=t._textureSize,y.uTextureContainer.value=o[0],y.uTexture1.value=o[1],y.uTexture2.value=o[2],y.uTexture3.value=o[3],y.uTexture4.value=o[4],y.uTexture5.value=o[5],y.uTexture6.value=o[6],y.uDataDimensions.value=new THREE.Vector3(t._columns,t._rows,t._numberOfFrames),y.uWorldToData.value=t._lps2IJK,y.uWindowLevel.value=t._windowLevel,y.uNumberOfChannels.value=t._numberOfChannels,y.uBitsAllocated.value=t._bitsAllocated,y.uInvert.value=t._invert;var g=new THREE.ShaderMaterial({side:THREE.DoubleSide,transparency:!0,uniforms:y,vertexShader:"#define GLSLIFY 1\nvarying vec4 vPos;\n\n//\n// main\n//\nvoid main() {\n\n  vPos = modelMatrix * vec4(position, 1.0 );\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0 );\n\n}",fragmentShader:"#define GLSLIFY 1\nuniform float uTextureSize;\nuniform float uWindowLevel[2];\nuniform sampler2D uTextureContainer;\nuniform sampler2D uTexture1;\nuniform sampler2D uTexture2;\nuniform sampler2D uTexture3;\nuniform sampler2D uTexture4;\nuniform sampler2D uTexture5;\nuniform sampler2D uTexture6;\nuniform vec3 uDataDimensions;\nuniform mat4 uWorldToData;\nuniform int uNumberOfChannels;\nuniform int uBitsAllocated;\nuniform int uInvert;\n\n// hack because can not pass arrays if too big\n// best would be to pass texture but have to deal with 16bits\nuniform int uLut;\nuniform float uLutI[16]; // 16 * 4 (intesity - r- g - b)\nuniform float uLutR[16];\nuniform float uLutG[16];\nuniform float uLutB[16];\n\nvarying vec4 vPos;\n\nvec4 sampleAs3DTexture(in vec3 textureCoordinate) {\n\n  float slicePixelSize = 1.0 / uTextureSize;\n  // Model coordinate (IJK) to data index\n  float index = textureCoordinate.x * uDataDimensions.x + textureCoordinate.y * uDataDimensions.y * uDataDimensions.x + textureCoordinate.z * uDataDimensions.z * uDataDimensions.y * uDataDimensions.x;\n\n  // Map data index to right sampler2D texture\n  float textureIndex = floor(index / (uTextureSize*uTextureSize));\n  float inTextureIndex = mod(index, uTextureSize*uTextureSize);\n\n  // Get row and column in the texture\n  float rowIndex = floor(inTextureIndex/uTextureSize);\n  float colIndex = mod(inTextureIndex, uTextureSize);\n\n  // Map row and column to uv\n  vec2 uv = vec2(0,0);\n  uv.x = slicePixelSize * 0.5 + colIndex * slicePixelSize;\n  uv.y = 1.0 - (slicePixelSize * 0.5 + rowIndex * slicePixelSize);\n\n  vec4 dataValue = vec4(0, 0, 0, 1);\n  if(textureIndex == 0.0){\n    dataValue = texture2D(uTextureContainer, uv);\n  }\n  else if(textureIndex == 1.0){\n    dataValue = texture2D(uTexture1, uv);\n  }\n  else if(textureIndex == 2.0){\n    dataValue = texture2D(uTexture2, uv);\n  }\n  else if(textureIndex == 3.0){\n    dataValue = texture2D(uTexture3, uv);\n  }\n  else if(textureIndex == 4.0){\n    dataValue = texture2D(uTexture4, uv);\n  }\n  else if(textureIndex == 5.0){\n    dataValue = texture2D(uTexture5, uv);\n  }\n  else if(textureIndex == 6.0){\n    dataValue = texture2D(uTexture6, uv);\n  }\n  // else if(textureIndex == 2.0){\n  //   dataValue = texture2D(uTextureContainer[2], uv);\n  // }\n  // else if(textureIndex == 3.0){\n  //   dataValue = texture2D(uTextureContainer[3], uv);\n  // }\n  // else if(textureIndex == 4.0){\n  //   dataValue = texture2D(uTextureContainer[4], uv);\n  // }\n  // else if(textureIndex == 5.0){\n  //   dataValue = texture2D(uTextureContainer[5], uv);\n  // }\n  // else if(textureIndex == 6.0){\n  //   dataValue = texture2D(uTextureContainer[6], uv);\n  // }\n  // else if(textureIndex == 7.0){\n  //   dataValue = texture2D(uTextureContainer[7], uv);\n  // }\n  // else if(textureIndex == 8.0){\n  //   dataValue = texture2D(uTextureContainer[8], uv);\n  // }\n  // else if(textureIndex == 9.0){\n  //   dataValue = texture2D(uTextureContainer[9], uv);\n  // }\n  // else if(textureIndex == 10.0){\n  //   dataValue = texture2D(uTextureContainer[10], uv);\n  // }\n  // else if(textureIndex == 11.0){\n  //   dataValue = texture2D(uTextureContainer[11], uv);\n  // }\n  // else if(textureIndex == 12.0){\n  //   dataValue = texture2D(uTextureContainer[12], uv);\n  // }\n  // else if(textureIndex == 13.0){\n  //   dataValue = texture2D(uTextureContainer[13], uv);\n  // }\n  // else if(textureIndex == 14.0){\n  //   dataValue = texture2D(uTextureContainer[14], uv);\n  // }\n  // else if(textureIndex == 15.0){\n  //   dataValue = texture2D(uTextureContainer[15], uv);\n  // }\n  // else {\n  //   discard;\n  // }\n\n  return dataValue;\n}\n\n\nvoid main(void) {\n\n  // get texture coordinates of current pixel\n  // might not be the right way to do it:\n  // precision issues ar voxels limits\n  // need to add machine epsilon?\n  vec4 dataCoordinateRaw = uWorldToData * vPos;\n  dataCoordinateRaw += 0.5;\n  vec3 dataCoordinate = vec3(floor(dataCoordinateRaw.x), floor(dataCoordinateRaw.y), floor(dataCoordinateRaw.z));\n\n\n  // if data in range, look it up in the texture!\n  if(dataCoordinate.x >= 0.0\n  && dataCoordinate.y >= 0.0\n  && dataCoordinate.z >= 0.0\n  && dataCoordinate.x < uDataDimensions.x\n  && dataCoordinate.y < uDataDimensions.y\n  && dataCoordinate.z < uDataDimensions.z\n  ){\n    vec3 textureCoordinate = dataCoordinate/uDataDimensions;\n    vec4 dataValue = sampleAs3DTexture(textureCoordinate);\n    //vec4(1.0, 0.5, 0.5, 1.0);//\n    \n\n    // Threshold? to copr intensities out?\n\n    if(uNumberOfChannels == 1){\n      // reconstruct 16bits data if any\n      float rawValue = dataValue.r * 255.0 * 256.0 + dataValue.g * 255.0;\n      float windowMin = uWindowLevel[0] - uWindowLevel[1]/2.0;\n      float windowMax = uWindowLevel[0] + uWindowLevel[1]/2.0;\n      float combined = ( rawValue - windowMin ) / uWindowLevel[1];\n\n      dataValue.r = dataValue.g = dataValue.b = combined;\n    }\n\n    // Apply LUT table...\n    // will pass it through a texture...\n\n    if(uLut == 1){\n    // if uApplyLUT\n    // if LUT Gradation? Interpolation\n    // get LUT from texture\n    for(int i=0; i<16; i++){\n      if(dataValue.r < uLutI[i]){\n        // i and i-1\n        float dataValuePosition = dataValue.r - uLutI[i-1];\n        float lutRange = uLutI[i] - uLutI[i-1];\n        float lutWeight = dataValuePosition/lutRange;\n        // use gradation or not??\n        // color distance\n        float colorDistanceR = uLutR[i] - uLutR[i-1];\n        float colorDistanceG = uLutG[i] - uLutG[i-1];\n        float colorDistanceB = uLutB[i] - uLutB[i-1];\n\n        // by weight\n        float colorIncrementR = lutWeight * colorDistanceR;\n        float colorIncrementG = lutWeight * colorDistanceG;\n        float colorIncrementB = lutWeight * colorDistanceB;\n\n        // add it\n        dataValue.r = uLutR[i-1] + colorIncrementR;\n        dataValue.g = uLutG[i-1] + colorIncrementG;\n        dataValue.b = uLutB[i-1] + colorIncrementB;\n        // dataValue.r += colorIncrementR;\n        // dataValue.g += colorIncrementG;\n        // dataValue.b += colorIncrementB;\n       break;\n     }\n    }\n    }\n\n    // Apply label map...?\n    // target specific intensity\n\n    if(uInvert == 1){\n      dataValue = vec4(1, 1, 1, 1) - dataValue;\n      dataValue.a = 1.0;\n    }\n\n    gl_FragColor = dataValue;\n  }\n  else{\n    // should be able to choose what we want to do if not in range:\n    // discard or specific color\n    //discard;\n    gl_FragColor = vec4(0.011, 0.662, 0.956, 1.0);\n  }\n}"});f=new THREE.Vector3(896,896,60).applyMatrix4(t._ijk2LPS),c=new THREE.Vector3(0,0,0).applyMatrix4(t._ijk2LPS),d=[new THREE.Vector3(Math.min(c.x,f.x),Math.min(c.y,f.y),Math.min(c.z,f.z)),new THREE.Vector3(Math.max(c.x,f.x),Math.max(c.y,f.y),Math.max(c.z,f.z))];var _=new THREE.Vector3(d[0].x+(d[1].x-d[0].x)/2,d[0].y+(d[1].y-d[0].y)/2,d[0].z+(d[1].z-d[0].z)/2);m=[],h=[],p=[];for(var w=0;w<x.nbSpheres;w++)r(_,g);var E=new dat.GUI({autoPlace:!1}),b=document.getElementById("my-gui-container");b.appendChild(E.domElement);var S=E.addFolder("Stack"),T=S.add(t,"_windowWidth",1,t._minMax[1]).step(1);T.onChange(function(e){y.uWindowLevel.value[1]=e});var D=S.add(t,"_windowCenter",t._minMax[0],t._minMax[1]).step(1);D.onChange(function(e){y.uWindowLevel.value[0]=e});var I=S.add(t,"_invert",0,1).step(1);I.onChange(function(e){y.uInvert.value=e}),S.open();var P=E.addFolder("Spheres"),R=P.add(x,"nbSpheres",1,100).step(1);P.open(),R.onChange(function(e){var t=e-m.length;if(t>0)for(var n=0;t>n;n++)r(_,g);else if(0>t){t=Math.abs(t);for(var i=0;t>i;i++)u.remove(m[0]),m.shift(),h.shift(),p.shift()}})},function(){},function(){})}},{"../../modules/controls/OrbitControls2D":2,"../../modules/loaders/loaders.dicom":6,"../../modules/shaders/shaders.data":11}],2:[function(e,t,n){THREE.OrbitControls2D=function(e,t){function n(){return 2*Math.PI/60/60*h.autoRotateSpeed}function i(){return Math.pow(.95,h.zoomSpeed)}function r(e){if(h.enabled!==!1){if(e.preventDefault(),e.button===h.mouseButtons.ORBIT){if(h.noRotate===!0)return;L=V.ROTATE,x.set(e.clientX,e.clientY)}else if(e.button===h.mouseButtons.ZOOM){if(h.noZoom===!0)return;L=V.DOLLY,S.set(e.clientX,e.clientY)}else if(e.button===h.mouseButtons.PAN){if(h.noPan===!0)return;L=V.PAN,v.set(e.clientX,e.clientY)}L!==V.NONE&&(document.addEventListener("mousemove",a,!1),document.addEventListener("mouseup",o,!1),h.dispatchEvent(C))}}function a(e){if(h.enabled!==!1){e.preventDefault();var t=h.domElement===document?h.domElement.body:h.domElement;if(L===V.ROTATE){if(h.noRotate===!0)return;y.set(e.clientX,e.clientY),g.subVectors(y,x),h.rotateLeft(2*Math.PI*g.x/t.clientWidth*h.rotateSpeed),h.rotateUp(2*Math.PI*g.y/t.clientHeight*h.rotateSpeed),x.copy(y)}else if(L===V.DOLLY){if(h.noZoom===!0)return;T.set(e.clientX,e.clientY),D.subVectors(T,S),D.y>0?h.dollyIn():h.dollyOut(),S.copy(T)}else if(L===V.PAN){if(h.noPan===!0)return;_.set(e.clientX,e.clientY),w.subVectors(_,v),h.pan(w.x,w.y),v.copy(_)}L!==V.NONE&&h.update()}}function o(){h.enabled!==!1&&(document.removeEventListener("mousemove",a,!1),document.removeEventListener("mouseup",o,!1),h.dispatchEvent(U),L=V.NONE)}function s(e){if(h.enabled!==!1&&h.noZoom!==!0&&L===V.NONE){e.preventDefault(),e.stopPropagation();var t=0;void 0!==e.wheelDelta?t=e.wheelDelta:void 0!==e.detail&&(t=-e.detail),t>0?h.dollyOut():h.dollyIn(),h.update(),h.dispatchEvent(C),h.dispatchEvent(U)}}function u(e){if(h.enabled!==!1&&h.noKeys!==!0&&h.noPan!==!0)switch(e.keyCode){case h.keys.UP:h.pan(0,h.keyPanSpeed),h.update();break;case h.keys.BOTTOM:h.pan(0,-h.keyPanSpeed),h.update();break;case h.keys.LEFT:h.pan(h.keyPanSpeed,0),h.update();break;case h.keys.RIGHT:h.pan(-h.keyPanSpeed,0),h.update()}}function l(e){if(h.enabled!==!1){switch(e.touches.length){case 1:if(h.noRotate===!0)return;L=V.TOUCH_ROTATE,x.set(e.touches[0].pageX,e.touches[0].pageY);break;case 2:if(h.noZoom===!0)return;L=V.TOUCH_DOLLY;var t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY,i=Math.sqrt(t*t+n*n);S.set(0,i);break;case 3:if(h.noPan===!0)return;L=V.TOUCH_PAN,v.set(e.touches[0].pageX,e.touches[0].pageY);break;default:L=V.NONE}L!==V.NONE&&h.dispatchEvent(C)}}function d(e){if(h.enabled!==!1){e.preventDefault(),e.stopPropagation();var t=h.domElement===document?h.domElement.body:h.domElement;switch(e.touches.length){case 1:if(h.noRotate===!0)return;if(L!==V.TOUCH_ROTATE)return;y.set(e.touches[0].pageX,e.touches[0].pageY),g.subVectors(y,x),h.rotateLeft(2*Math.PI*g.x/t.clientWidth*h.rotateSpeed),h.rotateUp(2*Math.PI*g.y/t.clientHeight*h.rotateSpeed),x.copy(y),h.update();break;case 2:if(h.noZoom===!0)return;if(L!==V.TOUCH_DOLLY)return;var n=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY,r=Math.sqrt(n*n+i*i);T.set(0,r),D.subVectors(T,S),D.y>0?h.dollyOut():h.dollyIn(),S.copy(T),h.update();break;case 3:if(h.noPan===!0)return;if(L!==V.TOUCH_PAN)return;_.set(e.touches[0].pageX,e.touches[0].pageY),w.subVectors(_,v),h.pan(w.x,w.y),v.copy(_),h.update();break;default:L=V.NONE}}}function c(){h.enabled!==!1&&(h.dispatchEvent(U),L=V.NONE)}this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.target=new THREE.Vector3,this.center=this.target,this.noZoom=!1,this.zoomSpeed=1,this.minDistance=0,this.maxDistance=1/0,this.noRotate=!1,this.rotateSpeed=1,this.noPan=!1,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-(1/0),this.maxAzimuthAngle=1/0,this.noKeys=!1,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={ORBIT:THREE.MOUSE.LEFT,ZOOM:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT};var f,m,h=this,p=1e-6,x=new THREE.Vector2,y=new THREE.Vector2,g=new THREE.Vector2,v=new THREE.Vector2,_=new THREE.Vector2,w=new THREE.Vector2,E=new THREE.Vector3,b=new THREE.Vector3,S=new THREE.Vector2,T=new THREE.Vector2,D=new THREE.Vector2,I=0,P=0,R=1,O=new THREE.Vector3,A=new THREE.Vector3,z=new THREE.Quaternion,V={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},L=V.NONE;this.target0=this.target.clone(),this.position0=this.object.position.clone();var H=(new THREE.Quaternion).setFromUnitVectors(e.up,new THREE.Vector3(0,1,0)),M=H.clone().inverse(),B={type:"change"},C={type:"start"},U={type:"end"};this.rotateLeft=function(e){void 0===e&&(e=n()),P-=e},this.rotateUp=function(e){void 0===e&&(e=n()),I-=e},this.panLeft=function(e){var t=this.object.matrix.elements;E.set(t[0],t[1],t[2]),E.multiplyScalar(-e),O.add(E)},this.panUp=function(e){var t=this.object.matrix.elements;E.set(t[4],t[5],t[6]),E.multiplyScalar(e),O.add(E)},this.pan=function(e,t){var n=h.domElement===document?h.domElement.body:h.domElement;if(void 0!==h.object.fov){var i=h.object.position,r=i.clone().sub(h.target),a=r.length();a*=Math.tan(h.object.fov/2*Math.PI/180),h.panLeft(2*e*a/n.clientHeight),h.panUp(2*t*a/n.clientHeight)}else void 0!==h.object.top?(h.panLeft(e*(h.object.right-h.object.left)/(n.clientWidth*this.object.zoom)),h.panUp(t*(h.object.top-h.object.bottom)/(n.clientHeight*this.object.zoom))):console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled.")},this.dollyIn=function(e){void 0===e&&(e=i()),void 0!==h.object.top?(this.object.zoom*=e,this.object.updateProjectionMatrix()):R/=e},this.dollyOut=function(e){void 0===e&&(e=i()),void 0!==h.object.top?(this.object.zoom/=e,this.object.updateProjectionMatrix()):R*=e},this.update=function(){var e=this.object.position;b.copy(e).sub(this.target),b.applyQuaternion(H),f=Math.atan2(b.x,b.z),m=Math.atan2(Math.sqrt(b.x*b.x+b.z*b.z),b.y),this.autoRotate&&L===V.NONE&&this.rotateLeft(n()),f+=P,m+=I,f=Math.max(this.minAzimuthAngle,Math.min(this.maxAzimuthAngle,f)),m=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,m)),m=Math.max(p,Math.min(Math.PI-p,m));var t=b.length()*R;t=Math.max(this.minDistance,Math.min(this.maxDistance,t)),this.target.add(O),b.x=t*Math.sin(m)*Math.sin(f),b.y=t*Math.cos(m),b.z=t*Math.sin(m)*Math.cos(f),b.applyQuaternion(M),e.copy(this.target).add(b),this.object.lookAt(this.target),P=0,I=0,R=1,O.set(0,0,0),(A.distanceToSquared(this.object.position)>p||8*(1-z.dot(this.object.quaternion))>p)&&(this.dispatchEvent(B),A.copy(this.object.position),z.copy(this.object.quaternion))},this.reset=function(){L=V.NONE,this.target.copy(this.target0),this.object.position.copy(this.position0),this.update()},this.getPolarAngle=function(){return m},this.getAzimuthalAngle=function(){return f},this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousedown",r,!1),this.domElement.addEventListener("mousewheel",s,!1),this.domElement.addEventListener("DOMMouseScroll",s,!1),this.domElement.addEventListener("touchstart",l,!1),this.domElement.addEventListener("touchend",c,!1),this.domElement.addEventListener("touchmove",d,!1),window.addEventListener("keydown",u,!1),this.update()},THREE.OrbitControls2D.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.OrbitControls2D.prototype.constructor=THREE.OrbitControls2D,t.exports=THREE.OrbitControls2D},{}],3:[function(e,t,n){var i=i||{};i.intersections=i.intersections||{},i.intersections.obbPlane=function(e,t){var n=[],i=t.direction.clone().applyMatrix4(e.toOBBSpace),r=new THREE.Vector3(0,0,0).applyMatrix4(e.toOBBSpace),a={position:t.position.clone().applyMatrix4(e.toOBBSpace),direction:new THREE.Vector3(i.x-r.x,i.y-r.y,i.z-r.z).normalize()},o=new THREE.Vector3(e.center.x-e.halfDimensions.x,e.center.y-e.halfDimensions.y,e.center.z-e.halfDimensions.z),s=new THREE.Vector3(e.center.x+e.halfDimensions.x,e.center.y+e.halfDimensions.y,e.center.z+e.halfDimensions.z),u={position:new THREE.Vector3(e.center.x-e.halfDimensions.x,e.center.y-e.halfDimensions.y,e.center.z-e.halfDimensions.z),direction:e.orientation.x},l=this.rayPlane(u,a);return l&&l.x>=o.x&&l.y>=o.y&&l.z>=o.z&&l.x<=s.x&&l.y<=s.y&&l.z<=s.z&&n.push(l.applyMatrix4(e.toOBBSpaceInvert)),u.direction=e.orientation.y,l=this.rayPlane(u,a),l&&l.x>=o.x&&l.y>=o.y&&l.z>=o.z&&l.x<=s.x&&l.y<=s.y&&l.z<=s.z&&n.push(l.applyMatrix4(e.toOBBSpaceInvert)),u.direction=e.orientation.z,l=this.rayPlane(u,a),l&&l.x>=o.x&&l.y>=o.y&&l.z>=o.z&&l.x<=s.x&&l.y<=s.y&&l.z<=s.z&&n.push(l.applyMatrix4(e.toOBBSpaceInvert)),u={position:new THREE.Vector3(e.center.x+e.halfDimensions.x,e.center.y+e.halfDimensions.y,e.center.z+e.halfDimensions.z),direction:e.orientation.x},l=this.rayPlane(u,a),l&&l.x>=o.x&&l.y>=o.y&&l.z>=o.z&&l.x<=s.x&&l.y<=s.y&&l.z<=s.z&&n.push(l.applyMatrix4(e.toOBBSpaceInvert)),u.direction=e.orientation.y,l=this.rayPlane(u,a),l&&l.x>=o.x&&l.y>=o.y&&l.z>=o.z&&l.x<=s.x&&l.y<=s.y&&l.z<=s.z&&n.push(l.applyMatrix4(e.toOBBSpaceInvert)),u.direction=e.orientation.z,l=this.rayPlane(u,a),l&&l.x>=o.x&&l.y>=o.y&&l.z>=o.z&&l.x<=s.x&&l.y<=s.y&&l.z<=s.z&&n.push(l.applyMatrix4(e.toOBBSpaceInvert)),u={position:new THREE.Vector3(e.center.x+e.halfDimensions.x,e.center.y-e.halfDimensions.y,e.center.z-e.halfDimensions.z),direction:e.orientation.y},l=this.rayPlane(u,a),l&&l.x>=o.x&&l.y>=o.y&&l.z>=o.z&&l.x<=s.x&&l.y<=s.y&&l.z<=s.z&&n.push(l.applyMatrix4(e.toOBBSpaceInvert)),u.direction=e.orientation.z,l=this.rayPlane(u,a),l&&l.x>=o.x&&l.y>=o.y&&l.z>=o.z&&l.x<=s.x&&l.y<=s.y&&l.z<=s.z&&n.push(l.applyMatrix4(e.toOBBSpaceInvert)),u={position:new THREE.Vector3(e.center.x-e.halfDimensions.x,e.center.y+e.halfDimensions.y,e.center.z-e.halfDimensions.z),direction:e.orientation.x},l=this.rayPlane(u,a),l&&l.x>=o.x&&l.y>=o.y&&l.z>=o.z&&l.x<=s.x&&l.y<=s.y&&l.z<=s.z&&n.push(l.applyMatrix4(e.toOBBSpaceInvert)),u.direction=e.orientation.z,l=this.rayPlane(u,a),l&&l.x>=o.x&&l.y>=o.y&&l.z>=o.z&&l.x<=s.x&&l.y<=s.y&&l.z<=s.z&&n.push(l.applyMatrix4(e.toOBBSpaceInvert)),u={position:new THREE.Vector3(e.center.x-e.halfDimensions.x,e.center.y-e.halfDimensions.y,e.center.z+e.halfDimensions.z),direction:e.orientation.x},l=this.rayPlane(u,a),l&&l.x>=o.x&&l.y>=o.y&&l.z>=o.z&&l.x<=s.x&&l.y<=s.y&&l.z<=s.z&&n.push(l.applyMatrix4(e.toOBBSpaceInvert)),u.direction=e.orientation.y,l=this.rayPlane(u,a),l&&l.x>=o.x&&l.y>=o.y&&l.z>=o.z&&l.x<=s.x&&l.y<=s.y&&l.z<=s.z&&n.push(l.applyMatrix4(e.toOBBSpaceInvert)),n},i.intersections.rayPlane=function(e,t){if(0!==e.direction.dot(t.direction)){var n=(t.direction.x*(t.position.x-e.position.x)+t.direction.y*(t.position.y-e.position.y)+t.direction.z*(t.position.z-e.position.z))/(t.direction.x*e.direction.x+t.direction.y*e.direction.y+t.direction.z*e.direction.z),i=new THREE.Vector3(e.position.x+n*e.direction.x,e.position.y+n*e.direction.y,e.position.z+n*e.direction.z);return i}return null},t.exports=i.intersections},{}],4:[function(e,t,n){var i=e("../core/Intersections"),r=r||{};r.geometries=r.geometries||{},r.geometries.slice=function(e,t,n,r,a){var o={halfDimensions:e,center:t,orientation:n,toOBBSpace:new THREE.Matrix4,toOBBSpaceInvert:new THREE.Matrix4},s={position:r,direction:a},u=i.obbPlane(o,s);u.length<3&&(window.console.log("WARNING: Less than 3 intersections between OBB and Plane."),window.console.log("OBB"),window.console.log(o),window.console.log("Plane"),window.console.log(s),window.console.log("exiting..."));for(var l=this.centerOfMass(u),d=this.orderIntersections(u,l,a),c=[],f=[],m=0;m<d.length;m++)c.push(d[m].point),f.push(d[m].xy);var h=new THREE.Shape;h.moveTo(f[0].x,f[0].y);for(var p=1;p<f.length;p++)h.lineTo(f[p].x,f[p].y);h.lineTo(f[0].x,f[0].y),THREE.ShapeGeometry.call(this,h),this.type="SliceGeometry",this.vertices=c,this.verticesNeedUpdate=!0},r.geometries.slice.prototype=Object.create(THREE.ShapeGeometry.prototype),r.geometries.slice.prototype.constructor=r.geometries.slice,r.geometries.slice.prototype.centerOfMass=function(e){for(var t=new THREE.Vector3(0,0,0),n=0;n<e.length;n++)t.x+=e[n].x,t.y+=e[n].y,t.z+=e[n].z;return t.divideScalar(e.length),t},r.geometries.slice.prototype.orderIntersections=function(e,t,n){for(var i=e[0].x,r=e[0].y,a=e[0].z,o=e[0].x-t.x,s=e[0].y-t.y,u=e[0].z-t.z,l={origin:new THREE.Vector3(i,r,a),direction:new THREE.Vector3(o,s,u).normalize()},d=new THREE.Vector3(0,0,0).crossVectors(l.direction,n).normalize(),c=[],f=0;f<e.length;f++){var m=e[f].x,h=e[f].y,p=e[f].z,x=e[f].x-t.x,y=e[f].y-t.y,g=e[f].z-t.z,v={origin:new THREE.Vector3(m,h,p),direction:new THREE.Vector3(x,y,g).normalize()},_=l.direction.dot(v.direction),w=d.dot(v.direction),E=Math.atan2(w,_),b=E*(180/Math.PI);c.push({angle:b,point:v.origin,xy:{x:_,y:w}})}return c.sort(function(e,t){return e.angle-t.angle}),c},t.exports=r.geometries.slice},{"../core/Intersections":3}],5:[function(e,t,n){var i=e("../geometries/geometries.slice"),r=e("../shaders/shaders.data"),a=a||{};a.helpers=a.helpers||{},a.helpers.series=function(){THREE.Object3D.call(this),this._series=null,this._uniforms=null,this._frameIndex=null,this._slice=null,this._border=null},a.helpers.series.prototype=Object.create(THREE.Object3D.prototype),a.helpers.series.prototype.constructor=a.helpers.series,a.helpers.series.prototype.merge=function(e){return this._series.merge(e._series)},a.helpers.series.prototype.addSeries=function(e){this._series=e},a.helpers.series.prototype.getStack=function(e){return e},a.helpers.series.prototype.prepare=function(){if(window.console.log("helpers Series Prepare!!!"),this._series){var e=this._series._stack[0];e.prepare(),window.console.log(e);var t=e._dimensions,n=e._halfDimensions,a=new THREE.Vector3(-.5,-.5,-.5),o=new THREE.BoxGeometry(t.x,t.y,t.z);o.applyMatrix((new THREE.Matrix4).makeTranslation(n.x+a.x,n.y+a.y,n.z+a.z)),o.applyMatrix(e._ijk2LPS);var s=new THREE.MeshBasicMaterial({wireframe:!0,color:6419187}),u=new THREE.Mesh(o,s);this.add(u);var l=new THREE.Vector3(0,0,0),d=new THREE.Vector3(new THREE.Vector3(1,0,0),new THREE.Vector3(0,1,0),new THREE.Vector3(0,0,1)),c=new THREE.Vector3(Math.floor(e._halfDimensions.x),Math.floor(e._halfDimensions.y),Math.floor(e._halfDimensions.z)+.5-e._halfDimensions.z),f=new THREE.Vector3(0,0,1),m=new i(n,l,d,c,f);m.applyMatrix((new THREE.Matrix4).makeTranslation(n.x+a.x,n.y+a.y,n.z+a.z)),m.applyMatrix(e._ijk2LPS),this._frameIndex=Math.round(n.z);for(var h=[],p=0;p<e._nbTextures;p++){var x=new THREE.DataTexture(e._rawData[p],e._textureSize,e._textureSize,THREE.RGBFormat,THREE.UnsignedByteType,THREE.UVMapping,THREE.ClampToEdgeWrapping,THREE.ClampToEdgeWrapping,THREE.NearestFilter,THREE.NearestFilter);x.needsUpdate=!0,h.push(x)}var y=new THREE.ShaderMaterial({side:THREE.DoubleSide,transparency:!0,uniforms:r.parameters.uniforms,vertexShader:"#define GLSLIFY 1\nvarying vec4 vPos;\n\n//\n// main\n//\nvoid main() {\n\n  vPos = modelMatrix * vec4(position, 1.0 );\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0 );\n\n}",fragmentShader:"#define GLSLIFY 1\nuniform float uTextureSize;\nuniform float uWindowLevel[2];\nuniform sampler2D uTextureContainer;\nuniform sampler2D uTexture1;\nuniform sampler2D uTexture2;\nuniform sampler2D uTexture3;\nuniform sampler2D uTexture4;\nuniform sampler2D uTexture5;\nuniform sampler2D uTexture6;\nuniform vec3 uDataDimensions;\nuniform mat4 uWorldToData;\nuniform int uNumberOfChannels;\nuniform int uBitsAllocated;\nuniform int uInvert;\n\n// hack because can not pass arrays if too big\n// best would be to pass texture but have to deal with 16bits\nuniform int uLut;\nuniform float uLutI[16]; // 16 * 4 (intesity - r- g - b)\nuniform float uLutR[16];\nuniform float uLutG[16];\nuniform float uLutB[16];\n\nvarying vec4 vPos;\n\nvec4 sampleAs3DTexture(in vec3 textureCoordinate) {\n\n  float slicePixelSize = 1.0 / uTextureSize;\n  // Model coordinate (IJK) to data index\n  float index = textureCoordinate.x * uDataDimensions.x + textureCoordinate.y * uDataDimensions.y * uDataDimensions.x + textureCoordinate.z * uDataDimensions.z * uDataDimensions.y * uDataDimensions.x;\n\n  // Map data index to right sampler2D texture\n  float textureIndex = floor(index / (uTextureSize*uTextureSize));\n  float inTextureIndex = mod(index, uTextureSize*uTextureSize);\n\n  // Get row and column in the texture\n  float rowIndex = floor(inTextureIndex/uTextureSize);\n  float colIndex = mod(inTextureIndex, uTextureSize);\n\n  // Map row and column to uv\n  vec2 uv = vec2(0,0);\n  uv.x = slicePixelSize * 0.5 + colIndex * slicePixelSize;\n  uv.y = 1.0 - (slicePixelSize * 0.5 + rowIndex * slicePixelSize);\n\n  vec4 dataValue = vec4(0, 0, 0, 1);\n  if(textureIndex == 0.0){\n    dataValue = texture2D(uTextureContainer, uv);\n  }\n  else if(textureIndex == 1.0){\n    dataValue = texture2D(uTexture1, uv);\n  }\n  else if(textureIndex == 2.0){\n    dataValue = texture2D(uTexture2, uv);\n  }\n  else if(textureIndex == 3.0){\n    dataValue = texture2D(uTexture3, uv);\n  }\n  else if(textureIndex == 4.0){\n    dataValue = texture2D(uTexture4, uv);\n  }\n  else if(textureIndex == 5.0){\n    dataValue = texture2D(uTexture5, uv);\n  }\n  else if(textureIndex == 6.0){\n    dataValue = texture2D(uTexture6, uv);\n  }\n  // else if(textureIndex == 2.0){\n  //   dataValue = texture2D(uTextureContainer[2], uv);\n  // }\n  // else if(textureIndex == 3.0){\n  //   dataValue = texture2D(uTextureContainer[3], uv);\n  // }\n  // else if(textureIndex == 4.0){\n  //   dataValue = texture2D(uTextureContainer[4], uv);\n  // }\n  // else if(textureIndex == 5.0){\n  //   dataValue = texture2D(uTextureContainer[5], uv);\n  // }\n  // else if(textureIndex == 6.0){\n  //   dataValue = texture2D(uTextureContainer[6], uv);\n  // }\n  // else if(textureIndex == 7.0){\n  //   dataValue = texture2D(uTextureContainer[7], uv);\n  // }\n  // else if(textureIndex == 8.0){\n  //   dataValue = texture2D(uTextureContainer[8], uv);\n  // }\n  // else if(textureIndex == 9.0){\n  //   dataValue = texture2D(uTextureContainer[9], uv);\n  // }\n  // else if(textureIndex == 10.0){\n  //   dataValue = texture2D(uTextureContainer[10], uv);\n  // }\n  // else if(textureIndex == 11.0){\n  //   dataValue = texture2D(uTextureContainer[11], uv);\n  // }\n  // else if(textureIndex == 12.0){\n  //   dataValue = texture2D(uTextureContainer[12], uv);\n  // }\n  // else if(textureIndex == 13.0){\n  //   dataValue = texture2D(uTextureContainer[13], uv);\n  // }\n  // else if(textureIndex == 14.0){\n  //   dataValue = texture2D(uTextureContainer[14], uv);\n  // }\n  // else if(textureIndex == 15.0){\n  //   dataValue = texture2D(uTextureContainer[15], uv);\n  // }\n  // else {\n  //   discard;\n  // }\n\n  return dataValue;\n}\n\n\nvoid main(void) {\n\n  // get texture coordinates of current pixel\n  // might not be the right way to do it:\n  // precision issues ar voxels limits\n  // need to add machine epsilon?\n  vec4 dataCoordinateRaw = uWorldToData * vPos;\n  dataCoordinateRaw += 0.5;\n  vec3 dataCoordinate = vec3(floor(dataCoordinateRaw.x), floor(dataCoordinateRaw.y), floor(dataCoordinateRaw.z));\n\n\n  // if data in range, look it up in the texture!\n  if(dataCoordinate.x >= 0.0\n  && dataCoordinate.y >= 0.0\n  && dataCoordinate.z >= 0.0\n  && dataCoordinate.x < uDataDimensions.x\n  && dataCoordinate.y < uDataDimensions.y\n  && dataCoordinate.z < uDataDimensions.z\n  ){\n    vec3 textureCoordinate = dataCoordinate/uDataDimensions;\n    vec4 dataValue = sampleAs3DTexture(textureCoordinate);\n    //vec4(1.0, 0.5, 0.5, 1.0);//\n    \n\n    // Threshold? to copr intensities out?\n\n    if(uNumberOfChannels == 1){\n      // reconstruct 16bits data if any\n      float rawValue = dataValue.r * 255.0 * 256.0 + dataValue.g * 255.0;\n      float windowMin = uWindowLevel[0] - uWindowLevel[1]/2.0;\n      float windowMax = uWindowLevel[0] + uWindowLevel[1]/2.0;\n      float combined = ( rawValue - windowMin ) / uWindowLevel[1];\n\n      dataValue.r = dataValue.g = dataValue.b = combined;\n    }\n\n    // Apply LUT table...\n    // will pass it through a texture...\n\n    if(uLut == 1){\n    // if uApplyLUT\n    // if LUT Gradation? Interpolation\n    // get LUT from texture\n    for(int i=0; i<16; i++){\n      if(dataValue.r < uLutI[i]){\n        // i and i-1\n        float dataValuePosition = dataValue.r - uLutI[i-1];\n        float lutRange = uLutI[i] - uLutI[i-1];\n        float lutWeight = dataValuePosition/lutRange;\n        // use gradation or not??\n        // color distance\n        float colorDistanceR = uLutR[i] - uLutR[i-1];\n        float colorDistanceG = uLutG[i] - uLutG[i-1];\n        float colorDistanceB = uLutB[i] - uLutB[i-1];\n\n        // by weight\n        float colorIncrementR = lutWeight * colorDistanceR;\n        float colorIncrementG = lutWeight * colorDistanceG;\n        float colorIncrementB = lutWeight * colorDistanceB;\n\n        // add it\n        dataValue.r = uLutR[i-1] + colorIncrementR;\n        dataValue.g = uLutG[i-1] + colorIncrementG;\n        dataValue.b = uLutB[i-1] + colorIncrementB;\n        // dataValue.r += colorIncrementR;\n        // dataValue.g += colorIncrementG;\n        // dataValue.b += colorIncrementB;\n       break;\n     }\n    }\n    }\n\n    // Apply label map...?\n    // target specific intensity\n\n    if(uInvert == 1){\n      dataValue = vec4(1, 1, 1, 1) - dataValue;\n      dataValue.a = 1.0;\n    }\n\n    gl_FragColor = dataValue;\n  }\n  else{\n    // should be able to choose what we want to do if not in range:\n    // discard or specific color\n    //discard;\n    gl_FragColor = vec4(0.011, 0.662, 0.956, 1.0);\n  }\n}"
}),g=y.clone();this._uniforms=g.uniforms,this._uniforms.uTextureSize.value=e._textureSize,this._uniforms.uTextureContainer.value=h[0],this._uniforms.uTexture1.value=h[1],this._uniforms.uTexture2.value=h[2],this._uniforms.uTexture3.value=h[3],this._uniforms.uTexture4.value=h[4],this._uniforms.uTexture5.value=h[5],this._uniforms.uTexture6.value=h[6],this._uniforms.uDataDimensions.value=e._dimensions,this._uniforms.uWorldToData.value=e._lps2IJK,this._uniforms.uWindowLevel.value=e._windowLevel,this._uniforms.uNumberOfChannels.value=e._numberOfChannels,this._uniforms.uBitsAllocated.value=e._bitsAllocated,this._uniforms.uInvert.value=e._invert,this._slice=new THREE.Mesh(m,g),this.add(this._slice);for(var v=new THREE.LineBasicMaterial({color:16711680,polygonOffset:!0,polygonOffsetFactor:-.1}),_=new THREE.Geometry,w=0;w<m.vertices.length;w++)_.vertices.push(m.vertices[w]);_.vertices.push(m.vertices[0]),this._border=new THREE.Line(_,v),this.add(this._border)}else window.console.log("no series to be prepared...")},a.helpers.series.prototype.updateSliceGeometry=function(){var e=this._series._stack[0],t=e._halfDimensions,n=new THREE.Vector3(-.5,-.5,-.5),r=new THREE.Vector3(0,0,0),a=new THREE.Vector3(new THREE.Vector3(1,0,0),new THREE.Vector3(0,1,0),new THREE.Vector3(0,0,1)),o=new THREE.Vector3(0,0,this._frameIndex+.5-e._halfDimensions.z),s=new THREE.Vector3(0,0,1),u=new i(t,r,a,o,s);u.applyMatrix((new THREE.Matrix4).makeTranslation(t.x+n.x,t.y+n.y,t.z+n.z)),u.applyMatrix(e._ijk2LPS),this._slice.geometry=u,this._slice.geometry.verticesNeedUpdate=!0},a.helpers.series.prototype.updateBorderGeometry=function(){for(var e=new THREE.Geometry,t=0;t<this._slice.geometry.vertices.length;t++)e.vertices.push(this._slice.geometry.vertices[t]);e.vertices.push(this._slice.geometry.vertices[0]),this._border.geometry.vertices=e.vertices,this._border.geometry.verticesNeedUpdate=!0},t.exports=a.helpers.series},{"../geometries/geometries.slice":4,"../shaders/shaders.data":11}],6:[function(e,t,n){var i=i||{};i.parsers=i.parsers||{},i.parsers.dicom=i.parsers.dicom||e("../parsers/parsers.dicom"),i.models=i.models||{},i.models.series=i.models.series||e("../models/models.series"),i.models.stack=i.models.stack||e("../models/models.stack"),i.models.frame=i.models.frame||e("../models/models.frame"),i.helpers=i.helpers||{},i.helpers.series=i.helpers.series||e("../helpers/helpers.series"),i.loaders=i.loaders||{},i.loaders.dicom=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager,this.crossOrigin=!0,this.responseType="arraybuffer",this._imageHelper=null,this._image=null},i.loaders.dicom.prototype.constructor=i.loaders.dicom,i.loaders.dicom.prototype.load=function(e,t,n,i){var r=this,a=new THREE.XHRLoader(r.manager);a.setCrossOrigin(this.crossOrigin),a.setResponseType(this.responseType),a.load(e,function(e){t(r.parse(e))},n,i)},i.loaders.dicom.prototype.parse=function(e){window.console.log(e),window.console.log("file downloaded yay!");var t=new i.helpers.series,n=new i.parsers.dicom(e,t.id),r=new i.models.series;r._seriesInstanceUID=n.seriesInstanceUID(),r._numberOfFrames=n.numberOfFrames(),r._numberOfFrames||(r._numberOfFrames=1),r._numberOfChannels=n.numberOfChannels();var a=new i.models.stack;a._numberOfChannels=n.numberOfChannels(),r._stack.push(a);for(var o=0;o<r._numberOfFrames;o++){var s=new i.models.frame;s._rows=n.rows(o),s._columns=n.columns(o),s._pixelData=n.extractPixelData(o),s._pixelSpacing=n.pixelSpacing(o),s._sliceThickness=n.sliceThickness(o),s._imageOrientation=n.imageOrientation(o),s._imagePosition=n.imagePosition(o),s._dimensionIndexValues=n.dimensionIndexValues(o),s._bitsAllocated=n.bitsAllocated(o),s._instanceNumber=n.instanceNumber(o),s._minMax=n.minMaxPixelData(s._pixelData),a._frame.push(s)}return t.addSeries(r),t},t.exports=i.loaders.dicom},{"../helpers/helpers.series":5,"../models/models.frame":7,"../models/models.series":8,"../models/models.stack":9,"../parsers/parsers.dicom":10}],7:[function(e,t,n){var i=i||{};i.models=i.models||{},i.models.frame=function(){this._id="-1",this._stackID=-1,this._rows=0,this._columns=0,this._dimensionIndexValues=[],this._imagePositionPatient={x:0,y:0,z:0},this._imageOrientationPatient={row:{x:0,y:0,z:0},column:{x:0,y:0,z:0}},this._sliceThickness=1,this._pixelSpacing={row:1,column:1},this._spacingBetweenSlices=null,this._pixelData=null,this._instanceNumber=null,this._minMax=null},i.models.frame.prototype.constructor=i.models.frame,t.exports=i.models.frame},{}],8:[function(e,t,n){var i=i||{};i.models=i.models||{},i.models.series=function(){this._id=-1,this._concatenationUID=-1,this._seriesInstanceUID=-1,this._seriesNumber=-1,this._dimensionIndexSequence=[],this._rows=0,this._columns=0,this._photometricInterpretation="",this._numberOfFrames=0,this._numberOfChannels=1,this._instanceNumber=0,this._stack=[]},i.models.series.prototype.merge=function(e){var t=!1;if(this._seriesInstanceUID===e._seriesInstanceUID){window.console.log("stacks belong to same series!"),t=!0;for(var n=e._stack,i=0;i<n.length;i++)for(var r=0;r<this._stack.length;r++){if(window.console.log(this._stack[r],n[i]),this._stack[r].merge(n[i])){window.console.log("stacks merged successfully!");break}r===this._stack.length-1&&(window.console.log("stacks added to the list!"),this._stack.push(n[i]))}}return t},t.exports=i.models.series},{}],9:[function(e,t,n){var i=i||{};i.models=i.models||{},i.models.stack=function(){this._id="-1",this._uid=null,this._stackID=-1,this._frame=[],this._rows=0,this._columns=0,this._numberOfFrames=0,this._pixelSpacing={row:0,column:0},this._spacingBetweenSlices=0,this._sliceThickness=0,this._origin=null,this._halfDimensions=null,this._orientation=null,this._textureSize=4096,this._nbTextures=7,this._rawData=[],this._windowLevel=[0,0],this._windowCenter=0,this._windowWidth=0,this._minMax=[65535,-32768],this._invert=0,this._ijk2LPS=null,this._lps2IJK=null,this._dimensions=null,this._spacing=null,this._origin=null,this._direction=null},i.models.stack.prototype.prepare=function(){this._numberOfFrames=this._frame.length,window.console.log(this),this.orderFrames();var e=this.zSpacing();this._frame[0]._pixelSpacing?(this._pixelSpacing.row=this._frame[0]._pixelSpacing[0],this._pixelSpacing.column=this._frame[0]._pixelSpacing[1]):this._frame[0]._pixelAspectRatio?(this._pixelSpacing.row=1,this._pixelSpacing.column=1*this._frame[0]._pixelAspectRatio[1]/this._frame[0]._pixelAspectRatio[0]):(this._pixelSpacing.row=1,this._pixelSpacing.column=1),this._frame[0]._imagePosition||(this._frame[0]._imagePosition=[0,0,0]),this._frame[0]._imageOrientation||(this._frame[0]._imageOrientation=[1,0,0,0,1,0]),this._rows=this._frame[0]._rows,this._columns=this._frame[0]._columns,this._dimensions=new THREE.Vector3(this._columns,this._rows,this._numberOfFrames),this._spacingBetweenSlices=this._frame[0]._spacingBetweenSlices,this._sliceThickness=this._frame[0]._sliceThickness;for(var t=0;t<this._frame.length;t++)this._rows!==this._frame[t]._rows&&(window.console.log("Numbers of rows in stack's frames is not consistent."),window.console.log(this),window.console.log("First frame had: ",this._rows," rows"),window.console.log("Frame index: ",t," has: ",this._frame[t]._rows," rows.")),this._columns!==this._frame[t]._columns&&(window.console.log("Numbers of columns in stack's frames is not consistent."),window.console.log(this),window.console.log("First frame had: ",this._columns," columns."),window.console.log("Frame index: ",t," has: ",this.frame[t]._columns," columns.")),this._minMax[0]=Math.min(this._minMax[0],this._frame[t]._minMax[0]),this._minMax[1]=Math.max(this._minMax[1],this._frame[t]._minMax[1]);this._origin=new THREE.Vector3(this._frame[0]._imagePosition[0],this._frame[0]._imagePosition[1],this._frame[0]._imagePosition[2]),window.console.log("first frame value!"),window.console.log(this._frame[0]._imageOrientation[0]);var n=new THREE.Vector3(this._frame[0]._imageOrientation[0],this._frame[0]._imageOrientation[1],this._frame[0]._imageOrientation[2]);window.console.log(n);var i=new THREE.Vector3(this._frame[0]._imageOrientation[3],this._frame[0]._imageOrientation[4],this._frame[0]._imageOrientation[5]),r=new THREE.Vector3(0,0,0).crossVectors(n,i).normalize();this._direction=new THREE.Matrix4,this._direction.set(n.x,i.x,r.x,0,n.y,i.y,r.y,0,n.z,i.z,r.z,0,0,0,0,1),window.console.log(this._direction),this._spacing=new THREE.Vector3(this._pixelSpacing.row,this._pixelSpacing.column,e),window.console.log(this._spacing),this._halfDimensions=new THREE.Vector3(this._dimensions.x/2,this._dimensions.y/2,this._dimensions.z/2);var a=new THREE.Vector3(1,0,0),o=new THREE.Vector3(0,1,0),s=new THREE.Vector3(0,0,1);this._orientation=new THREE.Vector3(a,o,s),this._ijk2LPS=new THREE.Matrix4,this._ijk2LPS.set(n.x*this._spacing.x,i.x*this._spacing.y,r.x*this._spacing.z,this._origin.x,n.y*this._spacing.x,i.y*this._spacing.y,r.y*this._spacing.z,this._origin.y,n.z*this._spacing.x,i.z*this._spacing.y,r.z*this._spacing.z,this._origin.z,0,0,0,1),this._lps2IJK=new THREE.Matrix4,this._lps2IJK.getInverse(this._ijk2LPS),window.console.log(this._lps2IJK,this._ijk2LPS,this._direction);var u=this._dimensions.x*this._dimensions.y*this._dimensions.z;window.console.log(this._dimensions);for(var l=0;l<this._nbTextures;l++)this._rawData.push(new Uint8Array(this._textureSize*this._textureSize*3));var d=this._dimensions.x*this._dimensions.y,c=this._textureSize*this._textureSize;console.time("arrangeDataForWebgl");for(var f=0;u>f;f++){var m=Math.floor(f/d),h=f%d,p=Math.floor(f/c),x=f%c;if(3===this._numberOfChannels)this._rawData[p][3*x]=this._frame[m]._pixelData[3*h],this._rawData[p][3*x+1]=this._frame[m]._pixelData[3*h+1],this._rawData[p][3*x+2]=this._frame[m]._pixelData[3*h+2];else{var y=this._frame[m]._pixelData[h],g=255&y,v=y>>8&255;this._rawData[p][3*x]=v,this._rawData[p][3*x+1]=g,this._rawData[p][3*x+2]=m}}var _=this._minMax[1]-this._minMax[0],w=this._minMax[0]+_/2;this._windowWidth=_,this._windowCenter=w,this._windowLevel=[w,_],this._bitsAllocated=this._frame[0]._bitsAllocated,window.console.log("window level: ",this._windowLevel)},i.models.stack.prototype.orderFrameOnDimensionIndices=function(e,t){if("_dimensionIndexValues"in e&&"[object Array]"===Object.prototype.toString.call(e._dimensionIndexValues)&&"_dimensionIndexValues"in t&&"[object Array]"===Object.prototype.toString.call(t._dimensionIndexValues))for(var n=0;n<e._dimensionIndexValues.length;n++){if(parseInt(e._dimensionIndexValues[n])>parseInt(t._dimensionIndexValues[n]))return 1;if(parseInt(e._dimensionIndexValues[n])<parseInt(t._dimensionIndexValues[n]))return-1}else window.console.log("One of the frames doesn't have a _dimensionIndexValues array."),window.console.log(e),window.console.log(t);return 0},i.models.stack.prototype.orderFrames=function(){if(window.console.log(this),this._frame[0]._dimensionIndexValues)this._frame.sort(i.models.stack.prototype.orderFrameOnDimensionIndices);else if(this._frame[0]._imagePosition&&this._frame[0]._imageOrientation){var e=function(e,t){return t._dist=t._imagePosition[0]*e.x+t._imagePosition[1]*e.y+t._imagePosition[2]*e.z,t},t=new THREE.Vector3(this._frame[0]._imageOrientation[0],this._frame[0]._imageOrientation[1],this._frame[0]._imageOrientation[2]),n=new THREE.Vector3(this._frame[0]._imageOrientation[3],this._frame[0]._imageOrientation[4],this._frame[0]._imageOrientation[5]),r=new THREE.Vector3(0,0,0).crossVectors(t,n).normalize();this._frame.map(e.bind(null,r)),window.console.log(this._frame),this._frame.sort(function(e,t){return e._dist-t._dist}),window.console.log(this._frame)}},i.models.stack.prototype.zSpacing=function(){var e=1;if(window.console.log(this._frame[0]),this._numberOfFrames>1)if(this._spacingBetweenSlices)e=this._spacingBetweenSlices;else if(this._frame[0]._sliceThickness)e=this._frame[0]._sliceThickness;else{var t=function(e,t){return t._dist=t._imagePosition[0]*e.x+t._imagePosition[1]*e.y+t._imagePosition[2]*e.z,t},n=new THREE.Vector3(this._frame[0]._imageOrientation[0],this._frame[0]._imageOrientation[1],this._frame[0]._imageOrientation[2]),i=new THREE.Vector3(this._frame[0]._imageOrientation[3],this._frame[0]._imageOrientation[4],this._frame[0]._imageOrientation[5]),r=new THREE.Vector3(0,0,0).crossVectors(n,i).normalize();this._frame.map(t.bind(null,r)),window.console.log(this._frame),this._frame.sort(function(e,t){return e._dist-t._dist}),e=this._frame[1]._dist-this._frame[0]._dist}return 0===e&&(e=1),e},i.models.stack.prototype.merge=function(e){var t=!1;if(this._stackID===e._stackID){t=!0;for(var n=e._frame,i=0;i<n.length;i++)for(var r=0;r<this._frame.length;r++){if(this._frame[r]._dimensionIndexValues&&n[i]._dimensionIndexValues&&this._frame[r]._dimensionIndexValues.join()===n[i]._dimensionIndexValues.join()||this._frame[r]._instanceNumber&&n[i]._instanceNumber&&this._frame[r]._instanceNumber===n[i]._instanceNumber||this._frame[r]._imagePosition&&n[i]._imagePosition&&this._frame[r]._imagePosition.join()===n[i]._imagePosition.join()&&this._frame[r]._imageOrientation&&n[i]._imageOrientation&&this._frame[r]._imageOrientation.join()===n[i]._imageOrientation.join()){window.console.log("BREAKING!"),window.console.log(n[i],this._frame[r]);break}if(r===this._frame.length-1){window.console.log("PUSHING FRAME TO STACK!"),this._frame.push(n[i]);break}}}return window.console.log(this),t},t.exports=i.models.stack},{}],10:[function(e,t,n){var i=e("dicom-parser"),r=r||{};r.parsers=r.parsers||{},r.parsers.dicom=function(e,t){this._id=t,this._arrayBuffer=e;var n=new Uint8Array(e);this._dataSet=i.parseDicom(n)},r.parsers.dicom.prototype.seriesInstanceUID=function(){return this._dataSet.string("x0020000e")},r.parsers.dicom.prototype.modality=function(){return this._dataSet.string("x00080060")},r.parsers.dicom.prototype.sopInstanceUID=function(){return this._dataSet.string("x00200018")},r.parsers.dicom.prototype.transferSyntaxUID=function(){return this._dataSet.string("x00020010")},r.parsers.dicom.prototype.photometricInterpretation=function(){return this._dataSet.string("x00280004")},r.parsers.dicom.prototype.planarConfiguration=function(){var e=this._dataSet.uint16("x00280006");return"undefined"==typeof e&&(e=null),e},r.parsers.dicom.prototype.samplesPerPixel=function(){return this._dataSet.uint16("x00280002")},r.parsers.dicom.prototype.numberOfFrames=function(){var e=this._dataSet.intString("x00280008");return"undefined"==typeof e&&(e=null),e},r.parsers.dicom.prototype.numberOfChannels=function(){var e=1,t=this.photometricInterpretation();return("RGB"===t||"PALETTE COLOR"===t||"YBR_FULL"===t||"YBR_FULL_422"===t||"YBR_PARTIAL_422"===t||"YBR_PARTIAL_420"===t||"YBR_RCT"===t)&&(e=3),e},r.parsers.dicom.prototype.imageOrientation=function(e){var t=this._dataSet.string("x00200037");if("undefined"==typeof t){var n=this._dataSet.elements.x52009230;if("undefined"!=typeof n){var i=n.items[e].dataSet.elements.x00209116.items[0].dataSet;t=i.string("x00200037")}else t=null}return t&&(t=t.split("\\").map(Number)),t},r.parsers.dicom.prototype.pixelAspectRatio=function(){var e=[this._dataSet.intString("x00280034",0),this._dataSet.intString("x00280034",1)];return"undefined"==typeof e[0]&&(e=null),e},r.parsers.dicom.prototype.imagePosition=function(e){var t=null,n=this._dataSet.elements.x52009230;if("undefined"!=typeof n){var i=n.items[e].dataSet.elements.x00209113.items[0].dataSet;t=i.string("x00200032")}else t=this._dataSet.string("x00200032"),"undefined"==typeof t&&(t=null);return t&&(t=t.split("\\").map(Number)),t},r.parsers.dicom.prototype.instanceNumber=function(e){var t=null,n=this._dataSet.elements.x52009230;if("undefined"!=typeof n)if(n.items[e].dataSet.elements.x2005140f){var i=n.items[e].dataSet.elements.x2005140f.items[0].dataSet;t=i.intString("x00200013")}else t=this._dataSet.intString("x00200013"),"undefined"==typeof t&&(t=null);else t=this._dataSet.intString("x00200013"),"undefined"==typeof t&&(t=null);return t},r.parsers.dicom.prototype.pixelSpacing=function(e){var t=this._dataSet.string("x00280030");if("undefined"==typeof t){var n=this._dataSet.elements.x52009230;if("undefined"!=typeof n){var i=n.items[e].dataSet.elements.x00289110.items[0].dataSet;t=i.string("x00280030")}else t=null}return t&&(t=t.split("\\").map(Number)),t},r.parsers.dicom.prototype.sopInstanceUID=function(e){var t=this._dataSet.string("x00080018");return t},r.parsers.dicom.prototype.sliceThickness=function(e){var t=this._dataSet.floatString("x00180050");if("undefined"==typeof t){var n=this._dataSet.elements.x52009230;if("undefined"!=typeof n){var i=n.items[e].dataSet.elements.x00289110.items[0].dataSet;t=i.floatString("x00180050")}else t=null}return t},r.parsers.dicom.prototype.rows=function(e){var t=this._dataSet.uint16("x00280010");return"undefined"==typeof t&&(t=null),t},r.parsers.dicom.prototype.columns=function(e){var t=this._dataSet.uint16("x00280011");return"undefined"==typeof t&&(t=null),t},r.parsers.dicom.prototype.pixelRepresentation=function(e){var t=this._dataSet.uint16("x00280103");return t},r.parsers.dicom.prototype.bitsAllocated=function(e){var t=this._dataSet.uint16("x00280100");return t},r.parsers.dicom.prototype.highBit=function(e){var t=this._dataSet.uint16("x00280102");return t},r.parsers.dicom.prototype.rescaleIntercept=function(e){var t=this._dataSet.floatString("x00281052");if("undefined"==typeof t){var n=this._dataSet.elements.x52009230;if("undefined"!=typeof n){var i=n.items[e].dataSet.elements.x00289145.items[0].dataSet;t=i.floatString("x00281052")}else t=null}return t},r.parsers.dicom.prototype.rescaleSlope=function(e){var t=this._dataSet.floatString("x00281053");if("undefined"==typeof t){var n=this._dataSet.elements.x52009230;if("undefined"!=typeof n){var i=n.items[e].dataSet.elements.x00289145.items[0].dataSet;t=i.floatString("x00281052")}else t=null}return t},r.parsers.dicom.prototype.windowCenter=function(e){var t=this._dataSet.floatString("x00281050");if("undefined"==typeof t){var n=this._dataSet.elements.x52009230;if("undefined"!=typeof n){var i=n.items[e].dataSet.elements.x00289132.items[0].dataSet;t=i.floatString("x00281050")}else t=null}return t},r.parsers.dicom.prototype.windowWidth=function(e){var t=this._dataSet.floatString("x00281051");if("undefined"==typeof t){var n=this._dataSet.elements.x52009230;if("undefined"!=typeof n){var i=n.items[e].dataSet.elements.x00289132.items[0].dataSet;t=i.floatString("x00281051")}else t=null}return t},r.parsers.dicom.prototype.dimensionIndexValues=function(e){var t=[],n=this._dataSet.elements.x52009230;if("undefined"!=typeof n)for(var i=n.items[e].dataSet.elements.x00209111.items[0].dataSet,r=i.elements.x00209157,a=r.length/4,o=0;a>o;o++)t.push(i.uint32("x00209157",o));else t=null;return t},r.parsers.dicom.prototype.inStackPositionNumber=function(e){var t=null,n=this._dataSet.elements.x52009230;if("undefined"!=typeof n){var i=n.items[e].dataSet.elements.x00209111.items[0].dataSet;t=i.uint32("x00209057")}else t=null;return t},r.parsers.dicom.prototype.stackID=function(e){var t=null,n=this._dataSet.elements.x52009230;if("undefined"!=typeof n){var i=n.items[e].dataSet.elements.x00209111.items[0].dataSet;t=i.intString("x00209056")}else t=null;return t},r.parsers.dicom.prototype.dPixelData=function(e){var t=[],n=this.transferSyntaxUID();if("1.2.840.10008.1.2.4.90"===n||"1.2.840.10008.1.2.4.91"===n){var i=this._dataSet.elements.x7fe00010;new Uint8Array(this._dataSet.byteArray.buffer,i.dataOffset,i.length)}return t},r.parsers.dicom.prototype.extractPixelData=function(e){var t=null,n=this.transferSyntaxUID();if("1.2.840.10008.1.2.4.90"===n||"1.2.840.10008.1.2.4.91"===n)return t;var i=this.pixelRepresentation(e),r=this.bitsAllocated(e),a=this._dataSet.elements.x7fe00010,o=a.dataOffset,s=this.numberOfChannels(),u=this.rows(e)*this.columns(e)*s,l=0;if(1===s)0===i&&8===r?(l=o+e*u,t=new Uint8Array(this._dataSet.byteArray.buffer,l,u)):0===i&&16===r?(l=o+e*u*2,t=new Uint16Array(this._dataSet.byteArray.buffer,l,u)):1===i&&16===r&&(l=o+e*u*2,t=new Int16Array(this._dataSet.byteArray.buffer,l,u));else{l=o+e*u;var d=new Uint8Array(this._dataSet.byteArray.buffer,l,u),c=this.photometricInterpretation();if("RGB"===c)t=d;else if("YBR_FULL"===c){t=new Uint8Array(u);for(var f=u/3,m=0,h=0,p=0;f>p;p++){var x=d[m++],y=d[m++],g=d[m++];t[h++]=x+1.402*(g-128),t[h++]=x-.34414*(y-128)-.71414*(g-128),t[h++]=x+1.772*(y-128),t[h++]=255}}else window.console.log("photometric interpolation not supported: "+c)}return t},r.parsers.dicom.prototype.minMaxPixelData=function(e){for(var t=[65535,-32768],n=e.length,i=0;n>i;i++){var r=e[i];t[0]=Math.min(t[0],r),t[1]=Math.max(t[1],r)}return t},r.parsers.dicom.prototype.frameOfReferenceUID=function(e){var t=e.find('[tag="00200052"] Value').text();return""===t&&(t=1),t},t.exports=r.parsers.dicom},{"dicom-parser":12}],11:[function(e,t,n){var i=i||{};i.shaders=i.shaders||{},i.shaders.data={parameters:{uniforms:{uTextureSize:{type:"f",value:0},uTextureContainer:{type:"t",value:null},uTexture1:{type:"t",value:null},uTexture2:{type:"t",value:null},uTexture3:{type:"t",value:null},uTexture4:{type:"t",value:null},uTexture5:{type:"t",value:null},uTexture6:{type:"t",value:null},uDataDimensions:{type:"v3",value:new THREE.Vector3},uWorldToData:{type:"m4",value:new THREE.Matrix4},uWindowLevel:{type:"fv1",value:[0,0]},uNumberOfChannels:{type:"i",value:1},uBitsAllocated:{type:"i",value:8},uInvert:{type:"i",value:0},uLut:{type:"i",value:0},uLutI:{type:"fv1",value:[0]},uLutR:{type:"fv1",value:[0]},uLutG:{type:"fv1",value:[0]},uLutB:{type:"fv1",value:[0]}}}},t.exports=i.shaders.data},{}],12:[function(e,t,n){!function(e,n){"undefined"!=typeof t&&t.exports?t.exports=n():"function"==typeof define&&define.amd?define([],n):(void 0===i&&(i={},"undefined"!=typeof Package&&(e.dicomParser=i)),i=n())}(this,function(){function e(e,t){function n(){c.seek(128);var e=c.readFixedString(4);if("DICM"!==e)throw"dicomParser.parseDicom: DICM prefix not found at location 132"}function r(){n();for(var e=[],t={};c.position<c.byteArray.length;){var r=c.position,a=i.readDicomElementExplicit(c,e);if(a.tag>"x0002ffff"){c.position=r;break}a.parser=i.littleEndianByteArrayParser,t[a.tag]=a}var o=new i.DataSet(c.byteArrayParser,c.byteArray,t);return o.warnings=c.warnings,o}function a(e){if(void 0===e.elements.x00020010)throw"dicomParser.parseDicom: missing required meta header attribute 0002,0010";var t=e.elements.x00020010;return i.readFixedString(c.byteArray,t.dataOffset,t.length)}function o(e){return"1.2.840.10008.1.2"===e?!1:!0}function s(t){return"1.2.840.10008.1.2.2"===t?new i.ByteStream(i.bigEndianByteArrayParser,e,c.position):new i.ByteStream(i.littleEndianByteArrayParser,e,c.position)}function u(e,t){for(var n in e.elements)e.elements.hasOwnProperty(n)&&(t.elements[n]=e.elements[n]);return void 0!==e.warnings&&(t.warnings=e.warnings.concat(t.warnings)),t}function l(e){var n=a(e),r=o(n),u=s(n),l={},d=new i.DataSet(u.byteArrayParser,u.byteArray,l);d.warnings=u.warnings;try{r?i.parseDicomDataSetExplicit(d,u,u.byteArray.length,t):i.parseDicomDataSetImplicit(d,u,u.byteArray.length,t)}catch(c){var f={exception:c,dataSet:d};throw f}return d}function d(){var e=r(),t=l(e);return u(e,t)}if(void 0===e)throw"dicomParser.parseDicom: missing required parameter 'byteArray'";var c=new i.ByteStream(i.littleEndianByteArrayParser,e);return d()}return void 0===i?{parseDicom:e}:(i.parseDicom=e,i)});var i=function(e){return void 0===e&&(e={}),e.bigEndianByteArrayParser={readUint16:function(e,t){if(0>t)throw"bigEndianByteArrayParser.readUint16: position cannot be less than 0";if(t+2>e.length)throw"bigEndianByteArrayParser.readUint16: attempt to read past end of buffer";return(e[t]<<8)+e[t+1]},readInt16:function(e,t){if(0>t)throw"bigEndianByteArrayParser.readInt16: position cannot be less than 0";if(t+2>e.length)throw"bigEndianByteArrayParser.readInt16: attempt to read past end of buffer";var n=(e[t]<<8)+e[t+1];return 32768&n&&(n=n-65535-1),n},readUint32:function(e,t){if(0>t)throw"bigEndianByteArrayParser.readUint32: position cannot be less than 0";if(t+4>e.length)throw"bigEndianByteArrayParser.readUint32: attempt to read past end of buffer";var n=256*(256*(256*e[t]+e[t+1])+e[t+2])+e[t+3];return n},readInt32:function(e,t){if(0>t)throw"bigEndianByteArrayParser.readInt32: position cannot be less than 0";if(t+4>e.length)throw"bigEndianByteArrayParser.readInt32: attempt to read past end of buffer";var n=(e[t]<<24)+(e[t+1]<<16)+(e[t+2]<<8)+e[t+3];return n},readFloat:function(e,t){if(0>t)throw"bigEndianByteArrayParser.readFloat: position cannot be less than 0";if(t+4>e.length)throw"bigEndianByteArrayParser.readFloat: attempt to read past end of buffer";var n=new Uint8Array(4);n[3]=e[t],n[2]=e[t+1],n[1]=e[t+2],n[0]=e[t+3];var i=new Float32Array(n.buffer);return i[0]},readDouble:function(e,t){if(0>t)throw"bigEndianByteArrayParser.readDouble: position cannot be less than 0";if(t+8>e.length)throw"bigEndianByteArrayParser.readDouble: attempt to read past end of buffer";var n=new Uint8Array(8);n[7]=e[t],n[6]=e[t+1],n[5]=e[t+2],n[4]=e[t+3],n[3]=e[t+4],n[2]=e[t+5],n[1]=e[t+6],n[0]=e[t+7];var i=new Float64Array(n.buffer);return i[0]}},e}(i),i=function(e){return void 0===e&&(e={}),e.readFixedString=function(e,t,n){if(0>n)throw"readFixedString - length cannot be less than 0";if(t+n>e.length)throw"dicomParser.readFixedString: attempt to read past end of buffer";for(var i="",r=0;n>r;r++){var a=e[t+r];if(0===a)return t+=n,i;i+=String.fromCharCode(a)}return i},e}(i),i=function(e){return void 0===e&&(e={}),e.ByteStream=function(e,t,n){if(void 0===e)throw"dicomParser.ByteStream: missing required parameter 'byteArrayParser'";if(void 0===t)throw"dicomParser.ByteStream: missing required parameter 'byteArray'";if(t instanceof Uint8Array==!1)throw"dicomParser.ByteStream: parameter byteArray is not of type Uint8Array";if(0>n)throw"dicomParser.ByteStream: parameter 'position' cannot be less than 0";if(n>=t.length)throw"dicomParser.ByteStream: parameter 'position' cannot be greater than or equal to 'byteArray' length";this.byteArrayParser=e,this.byteArray=t,this.position=n?n:0,this.warnings=[]},e.ByteStream.prototype.seek=function(e){if(this.position+e<0)throw"cannot seek to position < 0";this.position+=e},e.ByteStream.prototype.readByteStream=function(t){if(this.position+t>this.byteArray.length)throw"readByteStream - buffer overread";var n=new Uint8Array(this.byteArray.buffer,this.position,t);return this.position+=t,new e.ByteStream(this.byteArrayParser,n)},e.ByteStream.prototype.readUint16=function(){var e=this.byteArrayParser.readUint16(this.byteArray,this.position);return this.position+=2,e},e.ByteStream.prototype.readUint32=function(){var e=this.byteArrayParser.readUint32(this.byteArray,this.position);return this.position+=4,e},e.ByteStream.prototype.readFixedString=function(t){var n=e.readFixedString(this.byteArray,this.position,t);return this.position+=t,n},e}(i),i=function(e){function t(e,t){return void 0!==e.parser?e.parser:t}return void 0===e&&(e={}),e.DataSet=function(e,t,n){this.byteArrayParser=e,this.byteArray=t,this.elements=n},e.DataSet.prototype.uint16=function(e,n){var i=this.elements[e];return n=void 0!==n?n:0,i&&0!==i.length?t(i,this.byteArrayParser).readUint16(this.byteArray,i.dataOffset+2*n):void 0},e.DataSet.prototype.int16=function(e,n){var i=this.elements[e];return n=void 0!==n?n:0,i&&0!==i.length?t(i,this.byteArrayParser).readInt16(this.byteArray,i.dataOffset+2*n):void 0},e.DataSet.prototype.uint32=function(e,n){var i=this.elements[e];return n=void 0!==n?n:0,i&&0!==i.length?t(i,this.byteArrayParser).readUint32(this.byteArray,i.dataOffset+4*n):void 0},e.DataSet.prototype.int32=function(e,n){var i=this.elements[e];return n=void 0!==n?n:0,i&&0!==i.length?t(i,this.byteArrayParser).readInt32(this.byteArray,i.dataOffset+4*n):void 0},e.DataSet.prototype["float"]=function(e,n){var i=this.elements[e];return n=void 0!==n?n:0,i&&0!==i.length?t(i,this.byteArrayParser).readFloat(this.byteArray,i.dataOffset+4*n):void 0},e.DataSet.prototype["double"]=function(e,n){var i=this.elements[e];return n=void 0!==n?n:0,i&&0!==i.length?t(i,this.byteArrayParser).readDouble(this.byteArray,i.dataOffset+8*n):void 0},e.DataSet.prototype.numStringValues=function(t){var n=this.elements[t];if(n&&n.length>0){var i=e.readFixedString(this.byteArray,n.dataOffset,n.length),r=i.match(/\\/g);return null===r?1:r.length+1}return void 0},e.DataSet.prototype.string=function(t,n){var i=this.elements[t];if(i&&i.length>0){var r=e.readFixedString(this.byteArray,i.dataOffset,i.length);if(n>=0){var a=r.split("\\");return a[n].trim()}return r.trim()}return void 0},e.DataSet.prototype.text=function(t,n){var i=this.elements[t];if(i&&i.length>0){var r=e.readFixedString(this.byteArray,i.dataOffset,i.length);if(n>=0){var a=r.split("\\");return a[n].replace(/ +$/,"")}return r.replace(/ +$/,"")}return void 0},e.DataSet.prototype.floatString=function(e,t){var n=this.elements[e];if(n&&n.length>0){t=void 0!==t?t:0;var i=this.string(e,t);if(void 0!==i)return parseFloat(i)}return void 0},e.DataSet.prototype.intString=function(e,t){var n=this.elements[e];if(n&&n.length>0){t=void 0!==t?t:0;var i=this.string(e,t);if(void 0!==i)return parseInt(i)}return void 0},e}(i),i=function(e){return void 0===e&&(e={}),e.findEndOfEncapsulatedElement=function(t,n,i){if(void 0===t)throw"dicomParser.findEndOfEncapsulatedElement: missing required parameter 'byteStream'";if(void 0===n)throw"dicomParser.findEndOfEncapsulatedElement: missing required parameter 'element'";n.encapsulatedPixelData=!0,n.basicOffsetTable=[],n.fragments=[];var r=e.readTag(t);if("xfffee000"!==r)throw"dicomParser.findEndOfEncapsulatedElement: basic offset table not found";for(var a=t.readUint32(),o=a/4,s=0;o>s;s++){var u=t.readUint32();n.basicOffsetTable.push(u)}for(var l=t.position;t.position<t.byteArray.length;){var d=e.readTag(t),c=t.readUint32();if("xfffee0dd"===d)return t.seek(c),void(n.length=t.position-n.dataOffset);if("xfffee000"!==d)return i&&i.push("unexpected tag "+d+" while searching for end of pixel data element with undefined length"),c>t.byteArray.length-t.position&&(c=t.byteArray.length-t.position),n.fragments.push({offset:t.position-l-8,position:t.position,length:c}),t.seek(c),void(n.length=t.position-n.dataOffset);n.fragments.push({offset:t.position-l-8,position:t.position,length:c}),t.seek(c)}i&&i.push("pixel data element "+n.tag+" missing sequence delimiter tag xfffee0dd")},e}(i),i=function(e){return void 0===e&&(e={}),e.findItemDelimitationItemAndSetElementLength=function(e,t){if(void 0===e)throw"dicomParser.readDicomElementImplicit: missing required parameter 'byteStream'";for(var n=8,i=e.byteArray.length-n;e.position<=i;){var r=e.readUint16();if(65534===r){var a=e.readUint16();if(57357===a){var o=e.readUint32();return 0!==o&&e.warnings("encountered non zero length following item delimiter at position"+e.position-4+" while reading element of undefined length with tag ' + element.tag"),void(t.length=e.position-t.dataOffset)}}}t.length=e.byteArray.length-t.dataOffset,e.seek(e.byteArray.length-e.position)},e}(i),i=function(e){return void 0===e&&(e={}),e.littleEndianByteArrayParser={readUint16:function(e,t){if(0>t)throw"littleEndianByteArrayParser.readUint16: position cannot be less than 0";if(t+2>e.length)throw"littleEndianByteArrayParser.readUint16: attempt to read past end of buffer";return e[t]+256*e[t+1]},readInt16:function(e,t){if(0>t)throw"littleEndianByteArrayParser.readInt16: position cannot be less than 0";if(t+2>e.length)throw"littleEndianByteArrayParser.readInt16: attempt to read past end of buffer";var n=e[t]+(e[t+1]<<8);return 32768&n&&(n=n-65535-1),n},readUint32:function(e,t){if(0>t)throw"littleEndianByteArrayParser.readUint32: position cannot be less than 0";if(t+4>e.length)throw"littleEndianByteArrayParser.readUint32: attempt to read past end of buffer";var n=e[t]+256*e[t+1]+256*e[t+2]*256+256*e[t+3]*256*256;return n},readInt32:function(e,t){if(0>t)throw"littleEndianByteArrayParser.readInt32: position cannot be less than 0";if(t+4>e.length)throw"littleEndianByteArrayParser.readInt32: attempt to read past end of buffer";

var n=e[t]+(e[t+1]<<8)+(e[t+2]<<16)+(e[t+3]<<24);return n},readFloat:function(e,t){if(0>t)throw"littleEndianByteArrayParser.readFloat: position cannot be less than 0";if(t+4>e.length)throw"littleEndianByteArrayParser.readFloat: attempt to read past end of buffer";var n=new Uint8Array(4);n[0]=e[t],n[1]=e[t+1],n[2]=e[t+2],n[3]=e[t+3];var i=new Float32Array(n.buffer);return i[0]},readDouble:function(e,t){if(0>t)throw"littleEndianByteArrayParser.readDouble: position cannot be less than 0";if(t+8>e.length)throw"littleEndianByteArrayParser.readDouble: attempt to read past end of buffer";var n=new Uint8Array(8);n[0]=e[t],n[1]=e[t+1],n[2]=e[t+2],n[3]=e[t+3],n[4]=e[t+4],n[5]=e[t+5],n[6]=e[t+6],n[7]=e[t+7];var i=new Float64Array(n.buffer);return i[0]}},e}(i),i=function(e){return void 0===e&&(e={}),e.parseDicomDataSetExplicit=function(t,n,i,r){if(i=void 0===i?n.byteArray.length:i,r=r||{},void 0===n)throw"dicomParser.parseDicomDataSetExplicit: missing required parameter 'byteStream'";if(i<n.position||i>n.byteArray.length)throw"dicomParser.parseDicomDataSetExplicit: invalid value for parameter 'maxPosition'";for(var a=t.elements;n.position<i;){var o=e.readDicomElementExplicit(n,t.warnings,r.untilTag);if(a[o.tag]=o,o.tag===r.untilTag)return}if(n.position>i)throw"dicomParser:parseDicomDataSetExplicit: buffer overrun"},e.parseDicomDataSetImplicit=function(t,n,i,r){if(i=void 0===i?t.byteArray.length:i,r=r||{},void 0===n)throw"dicomParser.parseDicomDataSetImplicit: missing required parameter 'byteStream'";if(i<n.position||i>n.byteArray.length)throw"dicomParser.parseDicomDataSetImplicit: invalid value for parameter 'maxPosition'";for(var a=t.elements;n.position<i;){var o=e.readDicomElementImplicit(n,r.untilTag);if(a[o.tag]=o,o.tag===r.untilTag)return}},e}(i),i=function(e){function t(e){return"OB"===e||"OW"===e||"SQ"===e||"OF"===e||"UT"===e||"UN"===e?4:2}return void 0===e&&(e={}),e.readDicomElementExplicit=function(n,i,r){if(void 0===n)throw"dicomParser.readDicomElementExplicit: missing required parameter 'byteStream'";var a={tag:e.readTag(n),vr:n.readFixedString(2)},o=t(a.vr);return 2===o?(a.length=n.readUint16(),a.dataOffset=n.position):(n.seek(2),a.length=n.readUint32(),a.dataOffset=n.position),4294967295===a.length&&(a.hadUndefinedLength=!0),a.tag===r?a:"SQ"===a.vr?(e.readSequenceItemsExplicit(n,a,i),a):4294967295===a.length?"x7fe00010"===a.tag?(e.findEndOfEncapsulatedElement(n,a,i),a):(e.findItemDelimitationItemAndSetElementLength(n,a),a):(n.seek(a.length),a)},e}(i),i=function(e){return void 0===e&&(e={}),e.readDicomElementImplicit=function(t,n){if(void 0===t)throw"dicomParser.readDicomElementImplicit: missing required parameter 'byteStream'";var i={tag:e.readTag(t),length:t.readUint32(),dataOffset:t.position};if(4294967295===i.length&&(i.hadUndefinedLength=!0),i.tag===n)return i;if(t.position+4<=t.byteArray.length){var r=e.readTag(t);if(t.seek(-4),"xfffee000"===r)return e.readSequenceItemsImplicit(t,i),i}return 4294967295===i.length?(e.findItemDelimitationItemAndSetElementLength(t,i),i):(t.seek(i.length),i)},e}(i),i=function(e){function t(e,t,n){if(1===t.length)return new Uint8Array(e.byteArray.buffer,t[0].dataOffset,t[0].length);for(var i=new Uint8Array(n),r=0,a=0;a<t.length;a++)for(var o=t[a].dataOffset,s=0;s<t[a].length;s++)i[r++]=e.byteArray[o++];return i}function n(n,i){for(var r=[],a=0;n.position<i&&n.position<n.byteArray.length;){var o=e.readSequenceItem(n);if("xfffee0dd"===o.tag)break;r.push(o),n.seek(o.length),a+=o.length}var s=t(n,r,a);return s}function i(e,t,i){var r=e.basicOffsetTable.length;if(i>r)throw"dicomParser.readEncapsulatedPixelData: parameter frame exceeds number of frames in basic offset table";var a=e.basicOffsetTable[i];t.seek(a);var o=e.basicOffsetTable[i+1];void 0===o&&(o=t.position+e.length);var s=n(t,o);return s}function r(e,t,i){if(0!==i)throw"dicomParser.readEncapsulatedPixelData: non zero frame specified for single frame encapsulated pixel data";var r=t.position+e.length,a=n(t,r);return a}return void 0===e&&(e={}),e.readEncapsulatedPixelData=function(t,n,a){if(void 0===t)throw"dicomParser.readEncapsulatedPixelData: missing required parameter 'dataSet'";if(void 0===n)throw"dicomParser.readEncapsulatedPixelData: missing required parameter 'element'";if(void 0===a)throw"dicomParser.readEncapsulatedPixelData: missing required parameter 'frame'";if("x7fe00010"!==n.tag)throw"dicomParser.readEncapsulatedPixelData: parameter 'element' refers to non pixel data tag (expected tag = x7fe00010'";if(n.encapsulatedPixelData!==!0)throw"dicomParser.readEncapsulatedPixelData: parameter 'element' refers to pixel data element that does not have encapsulated pixel data";if(n.hadUndefinedLength!==!0)throw"dicomParser.readEncapsulatedPixelData: parameter 'element' refers to pixel data element that does not have encapsulated pixel data";if(void 0===n.basicOffsetTable)throw"dicomParser.readEncapsulatedPixelData: parameter 'element' refers to pixel data element that does not have encapsulated pixel data";if(void 0===n.fragments)throw"dicomParser.readEncapsulatedPixelData: parameter 'element' refers to pixel data element that does not have encapsulated pixel data";if(0>a)throw"dicomParser.readEncapsulatedPixelData: parameter 'frame' must be >= 0";var o=new e.ByteStream(t.byteArrayParser,t.byteArray,n.dataOffset),s=e.readSequenceItem(o);if("xfffee000"!==s.tag)throw"dicomParser.readEncapsulatedPixelData: missing basic offset table xfffee000";return o.seek(s.length),0!==n.basicOffsetTable.length?i(n,o,a):r(n,o,a)},e}(i),i=function(e){function t(t,n){for(var i={};t.position<t.byteArray.length;){var r=e.readDicomElementExplicit(t,n);if(i[r.tag]=r,"xfffee00d"===r.tag)return new e.DataSet(t.byteArrayParser,t.byteArray,i)}return t.warnings.push("eof encountered before finding sequence delimitation item while reading sequence item of undefined length"),new e.DataSet(t.byteArrayParser,t.byteArray,i)}function n(n,i){var r=e.readSequenceItem(n);return 4294967295===r.length?(r.hadUndefinedLength=!0,r.dataSet=t(n,i),r.length=n.position-r.dataOffset):(r.dataSet=new e.DataSet(n.byteArrayParser,n.byteArray,{}),e.parseDicomDataSetExplicit(r.dataSet,n,n.position+r.length)),r}function i(e,t,i){for(;e.position<e.byteArray.length;){var r=n(e,i);if(t.items.push(r),"xfffee0dd"===r.tag)return void(t.length=e.position-t.dataOffset)}e.warnings.push("eof encountered before finding sequence delimitation item in sequence element of undefined length with tag "+t.tag),t.length=e.byteArray.length-t.dataOffset}function r(e,t,i){for(var r=t.dataOffset+t.length;e.position<r;){var a=n(e,i);t.items.push(a)}}return void 0===e&&(e={}),e.readSequenceItemsExplicit=function(e,t,n){if(void 0===e)throw"dicomParser.readSequenceItemsExplicit: missing required parameter 'byteStream'";if(void 0===t)throw"dicomParser.readSequenceItemsExplicit: missing required parameter 'element'";t.items=[],4294967295===t.length?i(e,t):r(e,t,n)},e}(i),i=function(e){function t(t){for(var n={};t.position<t.byteArray.length;){var i=e.readDicomElementImplicit(t);if(n[i.tag]=i,"xfffee00d"===i.tag)return new e.DataSet(t.byteArrayParser,t.byteArray,n)}return t.warnings.push("eof encountered before finding sequence item delimiter in sequence item of undefined length"),new e.DataSet(t.byteArrayParser,t.byteArray,n)}function n(n){var i=e.readSequenceItem(n);return 4294967295===i.length?(i.hadUndefinedLength=!0,i.dataSet=t(n),i.length=n.position-i.dataOffset):(i.dataSet=new e.DataSet(n.byteArrayParser,n.byteArray,{}),e.parseDicomDataSetImplicit(i.dataSet,n,n.position+i.length)),i}function i(e,t){for(;e.position<e.byteArray.length;){var i=n(e);if(t.items.push(i),"xfffee0dd"===i.tag)return void(t.length=e.position-t.dataOffset)}e.warnings.push("eof encountered before finding sequence delimitation item in sequence of undefined length"),t.length=e.byteArray.length-t.dataOffset}function r(e,t){for(var i=t.dataOffset+t.length;e.position<i;){var r=n(e);t.items.push(r)}}return void 0===e&&(e={}),e.readSequenceItemsImplicit=function(e,t){if(void 0===e)throw"dicomParser.readSequenceItemsImplicit: missing required parameter 'byteStream'";if(void 0===t)throw"dicomParser.readSequenceItemsImplicit: missing required parameter 'element'";t.items=[],4294967295===t.length?i(e,t):r(e,t)},e}(i),i=function(e){return void 0===e&&(e={}),e.readSequenceItem=function(t){if(void 0===t)throw"dicomParser.readSequenceItem: missing required parameter 'byteStream'";var n={tag:e.readTag(t),length:t.readUint32(),dataOffset:t.position};return n},e}(i),i=function(e){return void 0===e&&(e={}),e.readTag=function(e){if(void 0===e)throw"dicomParser.readTag: missing required parameter 'byteStream'";var t=256*e.readUint16()*256,n=e.readUint16(),i="x"+("00000000"+(t+n).toString(16)).substr(-8);return i},e}(i),i=function(e){return void 0===e&&(e={}),e.explicitDataSetToJS=function(t,n){if(void 0===t)throw"dicomParser.explicitDataSetToJS: missing required parameter dataSet";n=n||{omitPrivateAttibutes:!0,maxElementLength:128};var i={};for(var r in t.elements){var a=t.elements[r];if(n.omitPrivateAttibutes!==!0||!e.isPrivateTag(r))if(a.items){for(var o=[],s=0;s<a.items.length;s++)o.push(e.explicitDataSetToJS(a.items[s].dataSet,n));i[r]=o}else{var u;u=void 0,a.length<n.maxElementLength&&(u=e.explicitElementToString(t,a)),i[r]=void 0!==u?u:{dataOffset:a.dataOffset,length:a.length}}}return i},e}(i),i=function(e){return void 0===e&&(e={}),e.explicitElementToString=function(t,n){function i(e,n){for(var i="",r=0;e>r;r++)0!==r&&(i+="/"),i+=n.call(t,o).toString();return i}if(void 0===t||void 0===n)throw"dicomParser.explicitElementToString: missing required parameters";if(void 0===n.vr)throw"dicomParser.explicitElementToString: cannot convert implicit element to string";var r,a=n.vr,o=n.tag;if(e.isStringVr(a)===!0)r=t.string(o);else{if("AT"==a){var s=t.uint32(o);return void 0===s?void 0:(0>s&&(s=4294967295+s+1),"x"+s.toString(16).toUpperCase())}"US"==a?r=i(n.length/2,t.uint16):"SS"===a?r=i(n.length/2,t.int16):"UL"==a?r=i(n.length/4,t.uint32):"SL"===a?r=i(n.length/4,t.int32):"FD"==a?r=i(n.length/8,t.int32):"FL"==a&&(r=i(n.length/4,t["float"]))}return r},e}(i),i=function(e){void 0===e&&(e={});var t={AE:!0,AS:!0,AT:!1,CS:!0,DA:!0,DS:!0,DT:!0,FL:!1,FD:!1,IS:!0,LO:!0,LT:!0,OB:!1,OD:!1,OF:!1,OW:!1,PN:!0,SH:!0,SL:!1,SQ:!1,SS:!1,ST:!0,TM:!0,UI:!0,UL:!1,UN:void 0,UR:!0,US:!1,UT:!0};return e.isStringVr=function(e){return t[e]},e.isPrivateTag=function(e){var t=parseInt(e[4]),n=t%2===1;return n},e.parsePN=function(e){if(void 0===e)return void 0;var t=e.split("^");return{familyName:t[0],givenName:t[1],middleName:t[2],prefix:t[3],suffix:t[4]}},e.parseDA=function(e){if(e&&8===e.length){var t=parseInt(e.substring(0,4),10),n=parseInt(e.substring(4,6),10),i=parseInt(e.substring(6,8),10);return{year:t,month:n,day:i}}return void 0},e.parseTM=function(e){if(e.length>=2){var t=parseInt(e.substring(0,2),10),n=e.length>=4?parseInt(e.substring(2,4),10):void 0,i=e.length>=6?parseInt(e.substring(4,6),10):void 0,r=e.length>=8?parseInt(e.substring(7,13),10):void 0;return{hours:t,minutes:n,seconds:i,fractionalSeconds:r}}return void 0},e}(i)},{}]},{},[1]);
//# sourceMappingURL=../../examples/texture_data/texture_data.js.map